<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Solar Explorer v2.1 - ìš°ì£¼ íƒí—˜ ì‹œë®¬ë ˆì´í„°</title>
    
    <!-- PWA ì„¤ì • -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a1628">
    <meta name="description" content="3D íƒœì–‘ê³„ íƒí—˜ ì‹œë®¬ë ˆì´ì…˜ ê²Œì„. ìš°ì£¼ì„ ì„ ì¡°ì¢…í•˜ê³  í–‰ì„±ì„ íƒí—˜í•˜ì„¸ìš”!">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Solar Explorer">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-192x192.png">
    
    <!-- Open Graph / ì†Œì…œ ë¯¸ë””ì–´ ê³µìœ  -->
    <meta property="og:title" content="Solar Explorer - ìš°ì£¼ íƒí—˜ ì‹œë®¬ë ˆì´í„°">
    <meta property="og:description" content="3D íƒœì–‘ê³„ íƒí—˜ ì‹œë®¬ë ˆì´ì…˜ ê²Œì„">
    <meta property="og:type" content="website">
    <meta property="og:image" content="icons/icon-512x512.png">
    
    <!-- MS íƒ€ì¼ -->
    <meta name="msapplication-TileColor" content="#0a1628">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    
    <link rel="stylesheet" href="css/main.css">
    <!-- Supabase SDK (ë¡œì»¬ íŒŒì¼) -->
    <script src="supabase.min.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>
<script>console.log('===== ë²„ì „ 2.2 ë¡œë“œë¨ =====');</script>
<!-- â˜…â˜…â˜… ì‹œë„¤ë§ˆí‹± ì¸íŠ¸ë¡œ â˜…â˜…â˜… -->
<div id="intro-overlay">
    <canvas id="intro-canvas"></canvas>
    
    <!-- ë ˆí„°ë°•ìŠ¤ (ì‹œë„¤ë§ˆí‹± ë°”) -->
    <div class="letterbox letterbox-top"></div>
    <div class="letterbox letterbox-bottom"></div>
    
    <!-- ë Œì¦ˆ í”Œë ˆì–´ -->
    <div id="lens-flare"></div>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div id="intro-content">
        <!-- íšŒì‚¬ ë¡œê³  (Anthropic ìŠ¤íƒ€ì¼) -->
        <div id="studio-logo">
            <div class="studio-icon">â—†</div>
            <div class="studio-text">SINNARU STUDIO</div>
        </div>
        
        <!-- ë©”ì¸ íƒ€ì´í‹€ -->
        <div id="main-title">
            <div class="title-line"></div>
            <div class="title-text">
                <span class="char">S</span><span class="char">T</span><span class="char">A</span><span class="char">R</span>
                <span class="char dot">Â·</span>
                <span class="char">S</span><span class="char">T</span><span class="char">R</span><span class="char">I</span><span class="char">D</span><span class="char">E</span><span class="char">R</span>
            </div>
            <div class="title-line"></div>
            <div class="title-tagline">EXPLORE THE UNIVERSE</div>
        </div>
        
        <!-- ì›í˜• ë¡œë”© -->
        <div id="intro-loader">
            <svg class="loader-ring" viewBox="0 0 100 100">
                <circle class="loader-bg" cx="50" cy="50" r="45"/>
                <circle class="loader-progress" cx="50" cy="50" r="45"/>
            </svg>
            <div class="loader-percent"><span id="intro-percent">0</span>%</div>
        </div>
        
        <!-- ì‹œì‘ ë²„íŠ¼ -->
        <div id="intro-start">
            <button id="intro-start-btn">
                <span class="btn-border"></span>
                <span class="btn-text">PRESS TO LAUNCH</span>
            </button>
        </div>
    </div>
    
    <!-- ìŠ¤í‚µ -->
    <div id="intro-skip">SKIP <span class="skip-arrow">Â»</span></div>
    
    <!-- í•˜ë‹¨ í…ìŠ¤íŠ¸ -->
    <div id="intro-bottom-text">Â© 2025 SINNARU STUDIO. ALL RIGHTS RESERVED.</div>
</div>

<!-- â˜…â˜…â˜… STARÂ·WALKER ë©”ì¸ ë©”ë‰´ â˜…â˜…â˜… -->
<div id="mode-select-overlay" style="display:none;">

<!-- â˜…â˜…â˜… ê³ ì • í—¤ë” ë²„íŠ¼ (ëª¨ë“  í™”ë©´ì—ì„œ í‘œì‹œ) â˜…â˜…â˜… -->
<div id="global-header-btns">
    <button id="global-profile-btn" class="global-header-btn" title="Profile">
        <span class="btn-icon">ğŸ‘¤</span>
    </button>
    <button id="global-settings-btn" class="global-header-btn" title="Settings">
        <span class="btn-icon">âš™ï¸</span>
    </button>
</div>

<!-- â˜…â˜…â˜… ê°€ë¡œëª¨ë“œ íšŒì „ ì•ˆë‚´ â˜…â˜…â˜… -->
<div id="rotate-screen-overlay">
    <div class="rotate-content">
        <div class="rotate-icon">ğŸ“±</div>
        <div class="rotate-arrow">â†»</div>
        <div class="rotate-text">Please rotate your device</div>
        <div class="rotate-subtext">ê°€ë¡œ ëª¨ë“œë¡œ ì „í™˜í•´ì£¼ì„¸ìš”</div>
    </div>
</div>
    <!-- ë°°ê²½ íš¨ê³¼ -->
    <div class="voyager-bg-stars"></div>
    <div class="voyager-bg-nebula"></div>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="voyager-main-content">
        <!-- ë¡œê³  -->
        <div class="voyager-logo">
            <div class="voyager-logo-icon">âœ¦</div>
            <div class="voyager-logo-text">STAR<span class="logo-dot">Â·</span>WALKER</div>
            <div class="voyager-logo-tagline">SPACE EXPLORATION SIMULATOR</div>
        </div>
        
        <!-- ë©”ë‰´ ë²„íŠ¼ë“¤ -->
        <div class="voyager-menu">
            <button id="btn-single" class="voyager-btn primary">
                <div class="btn-icon">ğŸŒŒ</div>
                <div class="btn-content">
                    <div class="btn-title" data-i18n="singlePlay">Single Play</div>
                    <div class="btn-desc" data-i18n="singleDesc">Free space exploration â€¢ Create celestial bodies â€¢ Unlimited</div>
                </div>
                <div class="btn-arrow">â€º</div>
            </button>
            
            <button id="btn-multi" class="voyager-btn secondary">
                <div class="btn-icon">ğŸŒ</div>
                <div class="btn-content">
                    <div class="btn-title" data-i18n="multiPlay">Multiplayer</div>
                    <div class="btn-desc" data-i18n="multiDesc">Real-time chat â€¢ Co-op exploration â€¢ Competition</div>
                </div>
                <div class="btn-arrow">â€º</div>
            </button>
            
            <button id="btn-login-main" class="voyager-btn tertiary">
                <div class="btn-icon">ğŸ”‘</div>
                <div class="btn-content">
                    <div class="btn-title" data-i18n="loginBtn">Login</div>
                    <div class="btn-desc" data-i18n="loginDesc">Account sync â€¢ Save progress â€¢ Rankings</div>
                </div>
                <div class="btn-arrow">â€º</div>
            </button>
            
            <div class="voyager-btn-row" style="justify-content: center;">
                <button id="btn-settings" class="voyager-btn-small">
                    <div class="btn-icon">âš™ï¸</div>
                    <div class="btn-title" data-i18n="settings">Settings</div>
                </button>
            </div>
        </div>
        
        <!-- í•˜ë‹¨ ì •ë³´ -->
        <div class="voyager-footer">
            <div class="voyager-version">v1.0</div>
        </div>
    </div>
</div>

<style>
/* â˜…â˜…â˜… STARÂ·WALKER ë©”ì¸ ë©”ë‰´ ìŠ¤íƒ€ì¼ â˜…â˜…â˜… */
#mode-select-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: linear-gradient(135deg, #0a0a1a 0%, #0d1b2a 50%, #1b263b 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    overflow: hidden;
}

/* ë°°ê²½ ë³„ íš¨ê³¼ */
.voyager-bg-stars {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-image: 
        radial-gradient(2px 2px at 20px 30px, #fff, transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 90px 40px, #fff, transparent),
        radial-gradient(2px 2px at 160px 120px, rgba(0,255,255,0.6), transparent),
        radial-gradient(1px 1px at 230px 80px, #fff, transparent),
        radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.7), transparent);
    background-size: 350px 200px;
    animation: starFloat 60s linear infinite;
    opacity: 0.6;
}

/* ì„±ìš´ íš¨ê³¼ */
.voyager-bg-nebula {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: 
        radial-gradient(ellipse at 20% 80%, rgba(0, 150, 255, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(0, 255, 200, 0.05) 0%, transparent 70%);
    animation: nebulaShift 30s ease-in-out infinite alternate;
}

@keyframes starFloat {
    0% { transform: translateY(0); }
    100% { transform: translateY(-200px); }
}

@keyframes nebulaShift {
    0% { opacity: 0.8; }
    100% { opacity: 1; }
}

/* ë©”ì¸ ì»¨í…ì¸  */
.voyager-main-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    max-width: 400px;
    width: 100%;
}

/* ë¡œê³  */
.voyager-logo {
    text-align: center;
    margin-bottom: 40px;
}

.voyager-logo-icon {
    font-size: 60px;
    margin-bottom: 10px;
    animation: logoFloat 3s ease-in-out infinite;
    filter: drop-shadow(0 0 20px rgba(0, 200, 255, 0.5));
}

@keyframes logoFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.voyager-logo-text {
    font-family: 'Orbitron', 'Rajdhani', sans-serif;
    font-size: 42px;
    font-weight: 900;
    letter-spacing: 4px;
    background: linear-gradient(135deg, #00d4ff 0%, #00ff88 50%, #00d4ff 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: logoShine 3s linear infinite;
    text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
}

.voyager-logo-text .logo-dot {
    color: #fff;
    -webkit-text-fill-color: #fff;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
    animation: dotPulse 2s ease-in-out infinite;
}

@keyframes dotPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes logoShine {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
}

.voyager-logo-tagline {
    font-family: 'Orbitron', sans-serif;
    font-size: 10px;
    letter-spacing: 4px;
    color: rgba(0, 212, 255, 0.7);
    margin-top: 8px;
}

/* ë©”ë‰´ */
.voyager-menu {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
}

/* ë©”ì¸ ë²„íŠ¼ */
.voyager-btn {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 16px 20px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    text-align: left;
}

.voyager-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
}

.voyager-btn:hover::before {
    left: 100%;
}

.voyager-btn:active {
    transform: scale(0.98);
}

/* Primary ë²„íŠ¼ (ì‹±ê¸€) */
.voyager-btn.primary {
    background: linear-gradient(135deg, rgba(0, 100, 150, 0.8) 0%, rgba(0, 150, 200, 0.6) 100%);
    border: 2px solid rgba(0, 200, 255, 0.5);
    box-shadow: 0 0 20px rgba(0, 200, 255, 0.2), inset 0 1px 0 rgba(255,255,255,0.1);
}

.voyager-btn.primary:hover {
    border-color: rgba(0, 255, 255, 0.8);
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
}

/* Secondary ë²„íŠ¼ (ë©€í‹°) */
.voyager-btn.secondary {
    background: linear-gradient(135deg, rgba(100, 50, 150, 0.8) 0%, rgba(150, 80, 200, 0.6) 100%);
    border: 2px solid rgba(180, 100, 255, 0.5);
    box-shadow: 0 0 20px rgba(150, 100, 255, 0.2), inset 0 1px 0 rgba(255,255,255,0.1);
}

.voyager-btn.secondary:hover {
    border-color: rgba(200, 150, 255, 0.8);
    box-shadow: 0 0 30px rgba(180, 100, 255, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
}

/* Tertiary ë²„íŠ¼ (ë¯¸ì…˜) */
.voyager-btn.tertiary {
    background: linear-gradient(135deg, rgba(150, 100, 0, 0.8) 0%, rgba(200, 150, 50, 0.6) 100%);
    border: 2px solid rgba(255, 200, 100, 0.5);
    box-shadow: 0 0 20px rgba(255, 180, 50, 0.2), inset 0 1px 0 rgba(255,255,255,0.1);
}

.voyager-btn.tertiary:hover {
    border-color: rgba(255, 220, 150, 0.8);
    box-shadow: 0 0 30px rgba(255, 200, 100, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
}

.voyager-btn .btn-icon {
    font-size: 28px;
    margin-right: 15px;
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
}

.voyager-btn .btn-content {
    flex: 1;
}

.voyager-btn .btn-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
}

.voyager-btn .btn-desc {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.7);
}

.voyager-btn .btn-arrow {
    font-size: 24px;
    color: rgba(255, 255, 255, 0.5);
    transition: transform 0.3s;
}

.voyager-btn:hover .btn-arrow {
    transform: translateX(5px);
    color: rgba(255, 255, 255, 0.9);
}

/* ì‘ì€ ë²„íŠ¼ í–‰ */
.voyager-btn-row {
    display: flex;
    gap: 12px;
    margin-top: 8px;
}

.voyager-btn-small {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    background: linear-gradient(135deg, rgba(50, 50, 70, 0.8) 0%, rgba(70, 70, 90, 0.6) 100%);
    border: 2px solid rgba(100, 100, 150, 0.5);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.voyager-btn-small:hover {
    border-color: rgba(150, 150, 200, 0.8);
    box-shadow: 0 0 20px rgba(100, 100, 200, 0.3);
}

.voyager-btn-small:active {
    transform: scale(0.95);
}

.voyager-btn-small .btn-icon {
    font-size: 24px;
    margin-bottom: 5px;
}

.voyager-btn-small .btn-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.9);
}

/* í‘¸í„° */
.voyager-footer {
    margin-top: 30px;
    text-align: center;
}

.voyager-version {
    font-family: 'Orbitron', sans-serif;
    font-size: 10px;
    color: rgba(255, 255, 255, 0.3);
    letter-spacing: 2px;
}

/* ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 480px) {
    .voyager-logo-text {
        font-size: 36px;
        letter-spacing: 5px;
    }
    
    .voyager-logo-icon {
        font-size: 50px;
    }
    
    .voyager-logo-tagline {
        font-size: 8px;
        letter-spacing: 2px;
    }
    
    .voyager-btn {
        padding: 14px 16px;
    }
    
    .voyager-btn .btn-icon {
        font-size: 24px;
        margin-right: 12px;
    }
    
    .voyager-btn .btn-title {
        font-size: 14px;
    }
    
    .voyager-btn .btn-desc {
        font-size: 10px;
    }
}

/* ìŠ¤ìº”ë¼ì¸ íš¨ê³¼ (ì„ íƒì ) */
#mode-select-overlay::after {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.03) 2px,
        rgba(0, 0, 0, 0.03) 4px
    );
    pointer-events: none;
}
</style>

<!-- â˜…â˜…â˜… ì„¤ì • ëª¨ë‹¬ â˜…â˜…â˜… -->
<div id="settings-modal" class="voyager-modal">
    <div class="voyager-modal-content">
        <div class="voyager-modal-header">
            <div class="modal-title" data-i18n="settings">âš™ï¸ ì„¤ì •</div>
            <button class="modal-close" id="settings-close">âœ•</button>
        </div>
        <div class="voyager-modal-body">
            <div class="settings-section">
                <div class="settings-label" data-i18n="sound">ğŸ”Š ì†Œë¦¬</div>
                <div class="settings-control">
                    <input type="range" id="settings-volume" min="0" max="100" value="50">
                    <span id="settings-volume-val">50%</span>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-label" data-i18n="graphics">ğŸ¨ ê·¸ë˜í”½</div>
                <div class="settings-control">
                    <select id="settings-graphics">
                        <option value="low" data-i18n="graphicsLow">ë‚®ìŒ</option>
                        <option value="medium" selected data-i18n="graphicsMedium">ì¤‘ê°„</option>
                        <option value="high" data-i18n="graphicsHigh">ë†’ìŒ</option>
                    </select>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-label" data-i18n="language">ğŸŒ ì–¸ì–´</div>
                <div class="settings-control">
                    <select id="settings-language">
                        <option value="en" selected>English</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="la">Latina</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â˜…â˜…â˜… ì²œì²´ ì •ë³´ íŒì—… (í„°ì¹˜ ì‹œ í‘œì‹œ) â˜…â˜…â˜… -->
<div id="body-info-popup" class="body-info-popup">
    <div class="popup-header">
        <span class="popup-icon">ğŸŒ</span>
        <span class="popup-name">Earth</span>
        <span class="popup-type">Planet</span>
    </div>
    <div class="popup-stats">
        <div class="stat-row"><span class="stat-label" data-i18n="bodyRadius">ë°˜ì§€ë¦„</span><span class="stat-value" id="popup-radius">6,371 km</span></div>
        <div class="stat-row"><span class="stat-label" data-i18n="bodyMass">ì§ˆëŸ‰</span><span class="stat-value" id="popup-mass">5.97Ã—10Â²â´ kg</span></div>
        <div class="stat-row"><span class="stat-label" data-i18n="bodyDistance">ê±°ë¦¬</span><span class="stat-value" id="popup-distance">0 km</span></div>
    </div>
    <button class="popup-detail-btn" id="popup-detail-btn" data-i18n="bodyDetailBtn">ğŸ“– ìƒì„¸ë³´ê¸°</button>
</div>

<!-- â˜…â˜…â˜… ì²œì²´ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ â˜…â˜…â˜… -->
<div id="body-detail-modal" class="body-detail-modal">
    <div class="detail-modal-content">
        <button class="detail-close-btn" id="body-detail-close">âœ•</button>
        
        <div class="detail-header">
            <div class="detail-icon-wrap">
                <div class="detail-icon">ğŸŒ</div>
            </div>
            <div class="detail-title-wrap">
                <h2 class="detail-name">Earth</h2>
                <span class="detail-type">Rocky Planet</span>
            </div>
        </div>
        
        <div class="detail-body">
            <div class="detail-section">
                <h3 data-i18n="bodyBasicInfo">ğŸ“Š ê¸°ë³¸ ì •ë³´</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="item-label" data-i18n="bodyRadius">ë°˜ì§€ë¦„</span>
                        <span class="item-value" id="detail-radius">6,371 km</span>
                    </div>
                    <div class="detail-item">
                        <span class="item-label" data-i18n="bodyMass">ì§ˆëŸ‰</span>
                        <span class="item-value" id="detail-mass">5.97Ã—10Â²â´ kg</span>
                    </div>
                    <div class="detail-item">
                        <span class="item-label" data-i18n="bodyRotation">ìì „ ì†ë„</span>
                        <span class="item-value" id="detail-rotation">1 day</span>
                    </div>
                    <div class="detail-item">
                        <span class="item-label" data-i18n="bodySurfaceGravity">í‘œë©´ ì¤‘ë ¥</span>
                        <span class="item-value" id="detail-gravity">9.8 m/sÂ²</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <h3 data-i18n="bodyOrbitInfo">ğŸ›°ï¸ ê¶¤ë„ ì •ë³´</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="item-label" data-i18n="bodyDistance">í˜„ì¬ ê±°ë¦¬</span>
                        <span class="item-value" id="detail-distance">149.6M km</span>
                    </div>
                    <div class="detail-item">
                        <span class="item-label" data-i18n="bodyOrbitalSpeed">ê³µì „ ì†ë„</span>
                        <span class="item-value" id="detail-orbital-speed">29.78 km/s</span>
                    </div>
                    <div class="detail-item">
                        <span class="item-label" data-i18n="bodyMoons">ìœ„ì„± ìˆ˜</span>
                        <span class="item-value" id="detail-moons">1</span>
                    </div>
                    <div class="detail-item">
                        <span class="item-label" data-i18n="bodyRings">ê³ ë¦¬</span>
                        <span class="item-value" id="detail-rings" data-i18n="none">ì—†ìŒ</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <h3 data-i18n="bodyDescription">ğŸ“ ì„¤ëª…</h3>
                <p class="detail-description" id="detail-description">
                    ì§€êµ¬ëŠ” íƒœì–‘ê³„ì—ì„œ ì„¸ ë²ˆì§¸ í–‰ì„±ì´ë©°, ì•Œë ¤ì§„ ìœ ì¼í•œ ìƒëª…ì²´ê°€ ì¡´ì¬í•˜ëŠ” ì²œì²´ì…ë‹ˆë‹¤.
                </p>
            </div>
            
            <div class="detail-actions">
                <button class="detail-action-btn" id="detail-focus-btn" data-i18n="bodyFocusBtn">ğŸ¯ ì¶”ì í•˜ê¸°</button>
                <button class="detail-action-btn" id="detail-nav-btn" data-i18n="bodyNavBtn">ğŸ§­ í•­ë²• ëª©í‘œ ì„¤ì •</button>
            </div>
        </div>
    </div>
</div>

<style>
/* â˜…â˜…â˜… ì²œì²´ ì •ë³´ íŒì—… ìŠ¤íƒ€ì¼ â˜…â˜…â˜… */
.body-info-popup {
    position: fixed;
    display: none;
    background: linear-gradient(135deg, rgba(10, 20, 40, 0.95) 0%, rgba(5, 15, 35, 0.98) 100%);
    border: 2px solid rgba(0, 200, 255, 0.5);
    border-radius: 12px;
    padding: 12px 15px;
    min-width: 180px;
    max-width: 220px;
    z-index: 2000;
    pointer-events: auto;
    box-shadow: 0 0 30px rgba(0, 200, 255, 0.3), inset 0 0 20px rgba(0, 100, 150, 0.1);
    backdrop-filter: blur(10px);
    animation: popupFadeIn 0.3s ease;
    font-family: 'Rajdhani', sans-serif;
}

.body-info-popup::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, #00d4ff, transparent);
}

@keyframes popupFadeIn {
    from { opacity: 0; transform: scale(0.9) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.popup-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(0, 200, 255, 0.2);
}

.popup-icon {
    font-size: 24px;
    filter: drop-shadow(0 0 5px currentColor);
}

.popup-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: #00d4ff;
    flex: 1;
}

.popup-type {
    font-size: 10px;
    color: #888;
    background: rgba(0, 200, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
}

.popup-stats {
    margin-bottom: 10px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 11px;
}

.stat-label {
    color: #888;
}

.stat-value {
    color: #00ff88;
    font-family: 'Orbitron', monospace;
    font-size: 10px;
}

.popup-detail-btn {
    width: 100%;
    padding: 8px;
    background: linear-gradient(135deg, rgba(0, 150, 255, 0.3) 0%, rgba(0, 100, 200, 0.2) 100%);
    border: 1px solid rgba(0, 200, 255, 0.5);
    border-radius: 6px;
    color: #00d4ff;
    font-family: 'Orbitron', sans-serif;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s;
}

.popup-detail-btn:hover {
    background: rgba(0, 200, 255, 0.3);
    box-shadow: 0 0 15px rgba(0, 200, 255, 0.4);
}

/* â˜…â˜…â˜… ì²œì²´ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ â˜…â˜…â˜… */
.body-detail-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 5, 15, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
    animation: modalFadeIn 0.3s ease;
}

.body-detail-modal.open {
    display: flex;
}

@keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.detail-modal-content {
    background: linear-gradient(180deg, rgba(10, 25, 50, 0.98) 0%, rgba(5, 15, 35, 0.99) 100%);
    border: 2px solid rgba(0, 200, 255, 0.4);
    border-radius: 16px;
    width: 90%;
    max-width: 450px;
    max-height: 85vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 0 50px rgba(0, 150, 255, 0.3);
    animation: contentSlideIn 0.4s ease;
}

@keyframes contentSlideIn {
    from { transform: translateY(30px) scale(0.95); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
}

.detail-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 36px;
    height: 36px;
    background: rgba(255, 50, 50, 0.2);
    border: 1px solid rgba(255, 100, 100, 0.4);
    border-radius: 50%;
    color: #ff6666;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s;
    z-index: 10;
}

.detail-close-btn:hover {
    background: rgba(255, 50, 50, 0.4);
    transform: rotate(90deg);
}

.detail-header {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 25px;
    background: linear-gradient(135deg, rgba(0, 100, 150, 0.2) 0%, transparent 100%);
    border-bottom: 1px solid rgba(0, 200, 255, 0.2);
}

.detail-icon-wrap {
    width: 70px;
    height: 70px;
    background: radial-gradient(circle, rgba(0, 150, 255, 0.3) 0%, transparent 70%);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid rgba(0, 200, 255, 0.3);
    box-shadow: 0 0 20px rgba(0, 150, 255, 0.3);
}

.detail-icon {
    font-size: 40px;
    filter: drop-shadow(0 0 10px currentColor);
}

.detail-title-wrap {
    flex: 1;
}

.detail-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 22px;
    color: #00d4ff;
    margin: 0 0 5px 0;
    text-shadow: 0 0 10px rgba(0, 200, 255, 0.5);
}

.detail-type {
    font-size: 12px;
    color: #888;
    background: rgba(0, 200, 255, 0.1);
    padding: 3px 10px;
    border-radius: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.detail-body {
    padding: 20px 25px;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-section h3 {
    font-family: 'Orbitron', sans-serif;
    font-size: 13px;
    color: #00aaff;
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(0, 150, 255, 0.2);
}

.detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.detail-item {
    background: rgba(0, 50, 100, 0.2);
    border: 1px solid rgba(0, 150, 255, 0.15);
    border-radius: 8px;
    padding: 10px;
}

.item-label {
    display: block;
    font-size: 10px;
    color: #888;
    margin-bottom: 4px;
    text-transform: uppercase;
}

.item-value {
    display: block;
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    color: #00ff88;
}

.detail-description {
    font-size: 13px;
    line-height: 1.7;
    color: #aaa;
    margin: 0;
    background: rgba(0, 50, 100, 0.15);
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid rgba(0, 200, 255, 0.4);
}

.detail-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.detail-action-btn {
    flex: 1;
    padding: 12px;
    background: linear-gradient(135deg, rgba(0, 150, 255, 0.2) 0%, rgba(0, 100, 200, 0.1) 100%);
    border: 1px solid rgba(0, 200, 255, 0.4);
    border-radius: 8px;
    color: #00d4ff;
    font-family: 'Orbitron', sans-serif;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s;
}

.detail-action-btn:hover {
    background: rgba(0, 200, 255, 0.3);
    box-shadow: 0 0 20px rgba(0, 200, 255, 0.3);
    transform: translateY(-2px);
}

/* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
.detail-modal-content::-webkit-scrollbar {
    width: 6px;
}
.detail-modal-content::-webkit-scrollbar-track {
    background: rgba(0, 50, 100, 0.2);
}
.detail-modal-content::-webkit-scrollbar-thumb {
    background: rgba(0, 200, 255, 0.4);
    border-radius: 3px;
}

/* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
@media (max-width: 480px) {
    .detail-modal-content {
        width: 95%;
        max-height: 90vh;
    }
    .detail-header {
        padding: 20px;
    }
    .detail-icon-wrap {
        width: 55px;
        height: 55px;
    }
    .detail-icon {
        font-size: 30px;
    }
    .detail-name {
        font-size: 18px;
    }
    .detail-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- â˜…â˜…â˜… ë¯¸ì…˜ ë³´ë“œ ëª¨ë‹¬ â˜…â˜…â˜… -->
<div id="mission-board-modal" class="voyager-modal">
    <div class="voyager-modal-content wide">
        <div class="voyager-modal-header">
            <div class="modal-title" data-i18n="missionBoard">ğŸ“‹ Mission Board</div>
            <button class="modal-close" id="mission-board-close">âœ•</button>
        </div>
        <div class="voyager-modal-body">
            <div class="mission-tabs">
                <button class="mission-tab active" data-tab="active" data-i18n="missionActive">Active</button>
                <button class="mission-tab" data-tab="available" data-i18n="missionAvailable">Available</button>
                <button class="mission-tab" data-tab="completed" data-i18n="missionCompleted">Completed</button>
            </div>
            <div class="mission-list" id="mission-list">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>
        </div>
    </div>
</div>

<script>
// â˜…â˜…â˜… ë¯¸ì…˜ ì‹œìŠ¤í…œ â˜…â˜…â˜…
const MissionSystem = {
    // ë‹¤êµ­ì–´ ë¯¸ì…˜ ë°ì´í„°
    getMissionData() {
        const lang = window.currentLang || (typeof currentLang !== 'undefined' ? currentLang : 'en');
        
        if (lang === 'ko') {
            return {
                tutorials: [
                    { id: 'tut_board', name: 'ìš°ì£¼ì„  íƒ‘ìŠ¹', desc: 'ISS ìš°ì£¼ì •ê±°ì¥ì—ì„œ ìš°ì£¼ì„  íƒ‘ìŠ¹', icon: 'ğŸš€', reward: 50, type: 'tutorial' },
                    { id: 'tut_move', name: 'ì²« ë¹„í–‰', desc: 'ìš°ì£¼ì„ ìœ¼ë¡œ 100 ìœ ë‹› ì´ìƒ ë¹„í–‰', icon: 'âœˆï¸', reward: 50, type: 'tutorial', target: 100 },
                    { id: 'tut_target', name: 'í•­ë²• ëª©í‘œ ì„¤ì •', desc: 'í•­ë²• ëª©í‘œ ì„¤ì •í•˜ê¸°', icon: 'ğŸ¯', reward: 30, type: 'tutorial' },
                    { id: 'tut_autopilot', name: 'ìë™í•­ë²• ì‚¬ìš©', desc: 'ìë™í•­ë²• í™œì„±í™”', icon: 'ğŸ¤–', reward: 50, type: 'tutorial' },
                    { id: 'tut_dock', name: 'ë„í‚¹ ì„±ê³µ', desc: 'ìš°ì£¼ ì •ê±°ì¥ì— ë„í‚¹', icon: 'ğŸ”—', reward: 100, type: 'tutorial' },
                    { id: 'tut_refuel', name: 'ì—°ë£Œ ë³´ê¸‰', desc: 'ì •ê±°ì¥ì—ì„œ ì—°ë£Œ ë³´ê¸‰', icon: 'â›½', reward: 30, type: 'tutorial' }
                ],
                exploration: [
                    { id: 'exp_earth', name: 'ì§€êµ¬ ê¶¤ë„', desc: 'ì§€êµ¬ ì£¼ìœ„ ê¶¤ë„ ì§„ì…', icon: 'ğŸŒ', reward: 100, type: 'exploration', target: 'ì§€êµ¬' },
                    { id: 'exp_moon', name: 'ë‹¬ íƒì‚¬', desc: 'ë‹¬ì— ì ‘ê·¼', icon: 'ğŸŒ™', reward: 150, type: 'exploration', target: 'ë‹¬' },
                    { id: 'exp_mars', name: 'í™”ì„± íƒì‚¬', desc: 'í™”ì„±ì— ì ‘ê·¼', icon: 'ğŸ”´', reward: 250, type: 'exploration', target: 'í™”ì„±' },
                    { id: 'exp_jupiter', name: 'ëª©ì„± ê·¼ì ‘ í†µê³¼', desc: 'ëª©ì„±ì— ì ‘ê·¼', icon: 'ğŸª', reward: 500, type: 'exploration', target: 'ëª©ì„±', minLevel: 3 },
                    { id: 'exp_saturn', name: 'í† ì„± ê³ ë¦¬ íƒí—˜', desc: 'í† ì„±ì— ì ‘ê·¼', icon: 'ğŸ’«', reward: 600, type: 'exploration', target: 'í† ì„±', minLevel: 4 }
                ]
            };
        } else if (lang === 'ja') {
            return {
                tutorials: [
                    { id: 'tut_board', name: 'å®‡å®™èˆ¹æ­ä¹—', desc: 'ISSå®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å®‡å®™èˆ¹ã«æ­ä¹—', icon: 'ğŸš€', reward: 50, type: 'tutorial' },
                    { id: 'tut_move', name: 'åˆé£›è¡Œ', desc: 'å®‡å®™èˆ¹ã§100ãƒ¦ãƒ‹ãƒƒãƒˆä»¥ä¸Šé£›è¡Œ', icon: 'âœˆï¸', reward: 50, type: 'tutorial', target: 100 },
                    { id: 'tut_target', name: 'èˆªæ³•ç›®æ¨™è¨­å®š', desc: 'èˆªæ³•ç›®æ¨™ã‚’è¨­å®š', icon: 'ğŸ¯', reward: 30, type: 'tutorial' },
                    { id: 'tut_autopilot', name: 'è‡ªå‹•èˆªæ³•ä½¿ç”¨', desc: 'è‡ªå‹•èˆªæ³•ã‚’æœ‰åŠ¹åŒ–', icon: 'ğŸ¤–', reward: 50, type: 'tutorial' },
                    { id: 'tut_dock', name: 'ãƒ‰ãƒƒã‚­ãƒ³ã‚°æˆåŠŸ', desc: 'å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ‰ãƒƒã‚­ãƒ³ã‚°', icon: 'ğŸ”—', reward: 100, type: 'tutorial' },
                    { id: 'tut_refuel', name: 'ç‡ƒæ–™è£œçµ¦', desc: 'ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ç‡ƒæ–™è£œçµ¦', icon: 'â›½', reward: 30, type: 'tutorial' }
                ],
                exploration: [
                    { id: 'exp_earth', name: 'åœ°çƒè»Œé“', desc: 'åœ°çƒå‘¨å›è»Œé“ã«å…¥ã‚‹', icon: 'ğŸŒ', reward: 100, type: 'exploration', target: 'ì§€êµ¬' },
                    { id: 'exp_moon', name: 'æœˆæ¢æŸ»', desc: 'æœˆã«æ¥è¿‘', icon: 'ğŸŒ™', reward: 150, type: 'exploration', target: 'ë‹¬' },
                    { id: 'exp_mars', name: 'ç«æ˜Ÿæ¢æŸ»', desc: 'ç«æ˜Ÿã«æ¥è¿‘', icon: 'ğŸ”´', reward: 250, type: 'exploration', target: 'í™”ì„±' },
                    { id: 'exp_jupiter', name: 'æœ¨æ˜Ÿè¿‘æ¥é€šé', desc: 'æœ¨æ˜Ÿã«æ¥è¿‘', icon: 'ğŸª', reward: 500, type: 'exploration', target: 'ëª©ì„±', minLevel: 3 },
                    { id: 'exp_saturn', name: 'åœŸæ˜Ÿãƒªãƒ³ã‚°æ¢æ¤œ', desc: 'åœŸæ˜Ÿã«æ¥è¿‘', icon: 'ğŸ’«', reward: 600, type: 'exploration', target: 'í† ì„±', minLevel: 4 }
                ]
            };
        } else {
            // English (default) - also used for zh, fr, la
            return {
                tutorials: [
                    { id: 'tut_board', name: 'Board Spaceship', desc: 'Board a spaceship at ISS Space Station', icon: 'ğŸš€', reward: 50, type: 'tutorial' },
                    { id: 'tut_move', name: 'First Flight', desc: 'Fly more than 100 units with spaceship', icon: 'âœˆï¸', reward: 50, type: 'tutorial', target: 100 },
                    { id: 'tut_target', name: 'Set Navigation Target', desc: 'Set a navigation target', icon: 'ğŸ¯', reward: 30, type: 'tutorial' },
                    { id: 'tut_autopilot', name: 'Use Autopilot', desc: 'Activate autopilot', icon: 'ğŸ¤–', reward: 50, type: 'tutorial' },
                    { id: 'tut_dock', name: 'Docking Success', desc: 'Dock at a space station', icon: 'ğŸ”—', reward: 100, type: 'tutorial' },
                    { id: 'tut_refuel', name: 'Refuel', desc: 'Refuel at a station', icon: 'â›½', reward: 30, type: 'tutorial' }
                ],
                exploration: [
                    { id: 'exp_earth', name: 'Earth Orbit', desc: 'Enter orbit around Earth', icon: 'ğŸŒ', reward: 100, type: 'exploration', target: 'ì§€êµ¬' },
                    { id: 'exp_moon', name: 'Moon Exploration', desc: 'Approach the Moon', icon: 'ğŸŒ™', reward: 150, type: 'exploration', target: 'ë‹¬' },
                    { id: 'exp_mars', name: 'Mars Exploration', desc: 'Approach Mars', icon: 'ğŸ”´', reward: 250, type: 'exploration', target: 'í™”ì„±' },
                    { id: 'exp_jupiter', name: 'Jupiter Flyby', desc: 'Approach Jupiter', icon: 'ğŸª', reward: 500, type: 'exploration', target: 'ëª©ì„±', minLevel: 3 },
                    { id: 'exp_saturn', name: 'Saturn Ring Exploration', desc: 'Approach Saturn', icon: 'ğŸ’«', reward: 600, type: 'exploration', target: 'í† ì„±', minLevel: 4 }
                ]
            };
        }
    },
    
    // í˜„ì¬ ì–¸ì–´ì˜ ë¯¸ì…˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    get tutorials() {
        return this.getMissionData().tutorials;
    },
    
    get exploration() {
        return this.getMissionData().exploration;
    },
    
    // ì‚¬ìš©ì ë¯¸ì…˜ ì§„í–‰ ìƒí™© (localStorageì—ì„œ ë¡œë“œ)
    progress: {},
    
    init: function() {
        this.loadProgress();
        this.render();
    },
    
    loadProgress: function() {
        // â˜… ì‹±ê¸€ëª¨ë“œ: localStorage, ë©€í‹°ëª¨ë“œëŠ” loadProgressAsync ì‚¬ìš©
        const saved = localStorage.getItem('starwalker-missions');
        if (saved) {
            try {
                this.progress = JSON.parse(saved);
            } catch (e) {
                this.progress = {};
            }
        }

        // ê¸°ë³¸ ì§„í–‰ ìƒí™© ì´ˆê¸°í™”
        this.initDefaultProgress();
    },

    // â˜… ë¹„ë™ê¸° ë¡œë“œ (ë©€í‹°ëª¨ë“œìš©)
    loadProgressAsync: async function() {
        if (window.gameMode !== 'multi') {
            this.loadProgress();
            return;
        }
        try {
            const serverData = await GameDataManager.load('missions', 'starwalker-missions');
            if (serverData) {
                this.progress = serverData;
                console.log('âœ… ë¯¸ì…˜ ì§„í–‰ ì„œë²„ì—ì„œ ë¡œë“œë¨');
            }
        } catch (e) {
            console.warn('ë¯¸ì…˜ ì§„í–‰ ì„œë²„ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
        this.initDefaultProgress();
    },

    // â˜… ê¸°ë³¸ ì§„í–‰ ìƒí™© ì´ˆê¸°í™”
    initDefaultProgress: function() {
        [...this.tutorials, ...this.exploration].forEach(m => {
            if (!this.progress[m.id]) {
                this.progress[m.id] = { current: 0, completed: false, accepted: m.type === 'tutorial' };
            }
        });
    },

    saveProgress: function() {
        // â˜… GameDataManagerë¥¼ í†µí•´ ì €ì¥ (ë©€í‹°: ì„œë²„, ì‹±ê¸€: ë¡œì»¬)
        GameDataManager.save('missions', this.progress, 'starwalker-missions');
    },
    
    // ë¯¸ì…˜ ì§„í–‰ ì—…ë°ì´íŠ¸
    updateProgress: function(missionId, value = 1) {
        if (!this.progress[missionId]) return;
        if (this.progress[missionId].completed) return;
        
        this.progress[missionId].current += value;
        
        const mission = this.getMission(missionId);
        if (mission) {
            const target = mission.target ? 1 : (mission.targetValue || 1);
            if (typeof target === 'number' && this.progress[missionId].current >= target) {
                this.completeMission(missionId);
            }
        }
        
        this.saveProgress();
        this.render();
    },
    
    // ë¯¸ì…˜ ì™„ë£Œ
    completeMission: function(missionId) {
        if (!this.progress[missionId] || this.progress[missionId].completed) return;
        
        const mission = this.getMission(missionId);
        if (!mission) return;
        
        this.progress[missionId].completed = true;
        this.progress[missionId].current = 1;
        
        // ë³´ìƒ ì§€ê¸‰
        if (typeof addCoins === 'function') {
            addCoins(mission.reward);
        }
        
        // ê²½í—˜ì¹˜ ì§€ê¸‰
        if (typeof addExp === 'function') {
            addExp(mission.reward);
        }
        
        this.saveProgress();
        AudioManager.playSFX('sfx_mission_complete');  // â˜… ë¯¸ì…˜ ì™„ë£Œ íš¨ê³¼ìŒ
        showMsg(`ğŸ‰ Mission Complete! "${mission.name}" - ${mission.reward} coins earned!`);
    },
    
    getMission: function(id) {
        return [...this.tutorials, ...this.exploration].find(m => m.id === id);
    },
    
    // ë¯¸ì…˜ ë³´ë“œ ë Œë”ë§
    render: function(tab = 'active') {
        const list = document.getElementById('mission-list');
        if (!list) return;
        
        list.innerHTML = '';
        
        const allMissions = [...this.tutorials, ...this.exploration];
        const userLevel = window.userLevel || 1;
        
        allMissions.forEach(mission => {
            const prog = this.progress[mission.id] || { current: 0, completed: false, accepted: false };
            
            // íƒ­ í•„í„°ë§
            if (tab === 'active' && (!prog.accepted || prog.completed)) return;
            if (tab === 'available' && (prog.accepted || prog.completed)) return;
            if (tab === 'completed' && !prog.completed) return;
            
            // ë ˆë²¨ ì ê¸ˆ
            const isLocked = mission.minLevel && userLevel < mission.minLevel;
            
            const card = document.createElement('div');
            card.className = 'mission-card' + (isLocked ? ' locked' : '') + (prog.completed ? ' completed' : '');
            
            const targetValue = typeof mission.target === 'number' ? mission.target : 1;
            const progressPercent = prog.completed ? 100 : Math.min(100, Math.round((prog.current / targetValue) * 100));
            
            card.innerHTML = `
                <div class="mission-icon">${mission.icon}</div>
                <div class="mission-info">
                    <div class="mission-name">${mission.name}</div>
                    <div class="mission-desc">${mission.desc}</div>
                    ${isLocked ? 
                        `<div class="mission-status">ğŸ”’ ${currentLang === 'ko' ? 'ë ˆë²¨' : currentLang === 'ja' ? 'ãƒ¬ãƒ™ãƒ«' : 'Level'} ${mission.minLevel} ${currentLang === 'ko' ? 'í•„ìš”' : currentLang === 'ja' ? 'å¿…è¦' : 'Required'}</div>` :
                        prog.completed ?
                        `<div class="mission-status completed">âœ… ${currentLang === 'ko' ? 'ì™„ë£Œ!' : currentLang === 'ja' ? 'å®Œäº†!' : 'Complete!'}</div>` :
                        `<div class="mission-progress">
                            <div class="progress-bar"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>
                            <span>${progressPercent}%</span>
                        </div>`
                    }
                </div>
                <div class="mission-reward">ğŸª™ ${mission.reward}</div>
            `;
            
            // ìˆ˜ë½ ê°€ëŠ¥ ë¯¸ì…˜ í´ë¦­ ì‹œ ìˆ˜ë½
            if (tab === 'available' && !isLocked && !prog.accepted) {
                card.style.cursor = 'pointer';
                card.onclick = () => {
                    this.progress[mission.id].accepted = true;
                    this.saveProgress();
                    const acceptMsg = currentLang === 'ko' ? `ğŸ“‹ ë¯¸ì…˜ ìˆ˜ë½: "${mission.name}"` :
                                     currentLang === 'ja' ? `ğŸ“‹ ãƒŸãƒƒã‚·ãƒ§ãƒ³å—è«¾: "${mission.name}"` :
                                     `ğŸ“‹ Mission Accepted: "${mission.name}"`;
                    showMsg(acceptMsg);
                    this.render('active');
                    // í™œì„± íƒ­ìœ¼ë¡œ ì „í™˜
                    document.querySelectorAll('.mission-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('.mission-tab[data-tab="active"]').classList.add('active');
                };
            }
            
            list.appendChild(card);
        });
        
        // ë¹ˆ ëª©ë¡ ë©”ì‹œì§€
        if (list.children.length === 0) {
            const lang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
            let emptyMsg;
            if (lang === 'ko') {
                emptyMsg = tab === 'active' ? 'ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤' : 
                          tab === 'available' ? 'ìˆ˜ë½ ê°€ëŠ¥í•œ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤' : 
                          'ì™„ë£Œí•œ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤';
            } else if (lang === 'ja') {
                emptyMsg = tab === 'active' ? 'é€²è¡Œä¸­ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“' : 
                          tab === 'available' ? 'å—è«¾å¯èƒ½ãªãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“' : 
                          'å®Œäº†ã—ãŸãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“';
            } else {
                emptyMsg = tab === 'active' ? 'No active missions' : 
                          tab === 'available' ? 'No available missions' : 
                          'No completed missions';
            }
            list.innerHTML = `<div style="text-align: center; color: #666; padding: 20px;">${emptyMsg}</div>`;
        }
    }
};

// ë¯¸ì…˜ ì™„ë£Œ ìŠ¤íƒ€ì¼ ì¶”ê°€
const missionStyle = document.createElement('style');
missionStyle.textContent = `
    .mission-card.completed { opacity: 0.7; border-color: #00ff88; }
    .mission-card.completed .mission-icon { filter: grayscale(0.5); }
    .mission-status.completed { color: #00ff88; font-weight: bold; }
`;
document.head.appendChild(missionStyle);

// ê²Œì„ ì´ë²¤íŠ¸ì—ì„œ ë¯¸ì…˜ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
window.MissionSystem = MissionSystem;
</script>

<style>
/* â˜…â˜…â˜… VOYAGER ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ â˜…â˜…â˜… */
.voyager-modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100000;
    backdrop-filter: blur(5px);
}

.voyager-modal.active {
    display: flex;
}

.voyager-modal-content {
    background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
    border: 2px solid rgba(0, 200, 255, 0.4);
    border-radius: 16px;
    width: 90%;
    max-width: 380px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 0 40px rgba(0, 200, 255, 0.2);
    animation: modalSlideIn 0.3s ease;
}

.voyager-modal-content.wide {
    max-width: 500px;
}

@keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.voyager-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid rgba(0, 200, 255, 0.2);
}

.voyager-modal-header .modal-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 18px;
    color: #00d4ff;
}

.voyager-modal-header .modal-close {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.5);
    font-size: 20px;
    cursor: pointer;
    transition: color 0.2s;
}

.voyager-modal-header .modal-close:hover {
    color: #ff5555;
}

.voyager-modal-body {
    padding: 20px;
    overflow-y: auto;
    max-height: calc(80vh - 60px);
}

/* ì„¤ì • ìŠ¤íƒ€ì¼ */
.settings-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.settings-label {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.9);
}

.settings-control {
    display: flex;
    align-items: center;
    gap: 10px;
}

.settings-control input[type="range"] {
    width: 100px;
    accent-color: #00d4ff;
}

.settings-control select {
    background: rgba(0, 50, 80, 0.8);
    border: 1px solid rgba(0, 200, 255, 0.4);
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
}

.settings-control span {
    font-size: 12px;
    color: #00d4ff;
    min-width: 35px;
}

/* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(100, 100, 100, 0.5);
    border-radius: 26px;
    transition: 0.3s;
}

.toggle-slider::before {
    content: '';
    position: absolute;
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background: #fff;
    border-radius: 50%;
    transition: 0.3s;
}

.toggle-switch input:checked + .toggle-slider {
    background: rgba(0, 200, 255, 0.7);
}

.toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(24px);
}

/* ë¯¸ì…˜ ë³´ë“œ ìŠ¤íƒ€ì¼ */
.mission-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.mission-tab {
    flex: 1;
    padding: 10px;
    background: rgba(50, 50, 70, 0.5);
    border: 1px solid rgba(100, 100, 150, 0.3);
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.mission-tab.active {
    background: rgba(0, 150, 200, 0.4);
    border-color: rgba(0, 200, 255, 0.6);
    color: #fff;
}

.mission-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.mission-card {
    display: flex;
    align-items: center;
    padding: 14px;
    background: linear-gradient(135deg, rgba(30, 50, 70, 0.8) 0%, rgba(40, 60, 80, 0.6) 100%);
    border: 1px solid rgba(0, 200, 255, 0.3);
    border-radius: 10px;
    transition: all 0.2s;
}

.mission-card:hover {
    border-color: rgba(0, 255, 255, 0.6);
    box-shadow: 0 0 15px rgba(0, 200, 255, 0.2);
}

.mission-card.locked {
    opacity: 0.5;
    filter: grayscale(0.5);
}

.mission-icon {
    font-size: 32px;
    margin-right: 14px;
}

.mission-info {
    flex: 1;
}

.mission-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 14px;
    color: #fff;
    margin-bottom: 4px;
}

.mission-desc {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 8px;
}

.mission-progress {
    display: flex;
    align-items: center;
    gap: 8px;
}

.progress-bar {
    flex: 1;
    height: 6px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #00d4ff, #00ff88);
    border-radius: 3px;
    transition: width 0.3s;
}

.mission-progress span {
    font-size: 11px;
    color: #00d4ff;
    min-width: 35px;
}

.mission-status {
    font-size: 11px;
    color: rgba(255, 200, 100, 0.8);
}

.mission-reward {
    font-family: 'Orbitron', sans-serif;
    font-size: 14px;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}
</style>

<!-- ê´‘ê³  ë³´ìƒ íŒ¨ë„ -->
<div id="ad-rewards-panel" style="
    position: fixed;
    right: 10px;
    top: 15px;
    z-index: 1001;
    display: flex;
    gap: 8px;
    align-items: center;
">
    <button id="ad-menu-toggle" style="
        width: 42px; height: 42px;
        background: linear-gradient(135deg, #ff6b35, #f7931e);
        color: #fff;
        border: 2px solid #ffaa00;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.3em;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 15px rgba(255, 150, 0, 0.5);
        animation: giftPulse 2s ease-in-out infinite;
    ">ğŸ“‹</button>
</div>
<style>
@keyframes giftPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 150, 0, 0.5); }
    50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(255, 150, 0, 0.8); }
}
</style>

<!-- ê´‘ê³  ë³´ìƒ ëª¨ë‹¬ -->
<div id="ad-modal-menu" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
">
    <div style="
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #0ff;
        border-radius: 15px;
        padding: 25px;
        max-width: 350px;
        width: 90%;
        color: white;
        font-family: 'Orbitron', sans-serif;
    ">
        <h3 style="text-align:center; margin:0 0 20px 0; color:#0ff;" data-i18n="adRewardsTitle">ğŸ Ad Rewards</h3>
        
        <!-- ë¶€ìŠ¤í„° -->
        <div id="ad-item-booster" class="ad-reward-item" style="
            background: rgba(0,255,255,0.1);
            border: 1px solid #0ff;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        ">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:1.1em;" data-i18n="adBoosterTitle">ğŸš€ 2x Booster</div>
                    <div style="font-size:0.75em; color:#aaa; margin-top:3px;" data-i18n="adBoosterDesc">2x acceleration & max speed (5 min)</div>
                </div>
                <div id="booster-status" style="font-size:0.8em; color:#0f0;"></div>
            </div>
            <button id="ad-booster-btn" style="
                width: 100%;
                margin-top: 8px;
                padding: 8px;
                background: linear-gradient(135deg, #0a84ff, #0066cc);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.85em;
            " data-i18n="watchAd">ğŸ“º Watch Ad</button>
        </div>
        
        <!-- ê¸´ê¸‰íƒˆì¶œ -->
        <div id="ad-item-escape" class="ad-reward-item" style="
            background: rgba(255,153,0,0.1);
            border: 1px solid #f90;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        ">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:1.1em;" data-i18n="adEscapeTitle">âš¡ Emergency Escape</div>
                    <div style="font-size:0.75em; color:#aaa; margin-top:3px;" data-i18n="adEscapeDesc">Free emergency escape x1 (10 min)</div>
                </div>
                <div id="escape-status" style="font-size:0.8em; color:#0f0;"></div>
            </div>
            <button id="ad-escape-btn" style="
                width: 100%;
                margin-top: 8px;
                padding: 8px;
                background: linear-gradient(135deg, #f39c12, #d68910);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.85em;
            " data-i18n="watchAd">ğŸ“º Watch Ad</button>
        </div>
        
        <!-- ë‘˜ëŸ¬ë³´ê¸° (ë©€í‹° ì „ìš©) -->
        <div id="ad-item-explore" class="ad-reward-item" style="
            background: rgba(155,89,182,0.1);
            border: 1px solid #9b59b6;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            display: none;
        ">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:1.1em;" data-i18n="adExploreTitle">ğŸ”­ Explore Mode</div>
                    <div style="font-size:0.75em; color:#aaa; margin-top:3px;" data-i18n="adExploreDesc">Free camera exploration (3 min, stackable)</div>
                </div>
                <div id="explore-status" style="font-size:0.8em; color:#0f0;"></div>
            </div>
            <button id="ad-explore-btn" style="
                width: 100%;
                margin-top: 8px;
                padding: 8px;
                background: linear-gradient(135deg, #9b59b6, #8e44ad);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.85em;
            " data-i18n="watchAd">ğŸ“º Watch Ad</button>
        </div>
        
        <button id="ad-modal-close" style="
            width: 100%;
            padding: 10px;
            background: #555;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
        " data-i18n="close">ë‹«ê¸°</button>
    </div>
</div>

<!-- SSIL í›ˆë ¨ ë¯¸ì…˜ íŒ¨ë„ -->
<div id="ssil-mission-panel">
    <button class="mission-close-btn" onclick="closeMissionPanel()">âœ•</button>
    <div class="ssil-logo">ğŸš€</div>
    <h2 data-i18n="ssilTrainingProgram">SSIL í›ˆë ¨ í”„ë¡œê·¸ë¨</h2>
    <div class="ssil-subtitle" data-i18n="ssilSubtitle">Solar System Integrated Logistics</div>
    
    <table class="mission-table" id="training-mission-table">
        <thead>
            <tr>
                <th class="mission-status">âœ“</th>
                <th data-i18n="mission">ë¯¸ì…˜</th>
                <th data-i18n="missionDesc">ì„¤ëª…</th>
                <th class="mission-reward" data-i18n="reward">ë³´ìƒ</th>
            </tr>
        </thead>
        <tbody id="training-mission-body">
            <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
        </tbody>
    </table>
    
    <div style="text-align:center; margin-top:20px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1);">
        <div style="color:#888; font-size:0.7em;" data-i18n="totalReward">ì´ ë³´ìƒ</div>
        <div style="color:#ffd700; font-size:1.2em;" id="total-training-reward">0 ì½”ì¸</div>
    </div>
</div>

<!-- ì¼ì¼ ë¯¸ì…˜ ì´ë©”ì¼ ì•„ì´ì½˜ -->
<div id="daily-mission-icon" onclick="openDailyMission()">
    ğŸ“§
    <span class="badge" id="daily-mission-badge">1</span>
</div>

<!-- ë¯¸ì…˜ í¬ì¸íŠ¸ í‘œì‹œ -->
<div id="mission-points-display">
    â­ <span id="mission-points-value">0</span> MP
</div>

<!-- ì¼ì¼ ë¯¸ì…˜ ëª¨ë‹¬ -->
<div id="daily-mission-modal">
    <div class="daily-mission-content">
        <div class="daily-mission-header">
            <span class="icon">ğŸ“§</span>
            <div>
                <h3 data-i18n="ssilWorkOrder">SSIL ì—…ë¬´ ì§€ì‹œì„œ</h3>
                <div style="font-size:0.7em; color:#888;" data-i18n="urgentDelivery">ê¸´ê¸‰ ë°°ë‹¬ ìš”ì²­</div>
            </div>
            <span class="date" id="daily-mission-date">12/15</span>
        </div>
        
        <div class="daily-mission-body" id="daily-mission-desc">
            í™”ì„± ì •ê±°ì¥ìœ¼ë¡œ ê¸´ê¸‰ ë¬¼ìë¥¼ ë°°ë‹¬í•´ ì£¼ì„¸ìš”.
            ì œí•œ ì‹œê°„ ë‚´ ë„ì°© ì‹œ ì¶”ê°€ ë³´ë„ˆìŠ¤ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤.
        </div>
        
        <div class="daily-mission-rewards">
            <div class="daily-reward-item">
                <div class="value" id="daily-reward-coins">300</div>
                <div class="label" data-i18n="coins">ì½”ì¸</div>
            </div>
            <div class="daily-reward-item">
                <div class="value" id="daily-reward-points">+1</div>
                <div class="label">MP</div>
            </div>
        </div>
        
        <div class="daily-mission-btns">
            <button class="daily-btn-accept" onclick="acceptDailyMission()" data-i18n="accept">âœ“ ìˆ˜ë½</button>
            <button class="daily-btn-decline" onclick="closeDailyMission()" data-i18n="later">ë‚˜ì¤‘ì—</button>
        </div>
    </div>
</div>

<!-- ì¤‘ë ¥ ê²½ê³  HUD -->
<div id="gravity-hud-warning" style="
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(200, 0, 0, 0.85);
    border: 3px solid #ff0000;
    border-radius: 15px;
    padding: 20px 30px;
    color: white;
    font-family: 'Orbitron', monospace;
    z-index: 9999;
    display: none;
    text-align: center;
    animation: gravityPulse 0.5s ease-in-out infinite alternate;
">
    <div style="font-size: 1.5em; margin-bottom: 10px;" data-i18n="gravityCapture">ğŸš¨ ì¤‘ë ¥ ìœ„í—˜!</div>
    <div id="gravity-body-name" style="font-size: 1.1em; color: #ff0;"></div>
    <div style="margin: 15px 0; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
        <div>âš¡ <span data-i18n="escapeVelocity">í•„ìš” ì†ë„</span>: <span id="gravity-escape-vel" style="color: #0ff;">0</span> km/s</div>
        <div>ğŸ“Š <span data-i18n="currentVelocity">í˜„ì¬ ì†ë„</span>: <span id="gravity-current-vel" style="color: #0f0;">0</span> km/s</div>
        <div>ğŸ“‰ <span data-i18n="deficit">ë¶€ì¡±</span>: <span id="gravity-deficit" style="color: #f90;">0</span> km/s</div>
    </div>
    <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
        ğŸ”„ <span id="gravity-turn-dir" data-i18n="turnLeft">ì¢Œì¸¡</span><span data-i18n="gravityWarning">ìœ¼ë¡œ</span> <span id="gravity-turn-angle">0</span>Â° <span data-i18n="avoidText">íšŒí”¼</span>
    </div>
</div>
<style>
@keyframes gravityPulse {
    from { box-shadow: 0 0 20px rgba(255,0,0,0.5); }
    to { box-shadow: 0 0 40px rgba(255,0,0,0.9); }
}
/* ì‚¬ìš´ë“œ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ */
#sound-slide {
    position: fixed;
    left: 0;
    bottom: 140px;
    z-index: 1001;
    display: flex;
    align-items: center;
}
#sound-slide-panel {
    background: rgba(0,0,0,0.9);
    border: 1px solid #0ff;
    border-radius: 0 8px 8px 0;
    padding: 6px 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    overflow: hidden;
}
#sound-slide.collapsed #sound-slide-panel {
    width: 0;
    padding: 6px 0;
    border: none;
    opacity: 0;
}
#sound-slide.expanded #sound-slide-panel {
    width: auto;
    opacity: 1;
}
#sound-onoff {
    background: #222;
    border: 1px solid #555;
    color: #666;
    width: 26px; height: 26px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    display: flex;
    align-items: center;
    justify-content: center;
}
#sound-onoff.on { 
    background: #0a4; 
    border-color: #0f0; 
    color: #fff;
    box-shadow: 0 0 8px #0f0;
}
#sound-slider { width: 50px; cursor: pointer; }
#sound-val { color: #aaa; font-size: 0.6em; min-width: 26px; text-align: right; }
#sound-arrow {
    background: rgba(0,0,0,0.9);
    border: 1px solid #0ff;
    width: 22px; height: 34px;
    cursor: pointer;
    color: #0ff;
    border-radius: 0 6px 6px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75em;
    flex-shrink: 0;
}
#sound-arrow:hover { background: rgba(0,255,255,0.1); }
/* ê¸´ê¸‰íƒˆì¶œ ì¶©ì „ í‘œì‹œ */
@keyframes escapeFlash {
    from { background: rgba(255,153,0,0.2); box-shadow: none; }
    to { background: rgba(255,153,0,0.6); box-shadow: 0 0 15px #f90; }
}
</style>

<!-- ì‚¬ìš´ë“œ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ -->
<div id="sound-slide" class="collapsed">
    <div id="sound-slide-panel">
        <button id="sound-onoff" title="ì†Œë¦¬ ì¼œê¸°/ë„ê¸°" data-i18n-title="soundOnOff">ğŸ”‡</button>
        <input type="range" id="sound-slider" min="0" max="100" value="40">
        <span id="sound-val">40%</span>
    </div>
    <div id="sound-arrow">â—€</div>
</div>

<!-- ë§ì›ê²½ ëª¨ë“œ ì˜¤ë²„ë ˆì´ -->
<div id="telescope-overlay" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9000;
    pointer-events: none;
    background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.95) 60%);
">
    <!-- ë§ì›ê²½ ë Œì¦ˆ í”„ë ˆì„ (ì›í˜• ë¹„ë„¤íŒ…) -->
    <div id="telescope-lens" style="
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, 
            transparent 0%, 
            transparent 25%, 
            rgba(0,0,0,0.3) 35%, 
            rgba(0,0,0,0.7) 45%, 
            rgba(0,0,0,0.95) 55%);
        pointer-events: none;
    "></div>
    
    <!-- ì‹­ìì„  ë ˆí‹°í´ -->
    <div id="telescope-reticle" style="
        width: 300px; height: 300px;
        border: 2px solid rgba(255,100,100,0.6);
        border-radius: 50%;
        position: relative;
        box-shadow: 0 0 30px rgba(255,100,100,0.3), inset 0 0 50px rgba(0,0,0,0.5);
    ">
        <div style="position:absolute;top:50%;left:0;right:0;height:1px;background:rgba(255,100,100,0.5);"></div>
        <div style="position:absolute;left:50%;top:0;bottom:0;width:1px;background:rgba(255,100,100,0.5);"></div>
        <!-- ëˆˆê¸ˆì„  -->
        <div style="position:absolute;top:50%;left:10%;width:15%;height:1px;background:rgba(255,100,100,0.3);"></div>
        <div style="position:absolute;top:50%;right:10%;width:15%;height:1px;background:rgba(255,100,100,0.3);"></div>
        <div style="position:absolute;left:50%;top:10%;height:15%;width:1px;background:rgba(255,100,100,0.3);"></div>
        <div style="position:absolute;left:50%;bottom:10%;height:15%;width:1px;background:rgba(255,100,100,0.3);"></div>
        <!-- ì¤‘ì•™ ì  -->
        <div style="position:absolute;top:50%;left:50%;width:6px;height:6px;background:#ff6666;border-radius:50%;transform:translate(-50%,-50%);"></div>
    </div>
    
    <!-- ìƒë‹¨ ì •ë³´ íŒ¨ë„ -->
    <div id="telescope-info-panel" style="
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,20,40,0.9);
        padding: 15px 30px;
        border-radius: 10px;
        border: 1px solid #00aaff;
        color: #00ffff;
        font-family: 'Orbitron', monospace;
        text-align: center;
        pointer-events: auto;
    ">
        <div style="font-size: 18px; margin-bottom: 8px;" data-i18n="telescopeMode">ğŸ”­ ë§ì›ê²½ ëª¨ë“œ</div>
        <div style="display: flex; gap: 30px; font-size: 14px;">
            <span><span data-i18n="zoomLabel">ì¤Œ</span>: <strong id="telescope-zoom-display">1.0</strong>x</span>
            <span><span data-i18n="maxZoomLabel">ìµœëŒ€</span>: <strong id="telescope-max-zoom-display">20</strong>x</span>
            <span id="telescope-target-info" data-i18n="targetNone">íƒ€ê²Ÿ: ì—†ìŒ</span>
        </div>
    </div>
    
    <!-- ìš°ì¸¡ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div id="telescope-control-panel" style="
        position: absolute;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0,20,40,0.95);
        border: 2px solid #00aaff;
        border-radius: 15px;
        padding: 20px;
        pointer-events: auto;
        min-width: 180px;
    ">
        <div style="color:#00ffff;text-align:center;margin-bottom:15px;font-size:16px;font-weight:bold;">ğŸšï¸ <span data-i18n="zoomLabel">ì¤Œ</span></div>
        
        <!-- ì¤Œ í”„ë¦¬ì…‹ ë²„íŠ¼ -->
        <div id="telescope-zoom-presets" style="display:flex;flex-direction:column;gap:8px;margin-bottom:15px;">
            <button class="telescope-preset-btn" data-zoom="1" style="padding:8px;background:#1a3a5c;color:#fff;border:1px solid #00aaff;border-radius:5px;cursor:pointer;">1x</button>
            <button class="telescope-preset-btn" data-zoom="5" style="padding:8px;background:#1a3a5c;color:#fff;border:1px solid #00aaff;border-radius:5px;cursor:pointer;">5x</button>
            <button class="telescope-preset-btn" data-zoom="10" style="padding:8px;background:#1a3a5c;color:#fff;border:1px solid #00aaff;border-radius:5px;cursor:pointer;">10x</button>
            <button class="telescope-preset-btn" data-zoom="20" style="padding:8px;background:#1a3a5c;color:#fff;border:1px solid #00aaff;border-radius:5px;cursor:pointer;">20x</button>
            <button class="telescope-preset-btn locked" data-zoom="30" style="padding:8px;background:#333;color:#888;border:1px solid #555;border-radius:5px;cursor:not-allowed;">ğŸ”’ 30x</button>
            <button class="telescope-preset-btn locked" data-zoom="50" style="padding:8px;background:#333;color:#888;border:1px solid #555;border-radius:5px;cursor:not-allowed;">ğŸ”’ 50x</button>
            <button class="telescope-preset-btn locked" data-zoom="100" style="padding:8px;background:#333;color:#888;border:1px solid #555;border-radius:5px;cursor:not-allowed;">ğŸ”’ 100x</button>
        </div>
        
        <!-- ìŠ¬ë¼ì´ë” -->
        <div style="margin-bottom:15px;">
            <input type="range" id="telescope-zoom-slider" 
                min="1" max="20" value="1" step="0.5"
                style="width:100%;accent-color:#00aaff;">
            <div id="telescope-zoom-value" style="color:#fff;text-align:center;margin-top:5px;font-size:20px;font-weight:bold;">1.0x</div>
        </div>
        
        <!-- ì¥ì°©ëœ ë§ì›ê²½ ì •ë³´ -->
        <div id="telescope-equipped-info" style="
            background: rgba(0,50,100,0.5);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #aaddff;
        ">
            <div style="font-weight:bold;margin-bottom:5px;">ğŸ“¡ <span data-i18n="telescope">ë§ì›ê²½</span></div>
            <div id="telescope-equipped-name" data-i18n="defaultTelescope">ê¸°ë³¸ ë§ì›ê²½ (20x)</div>
        </div>
        
        <!-- ë‹«ê¸° ë²„íŠ¼ -->
        <button id="btn-telescope-close" style="
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        " data-i18n="telescopeExit">âœ• ë§ì›ê²½ ì¢…ë£Œ</button>
    </div>
    
    <!-- ì¢Œì¸¡ í•˜ë‹¨ - ì¡°ì‘ ì•ˆë‚´ -->
    <div style="
        position: absolute;
        bottom: 30px;
        left: 30px;
        background: rgba(0,20,40,0.8);
        padding: 15px;
        border-radius: 10px;
        color: #88ccff;
        font-size: 12px;
        pointer-events: none;
    ">
        <div style="font-weight:bold;margin-bottom:8px;">ğŸ“– ì¡°ì‘ë²•</div>
        <div data-i18n="mouseDrag">ğŸ–±ï¸ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸: ì‹œì  ì´ë™</div>
        <div data-i18n="wheelZoom">ğŸ”„ íœ  ìŠ¤í¬ë¡¤: ì¤Œ ì¡°ì ˆ</div>
        <div data-i18n="escExit">ESC: ë§ì›ê²½ ì¢…ë£Œ</div>
    </div>
</div>

    <div id="top-bar">
        <!-- ë¡œê³  ì œê±°ë¨ -->
        <div class="control-group" style="margin-left: 10px;">
            <select id="lang-select" class="mode-btn" style="padding:5px 8px; cursor:pointer; font-size:11px;">
                <option value="en" selected>ğŸ‡ºğŸ‡¸ English</option>
                <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                <option value="la">ğŸ›ï¸ Latina</option>
            </select>
            <button id="btn-scale-mode" class="mode-btn" data-i18n="distExp" style="font-size:11px; padding:6px 12px;">Dist: Experience</button>
            <button id="btn-reset-solar" class="mode-btn" data-i18n="resetSolarSystem" style="background: linear-gradient(135deg, #ff6b35, #f7931e); border-color: #ff8c00; font-size:11px; padding:6px 12px;">ğŸ”„ íƒœì–‘ê³„ ì´ˆê¸°í™”</button>
            <button id="btn-station" class="mode-btn" data-i18n="station" style="font-size:11px; padding:6px 12px;">ğŸ›°ï¸ ì •ê±°ì¥</button>
            <button id="btn-catalog" class="mode-btn" data-i18n="catalog" style="font-size:11px; padding:6px 12px;">ğŸ“– Catalog</button>
            <button id="btn-fullscreen" class="mode-btn" data-i18n="fullscreen" style="font-size:11px; padding:6px 12px;">â›¶ Fullscreen</button>
            <!-- ëª¨ë°”ì¼ìš© ì‹œê°„ ë°°ì† ë²„íŠ¼ -->
            <div id="mobile-time-controls">
                <button id="time-slower" class="time-btn">âª</button>
                <span id="time-val-mobile">0.1x</span>
                <button id="time-faster" class="time-btn">â©</button>
            </div>
            <!-- ë°ìŠ¤í¬í†±ìš© ìŠ¬ë¼ì´ë” -->
            <div class="slider-container">
                <div class="slider-row">
                    <span class="slider-label" data-i18n="fine">ì •ë°€(0~2x)</span>
                    <input type="range" id="time-slider-fine" min="0" max="2" step="0.1" value="0.1">
                </div>
                <div class="slider-row">
                    <span class="slider-label" data-i18n="fast">ê³ ì†(1~100x)</span>
                    <input type="range" id="time-slider-coarse" min="1" max="100" step="1" value="1">
                </div>
            </div>
            <div id="time-val">0.1x</div>
        </div>
        <!-- ìœ ì € ì •ë³´ ì˜ì—­ -->
        <div id="user-area">
            <!-- â˜…â˜…â˜… ë©€í‹°ëª¨ë“œ ì‚¬ìš©ì í”„ë¡œí•„ (ë¡œê·¸ì¸ í›„ í‘œì‹œ) â˜…â˜…â˜… -->
            <div id="user-profile-panel" style="display:none;">
                <div class="profile-avatar" id="profile-avatar">ğŸ‘¤</div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">User</div>
                    <div class="profile-stats">
                        <span class="stat-item coins">ğŸª™ <span id="profile-coins">0</span></span>
                        <span class="stat-item level">â­ Lv.<span id="profile-level">1</span></span>
                    </div>
                    <div class="profile-exp-bar">
                        <div class="exp-fill" id="profile-exp-fill" style="width: 0%"></div>
                    </div>
                </div>
                <button class="profile-menu-btn" id="profile-menu-btn">â–¼</button>
            </div>
            
            <!-- í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
            <div id="profile-dropdown" style="display:none;">
                <div class="dropdown-item" id="dropdown-profile" data-i18n="myProfile">ğŸ‘¤ My Profile</div>
                <div class="dropdown-item" id="dropdown-missions" data-i18n="dropdownMissions">ğŸ“‹ Mission Board</div>
                <div class="dropdown-item" id="dropdown-settings" data-i18n="dropdownSettings">âš™ï¸ Settings</div>
                <div class="dropdown-item logout" id="dropdown-logout" data-i18n="dropdownLogout">ğŸšª Logout</div>
            </div>
            
            <div id="user-coins" style="display:none;">ğŸª™ <span id="coin-amount">0</span></div>
            <div id="user-info" style="display:none;">
                <span id="user-name">Guest</span>
                <button id="btn-logout" class="mode-btn" data-i18n="logout" onclick="confirmLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <button id="btn-login" class="mode-btn" data-i18n="login" onclick="openAuthUI()">ğŸ” ë¡œê·¸ì¸</button>
        </div>
    </div>
    
    <style>
    /* â˜…â˜…â˜… ì‚¬ìš©ì í”„ë¡œí•„ íŒ¨ë„ ìŠ¤íƒ€ì¼ (ë©€í‹°ëª¨ë“œìš©) â˜…â˜…â˜… */
    #user-profile-panel {
        position: fixed;
        top: 10px;
        right: 10px;  /* ê°€ì¥ ì˜¤ë¥¸ìª½ */
        display: flex;
        align-items: center;
        gap: 10px;
        background: linear-gradient(135deg, rgba(0, 40, 80, 0.95) 0%, rgba(0, 20, 50, 0.98) 100%);
        border: 2px solid rgba(0, 200, 255, 0.4);
        border-radius: 12px;
        padding: 8px 12px;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 1001;
    }
    
    #user-profile-panel:hover {
        border-color: rgba(0, 255, 255, 0.7);
        box-shadow: 0 0 15px rgba(0, 200, 255, 0.3);
    }
    
    .profile-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #1a5276, #2980b9);
        border: 2px solid #00d4ff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        overflow: hidden;
    }
    
    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .profile-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .profile-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 12px;
        color: #fff;
        font-weight: 600;
    }
    
    .profile-stats {
        display: flex;
        gap: 10px;
        font-size: 10px;
    }
    
    .stat-item.coins { color: #ffd700; }
    .stat-item.level { color: #00ff88; }
    
    .profile-exp-bar {
        width: 80px;
        height: 4px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 2px;
        overflow: hidden;
    }
    
    .exp-fill {
        height: 100%;
        background: linear-gradient(90deg, #00d4ff, #00ff88);
        transition: width 0.3s;
    }
    
    .profile-menu-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-size: 10px;
        cursor: pointer;
        padding: 5px;
        transition: color 0.2s;
    }
    
    .profile-menu-btn:hover {
        color: #00d4ff;
    }
    
    /* í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ */
    #profile-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 5px;
        background: linear-gradient(135deg, rgba(10, 30, 50, 0.98) 0%, rgba(5, 15, 30, 0.98) 100%);
        border: 2px solid rgba(0, 200, 255, 0.4);
        border-radius: 10px;
        overflow: hidden;
        min-width: 150px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        z-index: 1001;
    }
    
    .dropdown-item {
        padding: 12px 15px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item:hover {
        background: rgba(0, 200, 255, 0.2);
        color: #fff;
    }
    
    .dropdown-item.logout:hover {
        background: rgba(255, 50, 50, 0.3);
        color: #ff6666;
    }
    
    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
        #user-profile-panel {
            padding: 6px 8px;
            gap: 6px;
        }
        
        .profile-avatar {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }
        
        .profile-name {
            font-size: 10px;
        }
        
        .profile-stats {
            font-size: 9px;
            gap: 6px;
        }
        
        .profile-exp-bar {
            width: 60px;
        }
    }
    </style>

    <div id="nav-container">
        <div id="nav-panel">
            <div class="nav-header" data-i18n="bodyList">ì²œì²´ ëª©ë¡</div>
            <div id="nav-list"></div>
        </div>
        <div id="nav-toggle">â—€</div>
    </div>

    <div id="spawn-dock"></div>
    
    <div id="catalog-modal">
        <h2 style="color:white; margin-bottom:15px;" id="catalog-title" data-i18n="catalogTitle">ğŸŒŒ ì²œì²´ ë„ê° (í´ë¦­í•˜ì—¬ ìƒì„±)</h2>
        <div id="catalog-content"></div>
        <button id="catalog-close" data-i18n="close">ë‹«ê¸°</button>
    </div>
    
    <!-- ì²œì²´ ì •ë³´ ëª¨ë‹¬ (ë©€í‹°ëª¨ë“œìš©) - SF ë””ìì¸ -->
    <div id="body-info-modal" style="
        display: none;
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(5, 15, 30, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(0, 200, 255, 0.3);
        border-radius: 20px;
        padding: 0;
        z-index: 10000;
        min-width: 360px;
        max-width: 90vw;
        max-height: 85vh;
        overflow: hidden;
        color: white;
        font-family: 'Orbitron', 'Rajdhani', sans-serif;
        box-shadow: 
            0 0 60px rgba(0, 150, 255, 0.3),
            inset 0 0 60px rgba(0, 100, 200, 0.05),
            0 25px 50px rgba(0, 0, 0, 0.5);
    ">
        <!-- í—¤ë” ë°” -->
        <div style="
            background: linear-gradient(90deg, rgba(0,100,150,0.8), rgba(0,50,100,0.4));
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 200, 255, 0.2);
        ">
            <h3 id="body-info-name" style="color:#00d4ff; margin:0; font-size: 1.4em; text-shadow: 0 0 20px rgba(0,200,255,0.5);"></h3>
            <button id="body-info-close" style="
                background: rgba(255,100,100,0.2);
                border: 1px solid rgba(255,100,100,0.5);
                color: #ff6b6b;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1.1em;
                transition: all 0.3s;
            " onmouseover="this.style.background='rgba(255,100,100,0.4)'" onmouseout="this.style.background='rgba(255,100,100,0.2)'">âœ•</button>
        </div>
        
        <!-- ìŠ¤í¬ë¡¤ ì»¨í…ì¸  -->
        <div style="padding: 20px; overflow-y: auto; max-height: calc(85vh - 140px);">
            
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div style="
                background: linear-gradient(135deg, rgba(0,80,120,0.3), rgba(0,40,80,0.2));
                border: 1px solid rgba(0,180,255,0.2);
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
                position: relative;
                overflow: hidden;
            ">
                <div style="
                    position: absolute;
                    top: 0; left: 0;
                    width: 4px;
                    height: 100%;
                    background: linear-gradient(180deg, #00d4ff, #0088ff);
                "></div>
                <div style="color:#00d4ff; font-size: 0.8em; margin-bottom: 12px; letter-spacing: 2px; text-transform: uppercase;">
                    <span style="opacity: 0.7;">â–¸</span> <span data-i18n="infoBasicInfo">ê¸°ë³¸ ì •ë³´</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                    <div style="display:flex;justify-content:space-between;"><span style="color:#6aa;" data-i18n="infoType">ìœ í˜•</span> <span id="info-type" style="color:#fff;"></span></div>
                    <div style="display:flex;justify-content:space-between;"><span style="color:#6aa;" data-i18n="bodyRadius">ë°˜ì§€ë¦„</span> <span id="info-radius" style="color:#fff;"></span><span style="color:#6aa;font-size:0.8em;">km</span></div>
                    <div style="display:flex;justify-content:space-between;"><span style="color:#6aa;" data-i18n="bodyMass">ì§ˆëŸ‰</span> <span id="info-mass" style="color:#fff;"></span></div>
                    <div style="display:flex;justify-content:space-between;"><span style="color:#6aa;" data-i18n="infoOrbit">ê³µì „</span> <span id="info-orbit" style="color:#fff;"></span></div>
                    <div style="display:flex;justify-content:space-between;"><span style="color:#6aa;" data-i18n="infoGravity">ì¤‘ë ¥</span> <span id="info-gravity" style="color:#fff;"></span></div>
                    <div style="display:flex;justify-content:space-between;"><span style="color:#6aa;" data-i18n="infoTemp">ê¸°ì˜¨</span> <span id="info-temp" style="color:#fff;"></span></div>
                </div>
            </div>
            
            <!-- í…Œë¼í¬ë° ìƒíƒœ -->
            <div style="
                background: linear-gradient(135deg, rgba(0,100,60,0.3), rgba(0,60,40,0.2));
                border: 1px solid rgba(0,255,150,0.2);
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
                position: relative;
                overflow: hidden;
            ">
                <div style="
                    position: absolute;
                    top: 0; left: 0;
                    width: 4px;
                    height: 100%;
                    background: linear-gradient(180deg, #00ff88, #00aa55);
                "></div>
                <div style="color:#00ff88; font-size: 0.8em; margin-bottom: 12px; letter-spacing: 2px; text-transform: uppercase;">
                    <span style="opacity: 0.7;">â–¸</span> <span data-i18n="terraformingStatus">í…Œë¼í¬ë° ìƒíƒœ</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <div style="flex: 1; height: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; overflow: hidden; border: 1px solid rgba(0,255,150,0.3);">
                        <div id="info-terraform-bar" style="height: 100%; background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff88); width: 0%; transition: width 0.5s; box-shadow: 0 0 10px rgba(0,255,150,0.5);"></div>
                    </div>
                    <span id="info-terraform-percent" style="font-size: 1em; color: #00ff88; font-weight: bold; min-width: 45px; text-align: right;">0%</span>
                </div>
                <div id="info-terraform-status" style="font-size: 0.8em; color: #8ca;"></div>
            </div>
            
            <!-- ì¸í”„ë¼ -->
            <div style="
                background: linear-gradient(135deg, rgba(120,80,0,0.3), rgba(80,50,0,0.2));
                border: 1px solid rgba(255,180,0,0.2);
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
                position: relative;
                overflow: hidden;
            ">
                <div style="
                    position: absolute;
                    top: 0; left: 0;
                    width: 4px;
                    height: 100%;
                    background: linear-gradient(180deg, #ffaa00, #ff6600);
                "></div>
                <div style="color:#ffaa00; font-size: 0.8em; margin-bottom: 12px; letter-spacing: 2px; text-transform: uppercase;">
                    <span style="opacity: 0.7;">â–¸</span> <span data-i18n="infrastructure">ì¸í”„ë¼</span>
                </div>
                <div id="info-infrastructure" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em;"></div>
            </div>
            
            <!-- ìì› -->
            <div style="
                background: linear-gradient(135deg, rgba(100,0,100,0.3), rgba(60,0,80,0.2));
                border: 1px solid rgba(255,100,255,0.2);
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
                position: relative;
                overflow: hidden;
            ">
                <div style="
                    position: absolute;
                    top: 0; left: 0;
                    width: 4px;
                    height: 100%;
                    background: linear-gradient(180deg, #ff66ff, #aa44aa);
                "></div>
                <div style="color:#ff66ff; font-size: 0.8em; margin-bottom: 12px; letter-spacing: 2px; text-transform: uppercase;">
                    <span style="opacity: 0.7;">â–¸</span> ì±„ì·¨ ê°€ëŠ¥ ìì›
                </div>
                <div id="info-resources" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
            </div>
            
            <!-- ì‹ë¯¼ì§€ ì •ë³´ -->
            <div style="
                background: linear-gradient(135deg, rgba(60,60,120,0.3), rgba(40,40,80,0.2));
                border: 1px solid rgba(150,150,255,0.2);
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
                position: relative;
                overflow: hidden;
            ">
                <div style="
                    position: absolute;
                    top: 0; left: 0;
                    width: 4px;
                    height: 100%;
                    background: linear-gradient(180deg, #8888ff, #5555cc);
                "></div>
                <div style="color:#8888ff; font-size: 0.8em; margin-bottom: 12px; letter-spacing: 2px; text-transform: uppercase;">
                    <span style="opacity: 0.7;">â–¸</span> ì‹ë¯¼ì§€ ì •ë³´
                </div>
                <div style="font-size: 0.9em; display: grid; gap: 6px;">
                    <div style="display:flex;justify-content:space-between;"><span style="color:#88a;">ìƒíƒœ</span> <span id="info-colony" style="color:#fff;"></span></div>
                    <div style="display:flex;justify-content:space-between;"><span style="color:#88a;">ì¸êµ¬</span> <span id="info-population" style="color:#fff;"></span></div>
                    <div style="display:flex;justify-content:space-between;"><span style="color:#88a;">ì¸ê³µìœ„ì„±</span> <span><span id="info-satellites"></span><span style="color:#88a;font-size:0.8em;"> ê°œ</span></span></div>
                </div>
            </div>
        </div>
        
        <!-- í•˜ë‹¨ ë²„íŠ¼ -->
        <div style="padding: 15px 20px; border-top: 1px solid rgba(0,200,255,0.2); background: rgba(0,50,80,0.3);">
            <button id="body-info-goto" style="
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #0088ff, #0055cc);
                color: white;
                border: 1px solid rgba(0,150,255,0.5);
                border-radius: 10px;
                cursor: pointer;
                font-size: 0.95em;
                font-family: 'Orbitron', sans-serif;
                font-weight: bold;
                letter-spacing: 1px;
                transition: all 0.3s;
                box-shadow: 0 0 20px rgba(0,100,255,0.3);
            " onmouseover="this.style.boxShadow='0 0 30px rgba(0,150,255,0.6)';this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 0 20px rgba(0,100,255,0.3)';this.style.transform='translateY(0)'">
                ğŸš€ ì„ ì²´ ë³´ê¸°
            </button>
        </div>
    </div>
    </div>

    <div id="msg-box" data-i18n="message">ë©”ì‹œì§€</div>
    <button id="reset-cam" data-i18n="viewAll">ğŸ”­ ì „ì²´ ë³´ê¸°</button>
    
    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="login-modal">
        <div id="login-content">
            <h2 id="login-title">ğŸ” <span data-i18n="login">Login</span></h2>
            <div class="login-tabs">
                <button class="login-tab active" id="tab-login" data-i18n="login">Login</button>
                <button class="login-tab" id="tab-register" data-i18n="register">Register</button>
            </div>
            
            <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… í¼ -->
            <div id="login-form">
                <input type="text" id="input-username" placeholder="ì‚¬ìš©ìëª…" data-placeholder-i18n="username">
                <input type="email" id="input-email" placeholder="ì´ë©”ì¼" style="display:none;" data-placeholder-i18n="email">
                <input type="password" id="input-password" placeholder="ë¹„ë°€ë²ˆí˜¸" data-placeholder-i18n="password">
                <input type="password" id="input-password-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" style="display:none;" data-placeholder-i18n="passwordConfirm">
                
                <!-- ì•½ê´€ ë™ì˜ (íšŒì›ê°€ì… ì‹œì—ë§Œ í‘œì‹œ) -->
                <div id="terms-agree-section" style="display:none; margin: 10px 0; font-size: 11px;">
                    <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="agree-privacy" style="width: 16px; height: 16px;">
                            <span><a href="privacy.html" target="_blank" style="color: #0ff;" data-i18n="privacyPolicy">Privacy Policy</a> <span data-i18n="agreeToTerms">- I agree</span></span>
                        </label>
                    </div>
                    <div>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="agree-terms" style="width: 16px; height: 16px;">
                            <span><a href="terms.html" target="_blank" style="color: #0ff;" data-i18n="termsOfService">Terms of Service</a> <span data-i18n="agreeToTerms">- I agree</span></span>
                        </label>
                    </div>
                </div>
                
                <div id="login-error"></div>
                <div id="login-success"></div>
                <button id="btn-login-submit" class="login-submit" data-i18n="login">ë¡œê·¸ì¸</button>
                <div class="login-find-links" id="find-links">
                    <a id="link-find-id" data-i18n="findId">ì•„ì´ë”” ì°¾ê¸°</a>
                    <span style="color:#555;">|</span>
                    <a id="link-find-pw" data-i18n="findPassword">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
                </div>
            </div>
            
            <!-- ì•„ì´ë”” ì°¾ê¸° í¼ -->
            <div id="find-id-form" style="display:none;">
                <p style="color:#aaa; font-size:12px; margin-bottom:15px; text-align:center;" data-i18n="enterRegisteredEmail">ê°€ì…í•  ë•Œ ë“±ë¡í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”</p>
                <input type="email" id="find-id-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" data-placeholder-i18n="emailAddress">
                <div id="find-id-error" style="color:#e74c3c; font-size:12px; min-height:18px; text-align:center;"></div>
                <div id="find-id-result" class="find-result" style="display:none;">
                    <div class="label" data-i18n="foundId">ì°¾ì€ ì•„ì´ë””</div>
                    <div class="value" id="found-username"></div>
                </div>
                <button id="btn-find-id" class="login-submit" data-i18n="findIdBtn">ì•„ì´ë”” ì°¾ê¸°</button>
                <button class="back-to-login" id="back-from-find-id" data-i18n="backToLoginBtn">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
            
            <!-- ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í¼ -->
            <div id="find-pw-form" style="display:none;">
                <p style="color:#aaa; font-size:12px; margin-bottom:15px; text-align:center;" data-i18n="enterIdAndEmailDesc">ì•„ì´ë””ì™€ ë“±ë¡ëœ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”</p>
                <input type="text" id="find-pw-username" placeholder="ì‚¬ìš©ìëª…" data-placeholder-i18n="username">
                <input type="email" id="find-pw-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" data-placeholder-i18n="emailAddress">
                <div id="find-pw-error" style="color:#e74c3c; font-size:12px; min-height:18px; text-align:center;"></div>
                <div id="find-pw-result" class="find-result" style="display:none;">
                    <div class="label" data-i18n="newPasswordSetMsg">ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤</div>
                    <div class="value" id="new-password"></div>
                    <p style="color:#888; font-size:10px; margin-top:8px;" data-i18n="changePasswordNote">ë¡œê·¸ì¸ í›„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”</p>
                </div>
                <button id="btn-find-pw" class="login-submit" data-i18n="resetPasswordBtn">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
                <button class="back-to-login" id="back-from-find-pw" data-i18n="backToLoginBtn">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
            
            <button id="login-close">âœ•</button>
        </div>
    </div>
    
    <!-- ì •ê±°ì¥ ì„ íƒ ëª¨ë‹¬ -->
    <div id="station-modal">
        <div id="station-modal-content">
            <button id="station-close">âœ•</button>
            <h2 data-i18n="selectStation">ğŸ›¸ ì •ê±°ì¥ ì„ íƒ</h2>
            <div class="station-category">
                <h3 data-i18n="orbitalStations">ğŸ“ ê¶¤ë„ ì •ê±°ì¥</h3>
                <div class="station-list" id="planet-stations"></div>
            </div>
            <div class="station-category">
                <h3 data-i18n="fuelDepots">â›½ ì—°ë£Œ ë³´ê¸‰ì†Œ</h3>
                <div class="station-list" id="fuel-stations"></div>
            </div>
        </div>
    </div>
    
    <!-- ì—°ë£Œ ì¶©ì „ íŒ¨ë„ -->
    <div id="refuel-panel">
        <h3 data-i18n="refueling">â›½ ì—°ë£Œ ì¶©ì „ ì¤‘...</h3>
        <div id="refuel-bar">
            <div id="refuel-progress"></div>
        </div>
        <div id="refuel-text">0/100</div>
    </div>
    
    <!-- í¬ì»¤ìŠ¤ ì²œì²´ ê±°ë¦¬ í‘œì‹œ -->
    <div id="focus-distance-panel">
        <div id="focus-target-name">---</div>
        <div id="focus-distance-value">--- km</div>
    </div>

    <div id="chat-toggle">ğŸ’¬</div>
    <div id="chat-panel">
        <div id="chat-header">
            <span data-i18n="spaceKnowledgeGuide">ğŸ›¸ ìš°ì£¼ ì§€ì‹ ê°€ì´ë“œ</span>
            <span id="chat-close">Ã—</span>
        </div>
        <div id="chat-messages">
            <div class="msg ai" data-i18n="aiWelcome">ì•ˆë…•í•˜ì„¸ìš”! ì²œì²´ë¼ë¦¬ ì¶©ëŒí•˜ë©´ í¡ìˆ˜ë˜ë©°, ì§ˆëŸ‰ì´ 100ì„ ë„˜ìœ¼ë©´ ë³„(í•­ì„±)ì´ ë©ë‹ˆë‹¤.</div>
        </div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." data-placeholder-i18n="enterQuestion">
            <button id="chat-send">â¤</button>
        </div>
    </div>

    <div id="canvas-container"></div>

    <!-- ìš°ì£¼ì„  íƒ‘ìŠ¹ ë²„íŠ¼ -->
    <button id="board-ship-btn" data-i18n="boardShip">ğŸš€ ìš°ì£¼ì„  íƒ‘ìŠ¹</button>
    
    <!-- â˜…â˜…â˜… ìš´í•­ì¤‘ ìš°ì£¼ì„  íŒì—… â˜…â˜…â˜… -->
    <div id="active-ship-popup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; justify-content:center; align-items:center; overflow-y:auto; padding:20px 0;">
        <div style="background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border:2px solid #4fc3f7; border-radius:20px; padding:30px; max-width:400px; width:90%; max-height:85vh; overflow-y:auto; margin:auto; text-align:center; box-shadow:0 0 30px rgba(79,195,247,0.3); position:relative;">
            <div id="active-ship-icon" style="width:80px; height:80px; margin:0 auto 15px; border-radius:12px; background:#0a1628; border:2px solid #4fc3f7; display:flex; justify-content:center; align-items:center; overflow:hidden;">
                <span style="font-size:40px;">ğŸš€</span>
            </div>
            <h2 id="active-ship-title" style="color:#4fc3f7; margin:0 0 20px 0; font-size:20px;">Active Ship Found!</h2>
            <div id="active-ship-info" style="background:rgba(0,0,0,0.3); border-radius:10px; padding:15px; margin-bottom:20px; text-align:left;">
                <div style="color:#fff; font-size:18px; margin-bottom:10px;" id="active-ship-name">Interceptor</div>
                <div style="color:#aaa; font-size:14px;">
                    <div style="margin-bottom:5px;"><span id="active-ship-fuel-label">â›½ Fuel:</span> <span id="active-ship-fuel" style="color:#4fc3f7;">20%</span></div>
                    <div><span id="active-ship-dist-label">ğŸ“ From ISS:</span> <span id="active-ship-dist" style="color:#4fc3f7;">11,176km</span></div>
                </div>
            </div>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button id="active-ship-go-btn" style="flex:1; padding:15px 20px; background:linear-gradient(135deg,#4fc3f7,#2196f3); border:none; border-radius:10px; color:#fff; font-size:16px; font-weight:bold; cursor:pointer;">
                    ğŸ“ Go to Ship
                </button>
                <button id="active-ship-new-btn" style="flex:1; padding:15px 20px; background:linear-gradient(135deg,#e74c3c,#c0392b); border:none; border-radius:10px; color:#fff; font-size:16px; font-weight:bold; cursor:pointer;">
                    ğŸ—‘ï¸ New Ship
                </button>
            </div>
            <button id="active-ship-close-btn" style="position:absolute; top:15px; right:15px; background:none; border:none; color:#888; font-size:24px; cursor:pointer;">âœ•</button>
        </div>
    </div>
    
    <!-- ìš°ì£¼ì„  ìœ„ì¹˜ ë§ˆì»¤ (ë§µì— í‘œì‹œ) -->
    <div id="ship-location-marker" style="display:none; position:fixed; z-index:1000; cursor:pointer;" onclick="focusOnParkedShip()">
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div id="ship-marker-box" style="width:60px; height:60px; border-radius:10px; background:#0a1628; border:2px solid #00ff00; box-shadow:0 0 15px rgba(0,255,0,0.5); display:flex; justify-content:center; align-items:center; overflow:hidden;">
                <span style="font-size:30px;">ğŸš€</span>
            </div>
            <div style="width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-top:15px solid #00ff00; margin-top:-2px;"></div>
            <div id="ship-marker-name" style="color:#00ff00; font-size:12px; font-weight:bold; text-shadow:0 0 5px #000; margin-top:5px; white-space:nowrap;"></div>
        </div>
    </div>
    
    <!-- ìš°ì£¼ì„  ì„ íƒ ëª¨ë‹¬ -->
    <div id="ship-select-modal">
        <div id="ship-select-content">
            <h2 data-i18n="selectShip">ğŸš€ ìš°ì£¼ì„  ì„ íƒ</h2>
            <div id="ship-list"></div>
            <div id="ship-detail">
                <div id="ship-preview"></div>
                <div id="ship-info">
                    <h3 id="ship-detail-name" data-i18n="shuttle">ì…”í‹€</h3>
                    <p id="ship-detail-desc" data-i18n="shuttleDesc">ê¸°ë³¸í˜• ì™•ë³µì„ </p>
                    <div id="ship-price-display">
                        <span class="price-label">ğŸª™</span>
                        <span id="ship-price-value">500</span>
                        <span id="ship-owned-badge" style="display:none;" data-i18n="owned">ë³´ìœ ì¤‘</span>
                    </div>
                    <div id="ship-stats">
                        <div class="stat-row"><span data-i18n="maxSpeed">ìµœëŒ€ ì†ë„</span><div class="stat-bar"><div class="stat-fill speed"></div></div><span class="stat-val" id="stat-speed">75 km/s</span></div>
                        <div class="stat-row"><span data-i18n="accelStat">ê°€ì†ë ¥</span><div class="stat-bar"><div class="stat-fill accel"></div></div><span class="stat-val" id="stat-accel">1.0</span></div>
                        <div class="stat-row"><span data-i18n="turnRate">ì„ íšŒë ¥</span><div class="stat-bar"><div class="stat-fill turn"></div></div><span class="stat-val" id="stat-turn">0.125</span></div>
                        <div class="stat-row"><span data-i18n="fuel">ì—°ë£Œ</span><div class="stat-bar"><div class="stat-fill fuel"></div></div><span class="stat-val" id="stat-fuel">250</span></div>
                    </div>
                    <div id="ship-special"></div>
                </div>
            </div>
            <div id="ship-select-buttons">
                <button id="btn-armory" class="ship-modal-btn armory" data-i18n="armory">âš”ï¸ ë¬´ì¥</button>
                <button id="btn-buy-ship" class="ship-modal-btn buy" style="display:none;" data-i18n="buy">ğŸª™ êµ¬ë§¤</button>
                <button id="btn-select-ship" class="ship-modal-btn confirm" data-i18n="launch">ì¶œê²©</button>
                <button id="btn-cancel-ship" class="ship-modal-btn cancel" data-i18n="cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <!-- í•¨ì„  ì²˜ë¶„ í™•ì¸ ëª¨ë‹¬ -->
    <div id="sell-ship-modal">
        <div id="sell-ship-content">
            <h2>âš ï¸ <span data-i18n="sellShipTitle">í•¨ì„  ì²˜ë¶„</span></h2>
            <p id="sell-ship-message"></p>
            <div id="sell-ship-info">
                <div class="sell-info-row">
                    <span data-i18n="currentShip">í˜„ì¬ í•¨ì„ :</span>
                    <span id="sell-current-ship" data-i18n="shuttle">ì…”í‹€</span>
                </div>
                <div class="sell-info-row">
                    <span data-i18n="sellPrice">ì²˜ë¶„ ê°€ê²© (50%):</span>
                    <span id="sell-price-value">ğŸª™ 250</span>
                </div>
            </div>
            <div id="sell-ship-buttons">
                <button id="btn-sell-confirm" class="ship-modal-btn sell">ğŸ’° <span data-i18n="sellAndBoard">ì²˜ë¶„ í›„ íƒ‘ìŠ¹</span></button>
                <button id="btn-sell-cancel" class="ship-modal-btn cancel" data-i18n="cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ë¬´ì¥ ëª¨ë‹¬ -->
    <div id="armory-modal">
        <div id="armory-content">
            <h2 data-i18n="armorySystem">âš”ï¸ ë¬´ì¥ ì‹œìŠ¤í…œ</h2>
            <div class="armory-tabs">
                <button class="armory-tab active" data-tab="weapons">ğŸ”« ë¬´ê¸°</button>
                <button class="armory-tab" data-tab="armors">ğŸ›¡ï¸ ì¥ê°‘</button>
            </div>
            <!-- â˜… ì ì¬ëŸ‰ ë°” -->
            <div id="armory-capacity-bar" style="margin: 10px 0; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                    <span>ğŸ“¦ ì ì¬ëŸ‰</span>
                    <span id="armory-capacity-text">0 / 100</span>
                </div>
                <div style="background: #333; border-radius: 3px; height: 8px; overflow: hidden;">
                    <div id="armory-capacity-fill" style="background: linear-gradient(90deg, #27ae60, #2ecc71); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
            <div class="armory-main">
                <div class="armory-list-container">
                    <div id="armory-list" class="armory-list"></div>
                </div>
                <div class="armory-detail">
                    <div class="armory-equipped-section">
                        <div class="armory-equipped-title">ğŸ“¦ Equipped</div>
                        <div id="armory-equipped-slots"></div>
                    </div>
                    <div class="armory-detail-icon" id="armory-detail-icon">ğŸ”«</div>
                    <h3 id="armory-detail-name" data-i18n="selectWeapon">Select Weapon</h3>
                    <div class="armory-detail-desc" id="armory-detail-desc" data-i18n="selectWeaponDesc">Select a weapon</div>
                    <div class="armory-detail-stats" id="armory-detail-stats"></div>
                    <div class="armory-detail-effect" id="armory-detail-effect" style="display:none;"></div>
                    <div id="armory-detail-price" style="text-align:center; margin-bottom: 10px;"></div>
                    <div class="armory-buttons">
                        <button id="btn-armory-buy" class="ship-modal-btn buy" style="display:none;" data-i18n="buy">ğŸª™ Buy</button>
                        <button id="btn-armory-equip" class="ship-modal-btn confirm" style="display:none;">Equip</button>
                        <button id="btn-armory-unequip" class="ship-modal-btn cancel" style="display:none;">Unequip</button>
                    </div>
                </div>
            </div>
            <div class="armory-buttons" style="margin-top: 15px;">
                <button id="btn-armory-close" class="ship-modal-btn cancel" data-i18n="close">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- â˜…â˜…â˜… ì¡°ì¢…ì„ ëª¨ë“œ ìš°ì¸¡ í†µì¼ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ â˜…â˜…â˜… -->
    <div id="pilot-right-btns">
        <button id="ui-settings-btn" class="pilot-unified-btn" title="UI Settings">âš™ï¸</button>
        <button id="radio-btn-unified" class="pilot-unified-btn" title="Radio">ğŸ“»</button>
        <button id="ad-btn-unified" class="pilot-unified-btn" title="Ad Rewards">ğŸ“‹</button>
        <button id="ssil-btn-unified" class="pilot-unified-btn" title="SSIL Mission">ğŸš€</button>
    </div>

    <!-- â˜…â˜…â˜… ëª¨ë°”ì¼ ë°œì‚¬/ì—­ì¶”ì§„ ë²„íŠ¼ (í•­ìƒ í‘œì‹œ) â˜…â˜…â˜… -->
    <div id="mobile-combat-btns">
        <button id="mobile-fire-btn-new" class="mobile-combat-btn fire" title="Fire">ğŸ”¥</button>
        <button id="mobile-brake-btn-new" class="mobile-combat-btn brake" title="Emergency Brake">â¹ï¸</button>
    </div>

    <script>
    // â˜…â˜…â˜… ì¡°ì¢…ì„ í†µì¼ ë²„íŠ¼ ì´ˆê¸°í™” â˜…â˜…â˜…
    (function() {
        // ì„¤ì • ë²„íŠ¼
        var settingsBtn = document.getElementById('ui-settings-btn');
        var panel = document.getElementById('ui-settings-panel');
        if (settingsBtn) {
            settingsBtn.onclick = function(e) {
                e.stopPropagation();
                if (panel) {
                    panel.classList.toggle('open');
                }
            };
        }

        // ë¼ë””ì˜¤ ë²„íŠ¼
        var radioBtn = document.getElementById('radio-btn-unified');
        if (radioBtn) {
            radioBtn.onclick = function(e) {
                e.stopPropagation();
                var radioPanel = document.getElementById('cockpit-radio');
                if (radioPanel) {
                    radioPanel.classList.toggle('collapsed');
                    // íŒ¨ë„ ì—´ë¦¼ ì‹œ ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
                    if (!radioPanel.classList.contains('collapsed')) {
                        radioBtn.classList.add('active');
                    } else {
                        radioBtn.classList.remove('active');
                    }
                }
            };
        }

        // ê´‘ê³  ë³´ìƒ ë²„íŠ¼
        var adBtn = document.getElementById('ad-btn-unified');
        if (adBtn) {
            adBtn.onclick = function(e) {
                e.stopPropagation();
                var adModal = document.getElementById('ad-modal-menu');
                if (adModal) {
                    adModal.style.display = adModal.style.display === 'flex' ? 'none' : 'flex';
                }
            };
        }

        // SSIL ë¯¸ì…˜ ë²„íŠ¼
        var ssilBtn = document.getElementById('ssil-btn-unified');
        if (ssilBtn) {
            ssilBtn.onclick = function(e) {
                e.stopPropagation();
                if (typeof openMissionPanel === 'function') {
                    openMissionPanel();
                } else {
                    var ssilPanel = document.getElementById('ssil-mission-panel');
                    if (ssilPanel) {
                        ssilPanel.classList.toggle('open');
                    }
                }
            };
        }
    })();
    </script>

    <!-- UI ì„¤ì • íŒ¨ë„ -->
    <div id="ui-settings-panel">
        <button id="ui-settings-close" onclick="this.parentElement.classList.remove('open');">âœ•</button>
        <h3 data-i18n="uiSettings">ğŸ›ï¸ UI ì„¤ì •</h3>
        
        <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:15px;">
            <button class="ui-preset-btn" id="ui-rearrange-mode" style="background:linear-gradient(135deg,#9b59b6,#8e44ad);" data-i18n="uiReposition" onclick="document.getElementById('ui-settings-panel').classList.remove('open'); if(window.uiRearrangeSystem) uiRearrangeSystem.start();">
                ğŸ”§ UI ì¬ë°°ì¹˜ ëª¨ë“œ
            </button>
            <p style="font-size:10px;color:#888;text-align:center;margin:0;" data-i18n="uiDragToMove">
                ì¬ë°°ì¹˜ ëª¨ë“œì—ì„œ UIë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì´ë™
            </p>
        </div>
        
        <div class="ui-slots-container">
            <div class="ui-slots-title" data-i18n="saveSlots">ğŸ’¾ ì €ì¥ ìŠ¬ë¡¯</div>
            <div id="ui-slots-list">
                <!-- ìŠ¬ë¡¯ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>
        
        <button class="ui-preset-btn danger" id="ui-reset-default" data-i18n="resetDefault" onclick="if(window.draggableUISystem) draggableUISystem.resetToDefault(); document.getElementById('ui-settings-panel').classList.remove('open');">ğŸ”„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹</button>
    </div>

    <!-- UI ì¬ë°°ì¹˜ ëª¨ë“œ ì˜¤ë²„ë ˆì´ -->
    <div id="ui-rearrange-overlay">
        <div class="rearrange-header">
            <span data-i18n="uiReposition">ğŸ”§ UI ì¬ë°°ì¹˜ ëª¨ë“œ</span>
            <span style="font-size:12px;color:#aaa;" data-i18n="uiDragToMove">UIë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì´ë™í•˜ì„¸ìš”</span>
        </div>
        <button id="ui-rearrange-done" data-i18n="done" onclick="if(window.uiRearrangeSystem) uiRearrangeSystem.stop();">âœ“ ì™„ë£Œ</button>
    </div>

    <!-- ì¡°ì¢…ì„ HUD -->
    <!-- ì¡°ì¢…ì‹¤ ë¼ë””ì˜¤ íŒ¨ë„ -->
    <div id="cockpit-radio" class="collapsed draggable-ui">
        <button class="radio-toggle" id="radio-toggle-btn">ğŸ“»</button>
        <div class="radio-content">
            <div class="radio-header">
                <div class="radio-title" data-i18n="spaceRadio">ğŸ›¸ ìš°ì£¼ ë¼ë””ì˜¤</div>
                <button id="radio-close-btn" class="radio-close-btn">âœ•</button>
            </div>
            <div class="radio-station" data-url="https://ice.somafm.com/spacestation" data-name="Space Station Soma">
                <div class="radio-station-name" data-i18n="spaceStation">ğŸš€ ìš°ì£¼ ì •ê±°ì¥</div>
                <div class="radio-station-desc">Spaced-out ambient electronica</div>
            </div>
            <div class="radio-station" data-url="https://ice.somafm.com/deepspaceone" data-name="Deep Space One">
                <div class="radio-station-name">ğŸŒŒ Deep Space One</div>
                <div class="radio-station-desc">Deep ambient space music</div>
            </div>
            <div class="radio-station" data-url="https://ice.somafm.com/dronezone" data-name="Drone Zone">
                <div class="radio-station-name">ğŸ§ Drone Zone</div>
                <div class="radio-station-desc">Atmospheric textures</div>
            </div>
            <div class="radio-station" data-url="https://ice.somafm.com/groovesalad" data-name="Groove Salad">
                <div class="radio-station-name">ğŸ¥— Groove Salad</div>
                <div class="radio-station-desc">Ambient downtempo beats</div>
            </div>
            <div class="radio-station" data-url="https://ice.somafm.com/defcon" data-name="DEF CON Radio">
                <div class="radio-station-name">ğŸ’» DEF CON</div>
                <div class="radio-station-desc">Music for Hacking</div>
            </div>
            <div class="radio-volume">
                <span>ğŸ”Š</span>
                <input type="range" id="radio-volume" min="0" max="100" value="30">
                <span id="radio-vol-val">30%</span>
            </div>
            <div class="radio-now-playing" id="radio-now-playing" data-i18n="selectChannel">ğŸ“¡ Select a channel</div>
        </div>
    </div>

    <div id="cockpit-hud">
        <!-- ì½•í• í”„ë ˆì„ (1ì¸ì¹­ ë·°) -->
        <div id="cockpit-frame">
            <div class="cockpit-strut left"></div>
            <div class="cockpit-strut right"></div>
            <div class="cockpit-strut top"></div>
            <div class="cockpit-side-panel left"></div>
            <div class="cockpit-side-panel right"></div>
            <div id="cockpit-dashboard"></div>
            <div class="cockpit-indicator left"></div>
            <div class="cockpit-indicator right"></div>
        </div>
        <div id="pilot-top-bar">
            <div class="pilot-info-panel" id="status-panel" style="border-color:#0f0;display:none;"><div class="pilot-info-label" style="color:#0f0;" data-i18n="status">ìƒíƒœ</div><div class="pilot-info-value" id="info-status" style="color:#0f0;">ì •ìƒ</div></div>
            <button class="pilot-info-panel ability-btn" id="btn-ability" style="display:none;"><span id="ability-icon">âš¡</span><span id="ability-name">íŠ¹ìˆ˜ëŠ¥ë ¥</span><span id="ability-cooldown"></span></button>
        </div>
        
        <!-- â˜… í™”ë©´ ì¤‘ì•™ ë„í‚¹ ë²„íŠ¼ -->
        <button id="docking-center-btn" data-i18n="docking">ğŸ”— ë„í‚¹</button>
        
        <!-- â˜… ë„í‚¹ ì™„ë£Œ í›„ ë©”ë‰´ -->
        <div id="docking-menu">
            <button class="docking-menu-btn" id="btn-refuel-menu" data-i18n="refuelMenu">â›½ ì—°ë£Œ ë³´ì¶©</button>
            <button class="docking-menu-btn repair" id="btn-repair-menu">ğŸ”§ ì„ ì²´ ìˆ˜ë¦¬</button>
            <button class="docking-menu-btn shop" id="btn-station-shop" style="background: linear-gradient(135deg, #f39c12, #e67e22);">ğŸ›’ ìƒì </button>
            <button class="docking-menu-btn interior" id="btn-station-interior">ğŸ  ì •ê±°ì¥ ë‚´ë¶€</button>
        </div>
        
        <!-- â˜…â˜…â˜… ì •ê±°ì¥ ìƒì  ëª¨ë‹¬ â˜…â˜…â˜… -->
        <div id="station-shop-modal" style="
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        ">
            <div style="
                background: linear-gradient(135deg, #0a1628, #1a2d4a);
                border: 2px solid #f39c12;
                border-radius: 20px;
                padding: 30px;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                color: white;
                font-family: 'Orbitron', sans-serif;
            ">
                <h2 style="text-align: center; color: #f39c12; margin-bottom: 25px;">ğŸ›’ ì •ê±°ì¥ ìƒì </h2>
                
                <!-- ë³´ìœ  ì½”ì¸ í‘œì‹œ -->
                <div style="text-align: center; margin-bottom: 20px; font-size: 18px;">
                    ğŸª™ ë³´ìœ  ì½”ì¸: <span id="shop-user-coins" style="color: #f39c12; font-weight: bold;">0</span>
                </div>
                
                <!-- íƒ­ ë©”ë‰´ -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                    <button class="shop-tab-btn active" data-tab="telescope" style="padding: 10px 20px; background: #f39c12; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”­ ë§ì›ê²½</button>
                    <button class="shop-tab-btn" data-tab="equipment" style="padding: 10px 20px; background: #333; color: #aaa; border: none; border-radius: 8px; cursor: pointer;">ğŸ› ï¸ ì¥ë¹„</button>
                    <button class="shop-tab-btn" data-tab="consumables" style="padding: 10px 20px; background: #333; color: #aaa; border: none; border-radius: 8px; cursor: pointer;">ğŸ“¦ ì†Œëª¨í’ˆ</button>
                </div>
                
                <!-- ë§ì›ê²½ íƒ­ -->
                <div id="shop-tab-telescope" class="shop-tab-content">
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- ê¸°ë³¸ ë§ì›ê²½ -->
                        <div class="shop-item" data-item="basic" style="
                            background: rgba(46, 204, 113, 0.2);
                            border: 2px solid #2ecc71;
                            border-radius: 12px;
                            padding: 15px;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                        ">
                            <div style="font-size: 40px;">ğŸ”­</div>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: bold; color: #2ecc71;">ê¸°ë³¸ ë§ì›ê²½</div>
                                <div style="font-size: 12px; color: #aaa;">20ë°° ì¤Œ | ê¸°ë³¸ ì¥ì°©</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #2ecc71; font-weight: bold;">âœ… ë³´ìœ ì¤‘</div>
                                <button class="shop-equip-btn" data-telescope="basic" style="margin-top: 5px; padding: 5px 15px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer;">ì¥ì°©</button>
                            </div>
                        </div>
                        
                        <!-- í‘œì¤€ ë§ì›ê²½ (30x) - ìƒˆë¡œ ì¶”ê°€ -->
                        <div class="shop-item" data-item="standard" style="
                            background: rgba(241, 196, 15, 0.2);
                            border: 2px solid #f1c40f;
                            border-radius: 12px;
                            padding: 15px;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                        ">
                            <div style="font-size: 40px;">ğŸ”­</div>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: bold; color: #f1c40f;">í‘œì¤€ ë§ì›ê²½</div>
                                <div style="font-size: 12px; color: #aaa;">30ë°° ì¤Œ | í–¥ìƒëœ ì„±ëŠ¥</div>
                            </div>
                            <div id="shop-standard-status" style="text-align: right;">
                                <div style="color: #f39c12; font-weight: bold;">ğŸª™ 2,000</div>
                                <button class="shop-buy-btn" data-telescope="standard" data-price="2000" style="margin-top: 5px; padding: 5px 15px; background: #f39c12; color: white; border: none; border-radius: 5px; cursor: pointer;">êµ¬ë§¤</button>
                            </div>
                        </div>
                        
                        <!-- ê³ ê¸‰ ë§ì›ê²½ -->
                        <div class="shop-item" data-item="advanced" style="
                            background: rgba(52, 152, 219, 0.2);
                            border: 2px solid #3498db;
                            border-radius: 12px;
                            padding: 15px;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                        ">
                            <div style="font-size: 40px;">ğŸ”­</div>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: bold; color: #3498db;">ê³ ê¸‰ ë§ì›ê²½</div>
                                <div style="font-size: 12px; color: #aaa;">50ë°° ì¤Œ | ì„ ëª…í•œ í™”ì§ˆ</div>
                            </div>
                            <div id="shop-advanced-status" style="text-align: right;">
                                <div style="color: #f39c12; font-weight: bold;">ğŸª™ 5,000</div>
                                <button class="shop-buy-btn" data-telescope="advanced" data-price="5000" style="margin-top: 5px; padding: 5px 15px; background: #f39c12; color: white; border: none; border-radius: 5px; cursor: pointer;">êµ¬ë§¤</button>
                            </div>
                        </div>
                        
                        <!-- ì „ë¬¸ê°€ ë§ì›ê²½ -->
                        <div class="shop-item" data-item="professional" style="
                            background: rgba(155, 89, 182, 0.2);
                            border: 2px solid #9b59b6;
                            border-radius: 12px;
                            padding: 15px;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                        ">
                            <div style="font-size: 40px;">ğŸ”­</div>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: bold; color: #9b59b6;">ì „ë¬¸ê°€ ë§ì›ê²½</div>
                                <div style="font-size: 12px; color: #aaa;">100ë°° ì¤Œ | ìµœê³  ì„±ëŠ¥</div>
                            </div>
                            <div id="shop-professional-status" style="text-align: right;">
                                <div style="color: #f39c12; font-weight: bold;">ğŸª™ 15,000</div>
                                <button class="shop-buy-btn" data-telescope="professional" data-price="15000" style="margin-top: 5px; padding: 5px 15px; background: #f39c12; color: white; border: none; border-radius: 5px; cursor: pointer;">êµ¬ë§¤</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì¥ë¹„ íƒ­ (ì¤€ë¹„ì¤‘) -->
                <div id="shop-tab-equipment" class="shop-tab-content" style="display: none;">
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 50px; margin-bottom: 15px;">ğŸ”§</div>
                        <div data-i18n="equipmentShopPreparing">ì¥ë¹„ ìƒì  ì¤€ë¹„ì¤‘...</div>
                    </div>
                </div>
                
                <!-- ì†Œëª¨í’ˆ íƒ­ (ì¤€ë¹„ì¤‘) -->
                <div id="shop-tab-consumables" class="shop-tab-content" style="display: none;">
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 50px; margin-bottom: 15px;">ğŸ“¦</div>
                        <div data-i18n="consumablesShopPreparing">ì†Œëª¨í’ˆ ìƒì  ì¤€ë¹„ì¤‘...</div>
                    </div>
                </div>
                
                <!-- ë‹«ê¸° ë²„íŠ¼ -->
                <button id="btn-close-shop" data-i18n="closeBtn" style="
                    margin-top: 20px;
                    width: 100%;
                    padding: 15px;
                    background: linear-gradient(135deg, #c0392b, #e74c3c);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 16px;
                    cursor: pointer;
                ">âœ• ë‹«ê¸°</button>
            </div>
        </div>
        
        <!-- â˜…â˜…â˜… ìˆ˜ë¦¬ ì˜¤ë²„ë ˆì´ â˜…â˜…â˜… -->
        <div id="repair-overlay">
            <div class="repair-title">ğŸ”§ ì„ ì²´ ìˆ˜ë¦¬ ì¤‘...</div>
            <div class="repair-bar-container">
                <div class="repair-bar-fill" id="repair-bar-fill"></div>
            </div>
            <div class="repair-amount" id="repair-amount">0/100</div>
            <div class="repair-cost" id="repair-cost">Cost: 0 coins</div>
        </div>
        
        <!-- â˜…â˜…â˜… ë³´í˜¸ë§‰ ì¶©ëŒ ì´í™íŠ¸ â˜…â˜…â˜… -->
        <div id="shield-impact-overlay"></div>
        
        <!-- â˜… ë„í‚¹í•´ì œ ë²„íŠ¼ -->
        <button id="undock-btn" data-i18n="undock">ğŸš€ Undock</button>
        
        <!-- â˜… ì—°ë£Œ ë³´ê¸‰ ì˜¤ë²„ë ˆì´ -->
        <div id="refuel-overlay">
            <div class="refuel-title" data-i18n="refuelingProgress">â›½ ì—°ë£Œ ë³´ê¸‰ ì¤‘...</div>
            <div class="refuel-bar-container">
                <div class="refuel-bar-fill" id="refuel-bar-fill"></div>
            </div>
            <div class="refuel-amount" id="refuel-amount">0/100</div>
            <div class="refuel-cost" id="refuel-cost">Cost: 0 coins</div>
        </div>
        <div id="pilot-target-select"><select id="ship-target-select"><option value="" data-i18n="navTargetSelect">ğŸ¯ Select Navigation Target...</option></select></div>
        
        <!-- â˜…â˜…â˜… 3D ì¢Œí‘œ í‘œì‹œ íŒ¨ë„ â˜…â˜…â˜… -->
        <div id="pilot-coords-panel">
            <div class="coords-label" data-i18n="currentCoords">ğŸ“ Current Coordinates</div>
            <div class="coords-value" id="pilot-coords-display">X: 0 | Y: 0 | Z: 0</div>
        </div>
        
        <div id="pilot-eta-box">
            <div class="eta-label" data-i18n="eta">ETA</div>
            <div class="eta-time" id="eta-time-display">--:--:--</div>
            <div class="eta-target" id="eta-target-name">Target: ---</div>
        </div>
        <div id="pilot-warning-panel">
            <div class="pilot-warning" id="warn-collision" data-i18n="collisionWarning">âš ï¸ Collision Warning!</div>
            <div class="pilot-warning" id="warn-fuel" data-i18n="lowFuel">âš ï¸ Low Fuel!</div>
            <div class="pilot-warning hull-critical" id="warn-hull" data-i18n="hullDamage">âš ï¸ Hull Damage!</div>
            <div class="pilot-warning caution decel" id="warn-decel" data-i18n="autoDecel">ğŸ”» Auto Deceleration</div>
            <div class="pilot-warning" id="warn-emergency" data-i18n="emergencyReverseWarn">ğŸš¨ Emergency Reverse!</div>
            <div class="pilot-warning gravity" id="warn-gravity" data-i18n="gravityCapture">âš ï¸ Gravity Capture! Escape Required!</div>
            <div class="pilot-warning escape-ready" id="warn-escape-ready" style="display:none;background:rgba(255,153,0,0.3);border-color:#f90;color:#f90;" data-i18n="escapeBoosterReady">âš¡ Escape Booster Ready</div>
        </div>
        <div id="pilot-left" style="display:none;">
            <!-- ALTITUDE ê²Œì´ì§€ ì œê±°ë¨ -->
        </div>
        <div id="pilot-right">
            <div id="pilot-radar"><div class="radar-ring" style="width:30%;height:30%;"></div><div class="radar-ring" style="width:60%;height:60%;"></div><div class="radar-ring" style="width:90%;height:90%;"></div><div id="pilot-radar-sweep"></div><div id="pilot-radar-ship"></div></div>
            <div id="pilot-target-info"><div class="target-label" data-i18n="targetLabel">TARGET</div><div class="target-name" id="pilot-target-name" data-i18n="none">None</div><div class="target-dist" id="pilot-target-dist">---</div><div class="target-eta" id="pilot-target-eta"></div></div>
            <div id="pilot-autopilot-info" class="inactive"><div class="ap-label" data-i18n="autopilotLabel">AUTOPILOT</div><div class="ap-status" id="ap-status" data-i18n="off">OFF</div><div class="ap-phase" id="ap-phase"></div></div>
        </div>
        <div id="crosshair"><div class="ch-line h"></div><div class="ch-line v"></div><div class="ch-dot"></div></div>
        
        <!-- â˜… í†µí•© ì±„íŒ… íŒ¨ë„ (ARIA + ë©€í‹°ì±„íŒ…) -->
        <div id="unified-chat-panel">
            <div class="chat-tab-bar">
                <button class="chat-tab active" data-tab="aria" data-i18n="ariaTab">ğŸ¤– ARIA</button>
                <button class="chat-tab" data-tab="multi" data-i18n="chatTab">ğŸ’¬ Chat</button>
                <button id="chat-toggle-btn">â–¼</button>
            </div>
            <div class="chat-content">
                <!-- ARIA íƒ­ -->
                <div id="aria-tab" class="tab-content active">
                    <div class="chat-content-box" id="aria-messages">
                        <div class="aria-msg"><span class="aria-text" data-i18n="systemInit">System initialized. Fly safe, pilot.</span></div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="aria-input" data-placeholder-i18n="ariaPlaceholder" placeholder="ARIAì—ê²Œ ì§ˆë¬¸..." maxlength="200">
                        <button id="aria-send-btn">â–¶</button>
                    </div>
                </div>
                <!-- ë©€í‹° ì±„íŒ… íƒ­ -->
                <div id="multi-tab" class="tab-content">
                    <div class="chat-content-box" id="multi-messages">
                        <div class="mp-msg system" data-i18n="chatNotConnected">Not connected to chat</div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="multi-input" data-placeholder-i18n="enterMessage" placeholder="ë©”ì‹œì§€ ì…ë ¥..." maxlength="200">
                        <button id="multi-send-btn">â–¶</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI ë¶€ì¡°ì¢…ì‚¬ íŒ¨ë„ (ìˆ¨ê¹€) -->
        <div id="ai-copilot-panel">
            <div id="ai-copilot-header">
                <div id="ai-avatar">ğŸ¤–</div>
                <div>
                    <div id="ai-name">ARIA</div>
                    <div id="ai-status" data-i18n="online">â— ì˜¨ë¼ì¸</div>
                </div>
                <button id="ai-expand-btn" onclick="toggleAIPanel()">â–¼</button>
            </div>
            <div id="ai-message-box">
                <span id="ai-message-text" data-i18n="aiInitMessage">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ. ì•ˆì „í•œ ë¹„í–‰ ë˜ì„¸ìš”, íŒŒì¼ëŸ¿.</span>
            </div>
            <div id="ai-input-area">
                <input type="text" id="ai-input" placeholder="ARIAì—ê²Œ ì§ˆë¬¸í•˜ê¸°..." data-placeholder-i18n="ariaPlaceholder" maxlength="200">
                <button id="ai-send-btn" onclick="aiSendQuestion()">â–¶</button>
            </div>
        </div>
        
        <!-- AI êµì‹  ëª¨ë‹¬ -->
        <div id="ai-comm-modal">
            <div id="ai-comm-portrait">ğŸ‘½</div>
            <div id="ai-comm-name" data-i18n="unidentifiedSignal">ë¯¸í™•ì¸ ì‹ í˜¸</div>
            <div id="ai-comm-message"></div>
            <div id="ai-comm-choices"></div>
        </div>
        
        <div id="pilot-bottom">
            <div id="pilot-left-console">
                <div class="vertical-gauge thr-gauge">
                    <div class="thr-label-top" data-i18n="accel">ê°€ì†</div>
                    <div class="vg-bar thr-bar">
                        <div class="vg-bg">
                            <div class="thr-center-line"></div>
                            <div class="vg-fill throttle-up" id="throttle-up-fill"></div>
                            <div class="vg-fill throttle-down" id="throttle-down-fill"></div>
                        </div>
                    </div>
                    <div class="thr-label-bottom" data-i18n="reverse">ì—­ì¶”ì§„</div>
                    <div class="vg-label">THR</div>
                    <div class="vg-value" id="throttle-val">0%</div>
                </div>
                <div class="vertical-gauge"><div class="vg-bar"><div class="vg-bg"><div class="vg-fill fuel" id="fuel-fill"></div></div></div><div class="vg-label">FUEL</div><div class="vg-value" id="fuel-val">100/100</div></div>
                <div class="vertical-gauge hull-gauge"><div class="vg-bar"><div class="vg-bg"><div class="vg-fill hull" id="hull-fill" style="height:100%;background:linear-gradient(180deg,#ff8800,#ff4400);"></div></div></div><div class="vg-label" style="color:#ff8800;">HULL</div><div class="vg-value" id="hull-val" style="color:#ff8800;">100</div></div>
                <!-- ê¸´ê¸‰ ì—­ì¶”ì§„ ë²„íŠ¼ -->
                <button class="pilot-ctrl-btn emergency-brake" id="btn-emergency-brake" data-i18n="emergencyReverse">ğŸ”¥<br>ê¸´ê¸‰ì—­ì¶”ì§„</button>
            </div>
            <div id="pilot-center-console">
                <div id="pilot-main-speed">
                    <span class="speed-value" id="main-speed-val">0</span><span class="speed-unit">km/s</span>
                    <div id="speed-kmh" style="font-size:0.6em;color:#aaa;margin-top:2px;">(0 km/h)</div>
                </div>
                <div id="pilot-btn-row">
                    <button class="pilot-console-btn autopilot" id="btn-autopilot" data-i18n="auto">ğŸ¤– Auto</button>
                    <button class="pilot-console-btn orbit-entry" id="btn-orbit-entry" style="display:none;" data-i18n="orbitEntry">ğŸŒ Orbit</button>
                    <button class="pilot-console-btn interior disabled" id="btn-interior" data-i18n="interior">ğŸšª Interior</button>
                    <button class="pilot-console-btn" id="btn-telescope" style="background:linear-gradient(135deg,#1a5276,#2980b9);" data-i18n="telescope">ğŸ”­ Telescope</button>
                    <button class="pilot-console-btn emergency" id="btn-escape" data-i18n="emergency">ğŸ†˜ Escape</button>
                    <button class="pilot-console-btn danger" id="btn-exit-pilot" style="padding:5px 8px; font-size:8px;" data-i18n="disembark">ğŸŒŒ Exit</button>
                </div>
            </div>
            <div id="pilot-right-console">
                <!-- ë°ìŠ¤í¬í†±ìš© ê°€ì†/ê°ì† ë²„íŠ¼ -->
                <button class="pilot-ctrl-btn desktop-only" id="btn-accel">â–²</button>
                <button class="pilot-ctrl-btn desktop-only" id="btn-decel">â–¼</button>
            </div>
        </div>
        <div id="virtual-joystick"><div id="joystick-base"><div id="joystick-knob"></div></div></div>
        
        <!-- 3ì¸ì¹­ ë·° ì „ìš© í”Œë¡œíŒ… ë²„íŠ¼ (ë¹„í™œì„±í™” - ì¡°ì¢…ì‹¤ UI ì‚¬ìš©) -->
        <div id="space-view-controls" style="display:none !important;"></div>
        
        <!-- í„°ì¹˜ ì˜ì—­ (í™”ë©´ ì™¼ìª½ ì ˆë°˜) -->
        <div id="touch-area-left"></div>
        
        <!-- ëª¨ë°”ì¼ìš© ë™ì  ì¡°ì´ìŠ¤í‹± -->
        <div id="pilot-joystick">
            <div id="pilot-joystick-base">
                <div id="pilot-joystick-knob"></div>
            </div>
        </div>
        
        <!-- ê¶¤ë„ ì§„ì… í”„ë¡¬í”„íŠ¸ -->
        <div id="orbit-prompt">
            <div class="orbit-prompt-title" data-i18n="orbitLock">ğŸŒ Tidal Lock Orbit</div>
            <div class="orbit-prompt-target"><span id="orbit-target-name">Earth</span> <span data-i18n="stableOrbit">Stable Orbit</span></div>
            <p data-i18n="orbitPromptMsg">Enter tidal locked orbit?<br>Ship will naturally orbit while facing the planet.</p>
            <div class="orbit-prompt-buttons">
                <button class="orbit-btn confirm" id="btn-enter-orbit" data-i18n="confirmOrbit">âœ“ Lock Orbit</button>
                <button class="orbit-btn cancel" id="btn-cancel-orbit" data-i18n="cancel">âœ• Cancel</button>
            </div>
        </div>
    </div>

    <!-- ì„ ë‚´ HUD -->
    <div id="interior-hud">
        <div id="interior-top">
            <span id="interior-location">ğŸ“ Cockpit</span>
            <span id="interior-eta">â±ï¸ --:--:--</span>
        </div>
        <div id="move-joystick"><div id="move-joystick-base"><div id="move-joystick-knob"></div></div></div>
        <div id="interior-crosshair"></div>
        <div id="object-name"></div>
        <div id="interaction-hint">[E] ìƒí˜¸ì‘ìš©</div>
        <div id="interior-bottom"><button class="pilot-console-btn" id="btn-int-back">â† ì¡°ì¢…ì„</button></div>
        <div id="door-prompt"><div class="door-name" id="door-name" data-i18n="researchLab">ğŸšª ì—°êµ¬ì‹¤</div><p data-i18n="approachedDoor">ë¬¸ì— ì ‘ê·¼í–ˆìŠµë‹ˆë‹¤</p><button id="btn-open-door" data-i18n="enterDoor">ì…ì¥ [E]</button></div>
    </div>

    <!-- ì „ë§ëŒ€ HUD -->
    <div id="observatory-hud">
        <div id="obs-top">
            <span id="obs-title" data-i18n="observatory">ğŸ”­ Observatory</span>
            <span id="obs-eta">â±ï¸ --:--:--</span>
        </div>
        <div id="obs-bottom"><button class="pilot-console-btn" id="btn-obs-back">â† Return to Interior</button></div>
    </div>

    <!-- ëª¨ë°”ì¼ ë¯¸ë‹ˆ HUD -->
    <div id="mobile-mini-hud" style="display: none;">
        <div class="mini-hud-item">
            <span class="mini-hud-icon">ğŸš€</span>
            <span class="mini-hud-value" id="mini-speed">0</span>
            <span style="color:#888;font-size:10px;">km/s</span>
        </div>
        <div class="mini-hud-item">
            <div class="mini-hud-bar">
                <div class="mini-hud-bar-fill" id="mini-fuel-bar" style="width: 100%;"></div>
            </div>
            <span class="mini-hud-value" id="mini-fuel">100/100</span>
        </div>
        <div class="mini-hud-item">
            <span class="mini-hud-icon">ğŸ¯</span>
            <span class="mini-hud-value" id="mini-target" style="font-size:10px;" data-i18n="none">None</span>
        </div>
    </div>

    <!-- ëª¨ë°”ì¼ í•˜ë‹¨ íƒ­ ë°” -->
    <div id="mobile-tab-bar">
        <button class="mobile-tab active" data-tab="control">
            <span class="mobile-tab-icon">ğŸ•¹ï¸</span>
            <span data-i18n="control">ì¡°ì¢…</span>
        </button>
        <button class="mobile-tab" data-tab="status">
            <span class="mobile-tab-icon">ğŸ“Š</span>
            <span data-i18n="statusTab">ìƒíƒœ</span>
        </button>
        <button class="mobile-tab" data-tab="radio">
            <span class="mobile-tab-icon">ğŸ“»</span>
            <span data-i18n="radioTab">ë¼ë””ì˜¤</span>
        </button>
        <button class="mobile-tab" data-tab="chat">
            <span class="mobile-tab-icon">ğŸ’¬</span>
            <span data-i18n="chatTab2">ì±„íŒ…</span>
        </button>
        <button class="mobile-tab" data-tab="aria">
            <span class="mobile-tab-icon">ğŸ¤–</span>
            <span data-i18n="ariaTab2">ARIA</span>
        </button>
    </div>

    <!-- ëª¨ë°”ì¼ íƒ­ íŒ¨ë„ -->
    <div id="mobile-tab-panel">
        <!-- ì¡°ì¢… íŒ¨ë„ -->
        <div class="mobile-panel-content active" id="mobile-control-panel">
            <div class="mobile-gauge-group" id="mobile-gauge-container">
                <div class="mobile-gauge">
                    <span class="mobile-gauge-label">THR</span>
                    <div class="mobile-gauge-bar">
                        <div class="mobile-gauge-fill thr" id="mobile-thr-fill" style="height: 50%;"></div>
                    </div>
                    <span class="mobile-gauge-value" id="mobile-thr-value">+0%</span>
                </div>
                <div class="mobile-gauge">
                    <span class="mobile-gauge-label">FUEL</span>
                    <div class="mobile-gauge-bar">
                        <div class="mobile-gauge-fill fuel" id="mobile-fuel-fill" style="height: 100%;"></div>
                    </div>
                    <span class="mobile-gauge-value" id="mobile-fuel-value">100/100</span>
                </div>
                <div class="mobile-gauge">
                    <span class="mobile-gauge-label" style="color:#ff8800;">HULL</span>
                    <div class="mobile-gauge-bar" style="border-color:#ff8800;">
                        <div class="mobile-gauge-fill" id="mobile-hull-fill" style="height: 100%;background:linear-gradient(180deg,#ff8800,#ff4400);"></div>
                    </div>
                    <span class="mobile-gauge-value" id="mobile-hull-value" style="color:#ff8800;">100</span>
                </div>
            </div>
            
            <div class="mobile-speed-display" id="mobile-speed-container">
                <div class="mobile-speed-value" id="mobile-speed-val">0</div>
                <div class="mobile-speed-unit">km/s</div>
                <div class="mobile-speed-secondary" id="mobile-speed-kmh">(0 km/h)</div>
            </div>
            
            <div class="mobile-direction-btns" id="mobile-arrows-container">
                <button class="mobile-dir-btn" id="mobile-accel">â–²</button>
                <button class="mobile-dir-btn emergency-brake" id="mobile-emergency-brake" style="background:linear-gradient(145deg,#cc0000,#990000);border-color:#ff3333;">ğŸ”¥</button>
                <button class="mobile-dir-btn" id="mobile-decel">â–¼</button>
            </div>
            
            <div class="mobile-btn-row" id="mobile-btns-container">
                <button class="mobile-action-btn autopilot" id="mobile-autopilot">ğŸ¤– Auto</button>
                <button class="mobile-action-btn" id="mobile-guide">ğŸ“ Guide</button>
                <button class="mobile-action-btn orbit" id="mobile-orbit" style="display:none; background: linear-gradient(135deg, #2ecc71, #27ae60);">ğŸŒ Orbit</button>
                <button class="mobile-action-btn" id="mobile-telescope">ğŸ”­ Scope</button>
                <button class="mobile-action-btn" id="mobile-space-mode" style="padding:6px 10px; font-size:11px;">ğŸŒŒ Space</button>
            </div>
        </div>

        <!-- â˜… ë¬´ê¸° ë°œì‚¬ ë²„íŠ¼ -->
        <button id="mobile-fire-btn">ğŸ”¥</button>

        <!-- â˜… í”¼ê²© í”Œë˜ì‹œ ì˜¤ë²„ë ˆì´ -->
        <div id="weapon-hit-overlay"></div>

        <!-- ìƒíƒœ íŒ¨ë„ -->
        <div class="mobile-panel-content" id="mobile-status-panel">
            <div class="mobile-status-item">
                <div class="mobile-status-label">Speed</div>
                <div class="mobile-status-value" id="mobile-stat-speed">0 km/s</div>
            </div>
            <div class="mobile-status-item">
                <div class="mobile-status-label">Fuel</div>
                <div class="mobile-status-value" id="mobile-stat-fuel">100/100</div>
            </div>
            <div class="mobile-status-item">
                <div class="mobile-status-label">Target</div>
                <div class="mobile-status-value" id="mobile-stat-target">None</div>
            </div>
            <div class="mobile-status-item">
                <div class="mobile-status-label">Distance</div>
                <div class="mobile-status-value" id="mobile-stat-distance">-</div>
            </div>
            <div class="mobile-status-item">
                <div class="mobile-status-label">Autopilot</div>
                <div class="mobile-status-value" id="mobile-stat-autopilot">OFF</div>
            </div>
            <div class="mobile-status-item">
                <div class="mobile-status-label">Location</div>
                <div class="mobile-status-value" id="mobile-stat-location">Solar System</div>
            </div>
        </div>
        
        <!-- ë¼ë””ì˜¤ íŒ¨ë„ -->
        <div class="mobile-panel-content" id="mobile-radio-panel">
            <div class="mobile-radio-station" data-url="https://ice.somafm.com/spacestation" data-name="Space Station">
                <span class="mobile-radio-name" data-i18n="spaceStation">ğŸš€ ìš°ì£¼ ì •ê±°ì¥</span>
                <span class="mobile-radio-status">Ambient</span>
            </div>
            <div class="mobile-radio-station" data-url="https://ice.somafm.com/deepspaceone" data-name="Deep Space One">
                <span class="mobile-radio-name">ğŸŒŒ Deep Space One</span>
                <span class="mobile-radio-status">Space Music</span>
            </div>
            <div class="mobile-radio-station" data-url="https://ice.somafm.com/dronezone" data-name="Drone Zone">
                <span class="mobile-radio-name">ğŸ§ Drone Zone</span>
                <span class="mobile-radio-status">Atmospheric</span>
            </div>
            <div class="mobile-radio-station" data-url="https://ice.somafm.com/groovesalad" data-name="Groove Salad">
                <span class="mobile-radio-name">ğŸ¥— Groove Salad</span>
                <span class="mobile-radio-status">Downtempo</span>
            </div>
            <div class="mobile-radio-volume">
                <span>ğŸ”Š</span>
                <input type="range" id="mobile-radio-vol" min="0" max="100" value="30">
                <span id="mobile-radio-vol-val">30%</span>
            </div>
        </div>
        
        <!-- ì±„íŒ… íŒ¨ë„ -->
        <div class="mobile-panel-content" id="mobile-chat-panel">
            <div class="mobile-chat-messages" id="mobile-chat-messages">
                <div style="color:#888;text-align:center;">ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>
            <div class="mobile-chat-input-row">
                <input type="text" id="mobile-chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." data-placeholder-i18n="enterMessage" maxlength="100">
                <button id="mobile-chat-send" data-i18n="send">ì „ì†¡</button>
            </div>
        </div>
        
        <!-- ARIA íŒ¨ë„ -->
        <div class="mobile-panel-content" id="mobile-aria-panel">
            <div class="mobile-aria-header">
                <div class="mobile-aria-avatar">ğŸ¤–</div>
                <div class="mobile-aria-info">
                    <div class="mobile-aria-name">ARIA</div>
                    <div class="mobile-aria-status" data-i18n="online">â— ì˜¨ë¼ì¸</div>
                </div>
            </div>
            <div class="mobile-aria-messages" id="mobile-aria-messages">
                ì•ˆë…•í•˜ì„¸ìš”, íŒŒì¼ëŸ¿! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸš€
            </div>
            <div class="mobile-aria-input-row">
                <input type="text" id="mobile-aria-input" placeholder="ARIAì—ê²Œ ì§ˆë¬¸..." data-placeholder-i18n="ariaPlaceholder" maxlength="100">
                <button id="mobile-aria-send">â–¶</button>
            </div>
        </div>
    </div>

    <script id="vertexShader" type="x-shader/x-vertex">
        #include <common>
        #include <logdepthbuf_pars_vertex>
        varying vec2 vUv;
        varying vec3 vPosition;
        void main() {
            vUv = uv;
            vPosition = position;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            #include <logdepthbuf_vertex>
        }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
        #include <common>
        #include <logdepthbuf_pars_fragment>
        uniform float time;
        varying vec2 vUv;
        varying vec3 vPosition;

        vec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}
        vec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}
        float snoise(vec3 v){ 
            const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
            const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);
            vec3 i  = floor(v + dot(v, C.yyy) );
            vec3 x0 = v - i + dot(i, C.xxx) ;
            vec3 g = step(x0.yzx, x0.xyz);
            vec3 l = 1.0 - g;
            vec3 i1 = min( g.xyz, l.zxy );
            vec3 i2 = max( g.xyz, l.zxy );
            vec3 x1 = x0 - i1 + 1.0 * C.xxx;
            vec3 x2 = x0 - i2 + 2.0 * C.xxx;
            vec3 x3 = x0 - 1.0 + 3.0 * C.xxx;
            i = mod(i, 289.0 ); 
            vec4 p = permute( permute( permute( 
                        i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
                    + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) 
                    + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));
            float n_ = 1.0/7.0; // N=7
            vec3  ns = n_ * D.wyz - D.xzx;
            vec4 j = p - 49.0 * floor(p * ns.z *ns.z);
            vec4 x_ = floor(j * ns.z);
            vec4 y_ = floor(j - 7.0 * x_ );
            vec4 x = x_ *ns.x + ns.yyyy;
            vec4 y = y_ *ns.x + ns.yyyy;
            vec4 h = 1.0 - abs(x) - abs(y);
            vec4 b0 = vec4( x.xy, y.xy );
            vec4 b1 = vec4( x.zw, y.zw );
            vec4 s0 = floor(b0)*2.0 + 1.0;
            vec4 s1 = floor(b1)*2.0 + 1.0;
            vec4 sh = -step(h, vec4(0.0));
            vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
            vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;
            vec3 p0 = vec3(a0.xy,h.x);
            vec3 p1 = vec3(a0.zw,h.y);
            vec3 p2 = vec3(a1.xy,h.z);
            vec3 p3 = vec3(a1.zw,h.w);
            vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
            p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w;
            vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
            m = m * m;
            return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );
        }

        void main() {
            #include <logdepthbuf_fragment>
            float noiseVal = snoise(vPosition * 1.65 + vec3(time * 0.2));
            float noiseVal2 = snoise(vPosition * 3.3 - vec3(time * 0.3));
            float intensity = (noiseVal * 0.6 + noiseVal2 * 0.4) + 0.3;
            vec3 darkColor = vec3(1.0, 0.4, 0.0); 
            vec3 baseColor = vec3(1.0, 0.7, 0.0); 
            vec3 brightColor = vec3(1.0, 1.0, 0.9);
            vec3 finalColor = mix(darkColor, baseColor, intensity + 0.2);
            finalColor = mix(finalColor, brightColor, smoothstep(0.4, 0.8, intensity));
            gl_FragColor = vec4(finalColor, 1.0);
        }
    </script>

    <script id="coronaVertexShader" type="x-shader/x-vertex">
        #include <common>
        #include <logdepthbuf_pars_vertex>
        varying vec2 vUv;
        void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            #include <logdepthbuf_vertex>
        }
    </script>

    <script id="coronaFragmentShader" type="x-shader/x-fragment">
        #include <common>
        #include <logdepthbuf_pars_fragment>
        uniform float time;
        varying vec2 vUv;
        float random(vec2 n) { return fract(sin(dot(n, vec2(12.9898, 4.1414))) * 43758.5453); }
        float noise(vec2 p){
            vec2 ip = floor(p);
            vec2 u = fract(p);
            u = u*u*(3.0-2.0*u);
            float res = mix(
                mix(random(ip), random(ip+vec2(1.0,0.0)), u.x),
                mix(random(ip+vec2(0.0,1.0)), random(ip+vec2(1.0,1.0)), u.x), u.y);
            return res*res;
        }
        void main() {
            #include <logdepthbuf_fragment>
            vec2 center = vec2(0.5, 0.5);
            vec2 pos = vUv - center;
            float r = length(pos);
            float angle = atan(pos.y, pos.x);
            float rays = noise(vec2(angle * 10.0 + time * 0.1, r * 2.0 - time * 0.5));
            rays += noise(vec2(angle * 20.0 - time * 0.2, r * 5.0 + time * 0.2)) * 0.5;
            float glow = 1.0 - smoothstep(0.0, 0.5, r);
            glow = pow(glow, 3.0); 
            float rayIntensity = glow * (0.8 + 0.4 * rays);
            vec3 coronaColor = vec3(1.0, 0.6, 0.2); 
            gl_FragColor = vec4(coronaColor, rayIntensity * 0.8);
        }
    </script>

    <!-- â˜…â˜…â˜… ì§€êµ¬ ëŒ€ê¸° ì‰ì´ë” (ë ˆì¼ë¦¬ + ë¯¸ ì‚°ë€) â˜…â˜…â˜… -->
    <script id="atmosphereVertexShader" type="x-shader/x-vertex">
        varying vec3 vNormal;
        varying vec3 vPosition;
        varying vec3 vWorldPosition;
        
        void main() {
            vNormal = normalize(normalMatrix * normal);
            vPosition = position;
            vec4 worldPos = modelMatrix * vec4(position, 1.0);
            vWorldPosition = worldPos.xyz;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    </script>
    
    <script id="atmosphereFragmentShader" type="x-shader/x-fragment">
        uniform vec3 sunDirection;
        uniform float atmosphereRadius;
        uniform float planetRadius;
        uniform float time;
        
        varying vec3 vNormal;
        varying vec3 vPosition;
        varying vec3 vWorldPosition;
        
        // ë ˆì¼ë¦¬ ì‚°ë€ ê³„ìˆ˜ (íŒŒì¥ë³„ - í‘¸ë¥¸ìƒ‰ì´ ë” ë§ì´ ì‚°ë€)
        const vec3 rayleighCoeff = vec3(5.8e-6, 13.5e-6, 33.1e-6);
        // ë¯¸ ì‚°ë€ ê³„ìˆ˜ (ëª¨ë“  íŒŒì¥ì—ì„œ ë™ì¼ - í°ìƒ‰ ì‚°ë€)
        const float mieCoeff = 21e-6;
        
        // ëŒ€ê¸° ë°€ë„ í•¨ìˆ˜ (ê³ ë„ì— ë”°ë¥¸ ì§€ìˆ˜ ê°ì†Œ)
        float atmosphereDensity(float altitude) {
            float scaleHeight = 8500.0; // ìŠ¤ì¼€ì¼ ë†’ì´ 8.5km
            return exp(-altitude / scaleHeight);
        }
        
        void main() {
            vec3 viewDir = normalize(cameraPosition - vWorldPosition);
            vec3 normal = normalize(vNormal);
            
            // í”„ë ˆë„¬ íš¨ê³¼ (ê°€ì¥ìë¦¬ì—ì„œ ë” ê°•í•˜ê²Œ)
            float fresnel = pow(1.0 - max(dot(viewDir, normal), 0.0), 3.0);
            
            // íƒœì–‘ ë°©í–¥ê³¼ì˜ ê°ë„
            float sunAngle = max(dot(normal, sunDirection), 0.0);
            
            // ë ˆì¼ë¦¬ ì‚°ë€ (í‘¸ë¥¸ í•˜ëŠ˜)
            vec3 rayleigh = rayleighCoeff * (1.0 + pow(sunAngle, 2.0));
            
            // ë¯¸ ì‚°ë€ (íƒœì–‘ ì£¼ë³€ ë°ì€ ê¸€ë¡œìš°)
            float miePhase = pow(max(dot(viewDir, sunDirection), 0.0), 8.0);
            vec3 mie = vec3(mieCoeff) * miePhase;
            
            // ëŒ€ê¸° ìƒ‰ìƒ ê³„ì‚°
            vec3 dayColor = vec3(0.3, 0.6, 1.0);   // ë‚®: í‘¸ë¥¸ìƒ‰
            vec3 sunsetColor = vec3(1.0, 0.4, 0.1); // ì¼ëª°: ì£¼í™©ìƒ‰
            vec3 nightColor = vec3(0.02, 0.02, 0.05); // ë°¤: ì–´ë‘ìš´ íŒŒë‘
            
            // ì¼ëª° íš¨ê³¼ (íƒœì–‘ì´ ìˆ˜í‰ì„ ì— ê°€ê¹Œìš¸ ë•Œ)
            float horizonAngle = dot(normal, sunDirection);
            float sunsetFactor = smoothstep(-0.1, 0.3, horizonAngle) * smoothstep(0.5, 0.1, horizonAngle);
            
            // ë‚®/ë°¤ í˜¼í•©
            float dayFactor = smoothstep(-0.1, 0.2, sunAngle);
            vec3 baseColor = mix(nightColor, dayColor, dayFactor);
            baseColor = mix(baseColor, sunsetColor, sunsetFactor * 0.7);
            
            // ìµœì¢… ëŒ€ê¸° ìƒ‰ìƒ
            vec3 atmosphere = baseColor * fresnel * 1.5;
            atmosphere += mie * vec3(1.0, 0.9, 0.7) * 2.0;  // íƒœì–‘ ê¸€ë¡œìš°
            
            // íˆ¬ëª…ë„ (ê°€ì¥ìë¦¬ì—ì„œ ë” ë¶ˆíˆ¬ëª…)
            float alpha = fresnel * 0.8 + sunsetFactor * 0.2;
            alpha = clamp(alpha, 0.0, 0.85);
            
            gl_FragColor = vec4(atmosphere, alpha);
        }
    </script>
    
    <!-- â˜…â˜…â˜… ì§€êµ¬ êµ¬ë¦„ ì‰ì´ë” (ë³¼ë¥˜ë©”íŠ¸ë¦­ ë ˆì´ë§ˆì¹­) â˜…â˜…â˜… -->
    <script id="cloudVertexShader" type="x-shader/x-vertex">
        varying vec2 vUv;
        varying vec3 vNormal;
        varying vec3 vPosition;
        varying vec3 vWorldPosition;
        varying vec3 vViewDir;
        
        void main() {
            vUv = uv;
            vNormal = normalize(normalMatrix * normal);
            vPosition = position;
            vec4 worldPos = modelMatrix * vec4(position, 1.0);
            vWorldPosition = worldPos.xyz;
            vViewDir = normalize(cameraPosition - worldPos.xyz);
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    </script>
    
    <script id="cloudFragmentShader" type="x-shader/x-fragment">
        uniform float time;
        uniform vec3 sunDirection;
        uniform float cloudDensity;
        uniform float cloudSpeed;
        
        varying vec2 vUv;
        varying vec3 vNormal;
        varying vec3 vPosition;
        varying vec3 vWorldPosition;
        varying vec3 vViewDir;
        
        // í•´ì‹œ í•¨ìˆ˜
        float hash(vec3 p) {
            p = fract(p * 0.3183099 + 0.1);
            p *= 17.0;
            return fract(p.x * p.y * p.z * (p.x + p.y + p.z));
        }
        
        // 3D ë…¸ì´ì¦ˆ
        float noise(vec3 x) {
            vec3 i = floor(x);
            vec3 f = fract(x);
            f = f * f * (3.0 - 2.0 * f);
            
            return mix(mix(mix(hash(i + vec3(0,0,0)), hash(i + vec3(1,0,0)), f.x),
                          mix(hash(i + vec3(0,1,0)), hash(i + vec3(1,1,0)), f.x), f.y),
                      mix(mix(hash(i + vec3(0,0,1)), hash(i + vec3(1,0,1)), f.x),
                          mix(hash(i + vec3(0,1,1)), hash(i + vec3(1,1,1)), f.x), f.y), f.z);
        }
        
        // ì›Œí•‘ëœ FBM - ë” ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ë¦„ í˜•íƒœ
        float fbm(vec3 p) {
            float value = 0.0;
            float amplitude = 0.5;
            float frequency = 1.0;
            
            // ì›Œí•‘ (êµ¬ë¦„ì´ íœ˜ì–´ì§€ëŠ” íš¨ê³¼)
            p += vec3(noise(p * 2.0), noise(p * 2.0 + 100.0), noise(p * 2.0 + 200.0)) * 0.5;
            
            for (int i = 0; i < 6; i++) {
                value += amplitude * noise(p * frequency);
                amplitude *= 0.5;
                frequency *= 2.0;
                // ê° ë ˆì´ì–´ë§ˆë‹¤ ì•½ê°„ì”© íšŒì „ (ë” ìì—°ìŠ¤ëŸ¬ì›€)
                p = p.yzx * 1.01;
            }
            return value;
        }
        
        // êµ¬ë¦„ ë°€ë„ ìƒ˜í”Œë§
        float sampleCloud(vec3 pos, float t) {
            // ì‹œê°„ì— ë”°ë¥¸ ë°”ëŒ íš¨ê³¼
            vec3 windOffset = vec3(t * 0.02, 0.0, t * 0.01);
            
            // ê¸°ë³¸ êµ¬ë¦„ ë…¸ì´ì¦ˆ
            float cloud = fbm((pos + windOffset) * 3.0);
            
            // ì„¸ë¶€ ë…¸ì´ì¦ˆ ì¶”ê°€
            cloud += fbm((pos + windOffset * 2.0) * 8.0) * 0.3;
            cloud += fbm((pos + windOffset * 3.0) * 16.0) * 0.15;
            
            // ìœ„ë„ì— ë”°ë¥¸ êµ¬ë¦„ ë¶„í¬ (ì ë„ì™€ ì¤‘ìœ„ë„ì— ë” ë§ì´)
            float latitude = abs(pos.y);
            float latMask = smoothstep(0.9, 0.6, latitude) * smoothstep(0.0, 0.2, latitude);
            latMask = mix(latMask, 1.0, 0.4);  // ì™„ì „íˆ ì—†ì–´ì§€ì§€ ì•Šë„ë¡
            
            // êµ¬ë¦„ í˜•íƒœ ì¡°ì ˆ
            cloud = cloud * latMask;
            cloud = smoothstep(0.35, 0.65, cloud);  // êµ¬ë¦„ ê²½ê³„ ì„ ëª…í•˜ê²Œ
            
            return cloud;
        }
        
        void main() {
            vec3 normal = normalize(vNormal);
            vec3 viewDir = normalize(vViewDir);
            
            // êµ¬ë©´ ì¢Œí‘œ
            vec3 spherePos = normalize(vPosition);
            
            // ë ˆì´ë§ˆì¹­ ì„¤ì •
            const int STEPS = 8;
            float stepSize = 0.02;
            
            vec3 rayPos = spherePos;
            float totalDensity = 0.0;
            float transmittance = 1.0;
            vec3 cloudColor = vec3(0.0);
            
            // íƒœì–‘ ì¡°ëª…
            float sunLight = max(dot(normal, sunDirection), 0.0);
            float sunsetFactor = smoothstep(-0.1, 0.3, sunLight) * smoothstep(0.5, 0.1, sunLight);
            
            // ê¸°ë³¸ êµ¬ë¦„ ìƒ‰ìƒ
            vec3 dayColor = vec3(1.0, 1.0, 1.0);
            vec3 sunsetColor = vec3(1.0, 0.6, 0.4);
            vec3 nightColor = vec3(0.2, 0.2, 0.25);
            
            vec3 baseColor = mix(nightColor, dayColor, smoothstep(-0.1, 0.3, sunLight));
            baseColor = mix(baseColor, sunsetColor, sunsetFactor * 0.7);
            
            // ê°„ë‹¨í•œ ë ˆì´ë§ˆì¹­ (ì—¬ëŸ¬ ë ˆì´ì–´ ìƒ˜í”Œë§)
            for (int i = 0; i < STEPS; i++) {
                float fi = float(i) / float(STEPS);
                
                // ë†’ì´ì— ë”°ë¥¸ ë ˆì´ì–´
                vec3 samplePos = spherePos * (1.0 + fi * 0.03);
                
                // êµ¬ë¦„ ë°€ë„ ìƒ˜í”Œë§
                float density = sampleCloud(samplePos, time);
                
                if (density > 0.01) {
                    // ë¼ì´íŠ¸ ì‚°ë€ (íƒœì–‘ ë°©í–¥ì—ì„œ ë” ë°ê²Œ)
                    float lightScatter = 0.5 + 0.5 * max(dot(samplePos, sunDirection), 0.0);
                    
                    // ê·¸ë¦¼ì íš¨ê³¼ (ìœ„ ë ˆì´ì–´ê°€ ì•„ë˜ë¥¼ ê°€ë¦¼)
                    float shadow = 1.0 - fi * 0.3;
                    
                    // ìƒ‰ìƒ ëˆ„ì 
                    vec3 stepColor = baseColor * lightScatter * shadow;
                    
                    // ì€ì„  íš¨ê³¼ (Silver Lining) - êµ¬ë¦„ ê°€ì¥ìë¦¬ê°€ ë°ê²Œ
                    float edge = smoothstep(0.3, 0.5, density) - smoothstep(0.5, 0.7, density);
                    stepColor += vec3(1.0, 0.95, 0.9) * edge * sunLight * 0.5;
                    
                    cloudColor += stepColor * density * transmittance;
                    transmittance *= 1.0 - density * 0.3;
                }
            }
            
            // í”„ë ˆë„¬ íš¨ê³¼ (ê°€ì¥ìë¦¬ì—ì„œ ë” íˆ¬ëª…)
            float fresnel = pow(1.0 - max(dot(viewDir, normal), 0.0), 2.0);
            float alpha = totalDensity;
            
            // ë ˆì´ë§ˆì¹­ ê²°ê³¼ë¡œ ì•ŒíŒŒ ê³„ì‚°
            alpha = 1.0 - transmittance;
            alpha = clamp(alpha * 1.5, 0.0, 0.9);
            
            // ë°¤ì—ëŠ” êµ¬ë¦„ì´ ëœ ë³´ì´ë„ë¡
            alpha *= mix(0.4, 1.0, smoothstep(-0.2, 0.1, sunLight));
            
            // ê°€ì¥ìë¦¬ í˜ì´ë“œ
            alpha *= smoothstep(0.0, 0.3, 1.0 - fresnel * 0.5);
            
            gl_FragColor = vec4(cloudColor / max(1.0 - transmittance, 0.001), alpha);
        }
    </script>

    <script type="module" src="js/main.js"></script>

<script>
// ============================================================
// Solar Explorer ë©€í‹°í”Œë ˆì´ì–´ ì½”ë“œ
// ============================================================

// ============ ìš°ì£¼ ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ (ìë™ ì „í™˜) ============
const SpaceAudio = {
    ctx: null,
    masterGain: null,
    isInitialized: false,
    isPlaying: false,
    currentMode: null,
    volume: 0.4,
    nodes: [],
    timers: [],
    
    // â˜…â˜…â˜… ì™¸ë¶€ BGM ì„¤ì • â˜…â˜…â˜…
    bgmConfig: null,
    bgmAudio: null,  // HTML Audio ìš”ì†Œ
    bgmLoaded: false,
    
    init() {
        if (this.isInitialized) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.value = this.volume;
        this.masterGain.connect(this.ctx.destination);
        this.isInitialized = true;
        
        // â˜… BGM ì„¤ì • ë¡œë“œ
        this.loadBgmConfig();
    },
    
    // â˜…â˜…â˜… BGM ì„¤ì • íŒŒì¼ ë¡œë“œ â˜…â˜…â˜…
    async loadBgmConfig() {
        try {
            const res = await fetch('bgm_config.json');
            if (res.ok) {
                this.bgmConfig = await res.json();
                this.bgmLoaded = true;
                console.log('ğŸµ BGM ì„¤ì • ë¡œë“œë¨:', this.bgmConfig);
            }
        } catch(e) {
            console.log('ğŸµ bgm_config.json ì—†ìŒ - ê¸°ë³¸ ì‚¬ìš´ë“œ ì‚¬ìš©');
        }
    },
    
    // â˜…â˜…â˜… ì™¸ë¶€ BGM ì¬ìƒ â˜…â˜…â˜…
    playBgm(category) {
        if (!this.bgmConfig || !this.bgmConfig.tracks) return false;
        
        // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ê¸°ë³¸ BGM ì°¾ê¸°
        const defaultId = this.bgmConfig.defaults?.[category];
        let track = null;
        
        if (defaultId) {
            track = this.bgmConfig.tracks.find(t => t.id === defaultId);
        }
        
        // ê¸°ë³¸ ì„¤ì • ì—†ìœ¼ë©´ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì²«ë²ˆì§¸ íŠ¸ë™
        if (!track) {
            track = this.bgmConfig.tracks.find(t => t.category === category);
        }
        
        if (!track) return false;
        
        // ê¸°ì¡´ BGM ì •ì§€
        this.stopBgm();
        
        // ìƒˆ BGM ì¬ìƒ
        console.log('ğŸµ BGM ì¬ìƒ:', track.name, track.url);
        this.bgmAudio = new Audio(track.url);
        this.bgmAudio.volume = (track.volume || 80) / 100 * this.volume;
        this.bgmAudio.loop = track.loop !== false;  // ê¸°ë³¸ê°’ true
        this.bgmAudio.play().catch(e => console.log('BGM ìë™ì¬ìƒ ì°¨ë‹¨ë¨'));
        
        return true;
    },
    
    // â˜…â˜…â˜… ì™¸ë¶€ BGM ì •ì§€ â˜…â˜…â˜…
    stopBgm() {
        if (this.bgmAudio) {
            this.bgmAudio.pause();
            this.bgmAudio.currentTime = 0;
            this.bgmAudio = null;
        }
    },
    
    stop() {
        this.stopBgm();  // â˜… ì™¸ë¶€ BGMë„ ì •ì§€
        this.timers.forEach(t => clearInterval(t));
        this.timers = [];
        this.nodes.forEach(n => { try { n.stop(); n.disconnect(); } catch(e) {} });
        this.nodes = [];
        this.isPlaying = false;
        this.currentMode = null;
    },
    
    // ===== ìš°ì£¼ ê³µê°„ BGM =====
    playSpace() {
        if (this.currentMode === 'space') return;
        this.stop();
        this.init();
        this.currentMode = 'space';
        this.isPlaying = true;
        
        // â˜… ì™¸ë¶€ BGM ìˆìœ¼ë©´ ìš°ì„  ì¬ìƒ
        if (this.playBgm('explore')) {
            return;  // ì™¸ë¶€ BGM ì¬ìƒ ì„±ê³µ
        }
        
        // ì™¸ë¶€ BGM ì—†ìœ¼ë©´ ê¸°ë³¸ ì‚¬ìš´ë“œ
        const ctx = this.ctx;
        
        // 1. ë”¥ ë“œë¡  (40Hz)
        const drone = ctx.createOscillator();
        const droneGain = ctx.createGain();
        drone.type = 'sine';
        drone.frequency.value = 40;
        droneGain.gain.value = 0.25;
        drone.connect(droneGain);
        droneGain.connect(this.masterGain);
        drone.start();
        this.nodes.push(drone);
        
        // 2. 5ë„ ìœ„ ë“œë¡  (60Hz)
        const drone2 = ctx.createOscillator();
        const drone2Gain = ctx.createGain();
        drone2.type = 'sine';
        drone2.frequency.value = 60;
        drone2Gain.gain.value = 0.12;
        drone2.connect(drone2Gain);
        drone2Gain.connect(this.masterGain);
        drone2.start();
        this.nodes.push(drone2);
        
        // 3. ìš°ì£¼ ë°”ëŒ ë…¸ì´ì¦ˆ
        const noiseLen = ctx.sampleRate * 3;
        const noiseBuf = ctx.createBuffer(1, noiseLen, ctx.sampleRate);
        const noiseData = noiseBuf.getChannelData(0);
        for (let i = 0; i < noiseLen; i++) noiseData[i] = Math.random() * 2 - 1;
        const noise = ctx.createBufferSource();
        noise.buffer = noiseBuf;
        noise.loop = true;
        const noiseFilt = ctx.createBiquadFilter();
        noiseFilt.type = 'lowpass';
        noiseFilt.frequency.value = 150;
        const noiseGain = ctx.createGain();
        noiseGain.gain.value = 0.06;
        noise.connect(noiseFilt);
        noiseFilt.connect(noiseGain);
        noiseGain.connect(this.masterGain);
        noise.start();
        this.nodes.push(noise);
        
        // 4. ì‹ ë¹„ë¡œìš´ íŒ¨ë“œ (ê°€ë”)
        const padTimer = setInterval(() => {
            if (this.currentMode !== 'space') return;
            const pad = ctx.createOscillator();
            const padGain = ctx.createGain();
            pad.type = 'sine';
            pad.frequency.value = [220, 330, 440, 550][Math.floor(Math.random() * 4)];
            padGain.gain.setValueAtTime(0, ctx.currentTime);
            padGain.gain.linearRampToValueAtTime(0.04, ctx.currentTime + 2);
            padGain.gain.linearRampToValueAtTime(0, ctx.currentTime + 5);
            pad.connect(padGain);
            padGain.connect(this.masterGain);
            pad.start();
            pad.stop(ctx.currentTime + 5);
        }, 7000);
        this.timers.push(padTimer);
    },
    
    // ===== ì •ê±°ì¥ BGM (ìš°ì£¼ ë°°ê²½ + ë³´ì´ì € ìŠ¤íƒ€ì¼ ì‹ í˜¸ìŒ) =====
    playStation() {
        if (this.currentMode === 'station') return;
        this.stop();
        this.init();
        this.currentMode = 'station';
        this.isPlaying = true;
        
        // â˜… ì™¸ë¶€ BGM ìˆìœ¼ë©´ ìš°ì„  ì¬ìƒ
        if (this.playBgm('station')) {
            return;  // ì™¸ë¶€ BGM ì¬ìƒ ì„±ê³µ
        }
        
        const ctx = this.ctx;
        
        // ìš°ì£¼ ë°°ê²½ìŒ (ë™ì¼)
        const drone = ctx.createOscillator();
        const droneGain = ctx.createGain();
        drone.type = 'sine';
        drone.frequency.value = 40;
        droneGain.gain.value = 0.2;
        drone.connect(droneGain);
        droneGain.connect(this.masterGain);
        drone.start();
        this.nodes.push(drone);
        
        const drone2 = ctx.createOscillator();
        const drone2Gain = ctx.createGain();
        drone2.type = 'sine';
        drone2.frequency.value = 60;
        drone2Gain.gain.value = 0.1;
        drone2.connect(drone2Gain);
        drone2Gain.connect(this.masterGain);
        drone2.start();
        this.nodes.push(drone2);
        
        // ìš°ì£¼ ë°”ëŒ
        const noiseLen = ctx.sampleRate * 3;
        const noiseBuf = ctx.createBuffer(1, noiseLen, ctx.sampleRate);
        const noiseData = noiseBuf.getChannelData(0);
        for (let i = 0; i < noiseLen; i++) noiseData[i] = Math.random() * 2 - 1;
        const noise = ctx.createBufferSource();
        noise.buffer = noiseBuf;
        noise.loop = true;
        const noiseFilt = ctx.createBiquadFilter();
        noiseFilt.type = 'lowpass';
        noiseFilt.frequency.value = 150;
        const noiseGain = ctx.createGain();
        noiseGain.gain.value = 0.05;
        noise.connect(noiseFilt);
        noiseFilt.connect(noiseGain);
        noiseGain.connect(this.masterGain);
        noise.start();
        this.nodes.push(noise);
        
        // ë³´ì´ì € ìŠ¤íƒ€ì¼ ì‹ í˜¸ìŒ (3.7ì´ˆë§ˆë‹¤ ì—°ì† í„ìŠ¤)
        const voyagerTimer = setInterval(() => {
            if (this.currentMode !== 'station') return;
            
            // 8ê°œì˜ ì—°ì† í„ìŠ¤ (ë°ì´í„° ë²„ìŠ¤íŠ¸)
            for (let i = 0; i < 8; i++) {
                const delay = i * 0.12;
                const pulse = ctx.createOscillator();
                const pulseGain = ctx.createGain();
                
                pulse.type = 'sine';
                pulse.frequency.value = 1500;  // ë³´ì´ì € ì£¼íŒŒìˆ˜ ëŒ€ì—­
                
                // ì‚´ì§ ë–¨ë¦¬ëŠ” íš¨ê³¼
                const vibrato = ctx.createOscillator();
                vibrato.type = 'sine';
                vibrato.frequency.value = 30;
                const vibGain = ctx.createGain();
                vibGain.gain.value = 20;
                vibrato.connect(vibGain);
                vibGain.connect(pulse.frequency);
                vibrato.start(ctx.currentTime + delay);
                vibrato.stop(ctx.currentTime + delay + 0.08);
                
                pulseGain.gain.setValueAtTime(0, ctx.currentTime + delay);
                pulseGain.gain.linearRampToValueAtTime(0.12, ctx.currentTime + delay + 0.01);
                pulseGain.gain.setValueAtTime(0.12, ctx.currentTime + delay + 0.05);
                pulseGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.08);
                
                pulse.connect(pulseGain);
                pulseGain.connect(this.masterGain);
                pulse.start(ctx.currentTime + delay);
                pulse.stop(ctx.currentTime + delay + 0.1);
            }
        }, 3700);
        this.timers.push(voyagerTimer);
        
        // ê¸´ ìºë¦¬ì–´ í†¤ (10ì´ˆë§ˆë‹¤)
        const carrierTimer = setInterval(() => {
            if (this.currentMode !== 'station') return;
            
            const carrier = ctx.createOscillator();
            const carrierGain = ctx.createGain();
            carrier.type = 'sine';
            carrier.frequency.value = 2295;  // ë³´ì´ì € ì‹¤ì œ ìºë¦¬ì–´ ì£¼íŒŒìˆ˜ ëŒ€ì—­
            
            carrierGain.gain.setValueAtTime(0, ctx.currentTime);
            carrierGain.gain.linearRampToValueAtTime(0.06, ctx.currentTime + 0.1);
            carrierGain.gain.setValueAtTime(0.06, ctx.currentTime + 0.8);
            carrierGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.0);
            
            carrier.connect(carrierGain);
            carrierGain.connect(this.masterGain);
            carrier.start();
            carrier.stop(ctx.currentTime + 1.0);
        }, 10000);
        this.timers.push(carrierTimer);
    },
    
    // ===== ì¡°ì¢…ì‹¤ BGM (ìš´í•­ ì¤‘ì¸ ìš°ì£¼ì„ ) =====
    playCockpit() {
        if (this.currentMode === 'cockpit') return;
        this.stop();
        this.init();
        this.currentMode = 'cockpit';
        this.isPlaying = true;
        
        // â˜… ì™¸ë¶€ BGM ìˆìœ¼ë©´ ìš°ì„  ì¬ìƒ (battle ì¹´í…Œê³ ë¦¬ ì‚¬ìš©)
        if (this.playBgm('battle')) {
            return;  // ì™¸ë¶€ BGM ì¬ìƒ ì„±ê³µ
        }
        
        const ctx = this.ctx;
        
        // 1. ì—”ì§„ ì €ìŒ ì›…ì›… (35Hz ë©”ì¸)
        const engine = ctx.createOscillator();
        const engineGain = ctx.createGain();
        engine.type = 'sine';
        engine.frequency.value = 35;
        engineGain.gain.value = 0.3;
        engine.connect(engineGain);
        engineGain.connect(this.masterGain);
        engine.start();
        this.nodes.push(engine);
        
        // 2. ì—”ì§„ í•˜ëª¨ë‹‰ (70Hz)
        const engine2 = ctx.createOscillator();
        const engine2Gain = ctx.createGain();
        engine2.type = 'sine';
        engine2.frequency.value = 70;
        engine2Gain.gain.value = 0.15;
        engine2.connect(engine2Gain);
        engine2Gain.connect(this.masterGain);
        engine2.start();
        this.nodes.push(engine2);
        
        // 3. ì—”ì§„ ì§„ë™ ë³€í™” (ë¯¸ì„¸í•œ ë–¨ë¦¼)
        const vibrato = ctx.createOscillator();
        vibrato.type = 'sine';
        vibrato.frequency.value = 3;
        const vibGain = ctx.createGain();
        vibGain.gain.value = 2;
        vibrato.connect(vibGain);
        vibGain.connect(engine.frequency);
        vibrato.start();
        this.nodes.push(vibrato);
        
        // 4. ê³µê¸° ìˆœí™˜ ì†Œë¦¬ (ë¶€ë“œëŸ¬ìš´ ì‰¬ì‰¬)
        const airLen = ctx.sampleRate * 2;
        const airBuf = ctx.createBuffer(1, airLen, ctx.sampleRate);
        const airData = airBuf.getChannelData(0);
        for (let i = 0; i < airLen; i++) airData[i] = Math.random() * 2 - 1;
        const air = ctx.createBufferSource();
        air.buffer = airBuf;
        air.loop = true;
        const airFilt = ctx.createBiquadFilter();
        airFilt.type = 'bandpass';
        airFilt.frequency.value = 500;
        airFilt.Q.value = 1;
        const airGain = ctx.createGain();
        airGain.gain.value = 0.03;
        air.connect(airFilt);
        airFilt.connect(airGain);
        airGain.connect(this.masterGain);
        air.start();
        this.nodes.push(air);
        
        // 5. ê°€ë” ê³„ê¸°íŒ ì‚‘ (ëœë¤)
        const beepTimer = setInterval(() => {
            if (this.currentMode !== 'cockpit') return;
            if (Math.random() > 0.5) return;
            const b = ctx.createOscillator();
            const g = ctx.createGain();
            b.type = 'sine';
            b.frequency.value = [600, 800, 1000, 1200][Math.floor(Math.random() * 4)];
            g.gain.setValueAtTime(0.06, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
            b.connect(g);
            g.connect(this.masterGain);
            b.start();
            b.stop(ctx.currentTime + 0.05);
        }, 1500);
        this.timers.push(beepTimer);
        
        // 6. ì‹œìŠ¤í…œ ìƒíƒœìŒ (5ì´ˆë§ˆë‹¤)
        const sysTimer = setInterval(() => {
            if (this.currentMode !== 'cockpit') return;
            if (Math.random() > 0.4) return;
            const s = ctx.createOscillator();
            const g = ctx.createGain();
            s.type = 'triangle';
            s.frequency.setValueAtTime(500, ctx.currentTime);
            s.frequency.setValueAtTime(600, ctx.currentTime + 0.1);
            g.gain.setValueAtTime(0.05, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
            s.connect(g);
            g.connect(this.masterGain);
            s.start();
            s.stop(ctx.currentTime + 0.2);
        }, 5000);
        this.timers.push(sysTimer);
    },
    
    // ë³¼ë¥¨ ì„¤ì •
    setVolume(v) {
        this.volume = v;
        if (this.masterGain) this.masterGain.gain.value = v;
        // â˜… ì™¸ë¶€ BGM ë³¼ë¥¨ë„ ì¡°ì ˆ
        if (this.bgmAudio) {
            this.bgmAudio.volume = v;
        }
    },
    
    // íš¨ê³¼ìŒ: í´ë¦­
    playClick() {
        this.init();
        const ctx = this.ctx;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(700, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(350, ctx.currentTime + 0.06);
        g.gain.setValueAtTime(0.15, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.06);
        o.connect(g);
        g.connect(this.masterGain);
        o.start();
        o.stop(ctx.currentTime + 0.06);
    },
    
    // íš¨ê³¼ìŒ: ì„ íƒ
    playSelect() {
        this.init();
        const ctx = this.ctx;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(400, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.12);
        g.gain.setValueAtTime(0.12, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
        o.connect(g);
        g.connect(this.masterGain);
        o.start();
        o.stop(ctx.currentTime + 0.15);
    },
    
    // íš¨ê³¼ìŒ: ì›Œí”„
    playWarp() {
        this.init();
        const ctx = this.ctx;
        // ì°¨ì§•
        const c = ctx.createOscillator();
        const cg = ctx.createGain();
        c.type = 'sawtooth';
        c.frequency.setValueAtTime(50, ctx.currentTime);
        c.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.4);
        cg.gain.setValueAtTime(0.2, ctx.currentTime);
        cg.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        c.connect(cg);
        cg.connect(this.masterGain);
        c.start();
        c.stop(ctx.currentTime + 0.5);
        // ìŠ¤ìœ•
        setTimeout(() => {
            const s = ctx.createOscillator();
            const sg = ctx.createGain();
            s.type = 'sine';
            s.frequency.setValueAtTime(500, ctx.currentTime);
            s.frequency.exponentialRampToValueAtTime(2500, ctx.currentTime + 0.3);
            sg.gain.setValueAtTime(0.12, ctx.currentTime);
            sg.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.35);
            s.connect(sg);
            sg.connect(this.masterGain);
            s.start();
            s.stop(ctx.currentTime + 0.35);
        }, 350);
    },
    
    // íš¨ê³¼ìŒ: ì—ëŸ¬
    playError() {
        this.init();
        const ctx = this.ctx;
        [0, 0.1].forEach(d => {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = 'square';
            o.frequency.value = 180;
            g.gain.setValueAtTime(0.12, ctx.currentTime + d);
            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + d + 0.08);
            o.connect(g);
            g.connect(this.masterGain);
            o.start(ctx.currentTime + d);
            o.stop(ctx.currentTime + d + 0.08);
        });
    }
};

// ìœ„ì¹˜ ê¸°ë°˜ ìë™ ì‚¬ìš´ë“œ ì „í™˜
let lastSoundMode = null;
function updateSoundByLocation() {
    if (!SpaceAudio.isPlaying) return;
    
    let mode = 'space';
    
    // ì¡°ì¢…ì‹¤ ëª¨ë“œ (ìš°ì£¼ì„  íƒ‘ìŠ¹ ì¤‘)
    if (typeof isPilotMode !== 'undefined' && isPilotMode) {
        mode = 'cockpit';
    }
    // ì •ê±°ì¥ ê·¼ì²˜ (ISS ë“±)
    else if (typeof focusedBody !== 'undefined' && focusedBody && 
             focusedBody.name && focusedBody.name.includes('ISS')) {
        mode = 'station';
    }
    // ì„ ë‚´ ëª¨ë“œ
    else if (typeof isInsideShip !== 'undefined' && isInsideShip) {
        mode = 'cockpit';
    }
    
    if (mode !== lastSoundMode) {
        lastSoundMode = mode;
        switch(mode) {
            case 'space': SpaceAudio.playSpace(); break;
            case 'station': SpaceAudio.playStation(); break;
            case 'cockpit': SpaceAudio.playCockpit(); break;
        }
    }
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        // 1ì´ˆë§ˆë‹¤ ìœ„ì¹˜ ì²´í¬í•˜ì—¬ ì‚¬ìš´ë“œ ìë™ ì „í™˜
        setInterval(updateSoundByLocation, 1000);
    }, 2000);
    
    // ë²„íŠ¼ í´ë¦­ íš¨ê³¼ìŒ
    document.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' && e.target.id !== 'sound-btn') {
            SpaceAudio.playClick();
        }
    });
});

// ============ ë©€í‹°í”Œë ˆì´ì–´ ì„¤ì • (Supabase) ============
const SUPABASE_URL = 'https://sfirzuqngdbpwvdoyero.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaXJ6dXFuZ2RicHd2ZG95ZXJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MjU2MzYsImV4cCI6MjA4MTUwMTYzNn0.Si0i23yCuihJ4LOM-LXxZ8atl2YOytd1Cm2Ur6yj3fk';

// Supabase í´ë¼ì´ì–¸íŠ¸
let supabase = null;

// â˜…â˜…â˜… ìµœì í™”ëœ ë©€í‹°í”Œë ˆì´ì–´ ì„¤ì • â˜…â˜…â˜…
const MP_UPDATE_INTERVAL = 100;      // 100ms (10fps) - ìœ„ì¹˜ ë³€ê²½ ì‹œì—ë§Œ ì „ì†¡
const MP_SYNC_INTERVAL = 500;        // 500ms - Realtime ë°±ì—…ìš© í´ë§
const MP_CHAT_INTERVAL = 1500;       // 1.5ì´ˆ - ì±„íŒ… í´ë§
const MP_POSITION_THRESHOLD = 0.5;   // ì´ë™ ì„ê³„ê°’ (ì´ ì´ìƒ ì›€ì§ì—¬ì•¼ ì „ì†¡)
const MP_ROTATION_THRESHOLD = 0.01;  // íšŒì „ ì„ê³„ê°’
const MP_INACTIVE_TIMEOUT = 60000;   // 60ì´ˆ í›„ ë¹„í™œì„± íŒì •

// ìœ ì € ì •ë³´
let mpUser = null;
let mpUserId = null;
let mpNickname = 'ìµëª…';
let mpOtherPlayers = {};
let mpChatLastId = 0;
let mpIntervals = [];
let mpRealtimeChannel = null;

// â˜…â˜…â˜… ì¤‘ë³µ ì ‘ì† ê°ì§€ìš© ì„¸ì…˜ í† í° â˜…â˜…â˜…
let mpSessionToken = null;

function generateSessionToken() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2);
}

// â˜…â˜…â˜… ë¸íƒ€ ì••ì¶•ìš© ë§ˆì§€ë§‰ ì „ì†¡ ìƒíƒœ â˜…â˜…â˜…
let mpLastSentPosition = { x: 0, y: 0, z: 0 };
let mpLastSentRotation = { x: 0, y: 0, z: 0 };
let mpLastSentTime = 0;
let mpForceUpdateCounter = 0;

// â˜…â˜…â˜… ì„œë²„ ì‹œê°„ ë™ê¸°í™” â˜…â˜…â˜…
let serverTimeOffset = 0;  // ì„œë²„ì‹œê°„ - í´ë¼ì´ì–¸íŠ¸ì‹œê°„ (ë°€ë¦¬ì´ˆ)
let serverTimeSynced = false;

// ì„œë²„ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (HTTP Date í—¤ë” ì‚¬ìš©)
async function syncServerTime() {
    if (!supabase) return;

    try {
        const clientTimeBefore = Date.now();

        // Supabase REST API í˜¸ì¶œí•˜ì—¬ Date í—¤ë”ì—ì„œ ì„œë²„ ì‹œê°„ ì¶”ì¶œ
        const response = await fetch(SUPABASE_URL + '/rest/v1/', {
            method: 'HEAD',
            headers: {
                'apikey': SUPABASE_ANON_KEY
            }
        });

        const clientTimeAfter = Date.now();
        const serverDateHeader = response.headers.get('date');

        if (serverDateHeader) {
            const serverTime = new Date(serverDateHeader).getTime();
            const roundTrip = clientTimeAfter - clientTimeBefore;
            serverTimeOffset = serverTime - clientTimeBefore - (roundTrip / 2);
            serverTimeSynced = true;
            console.log('â±ï¸ ì„œë²„ ì‹œê°„ ë™ê¸°í™” ì™„ë£Œ:', serverTimeOffset, 'ms ì˜¤í”„ì…‹');
        } else {
            // Date í—¤ë” ì—†ìœ¼ë©´ ì˜¤í”„ì…‹ 0ìœ¼ë¡œ (ë¡œì»¬ ì‹œê°„ ì‚¬ìš©)
            serverTimeOffset = 0;
            serverTimeSynced = true;
            console.log('â±ï¸ ì„œë²„ ì‹œê°„ í—¤ë” ì—†ìŒ, ë¡œì»¬ ì‹œê°„ ì‚¬ìš©');
        }
    } catch (e) {
        console.warn('ì„œë²„ ì‹œê°„ ë™ê¸°í™” ì‹¤íŒ¨:', e);
        serverTimeOffset = 0;
        serverTimeSynced = true;
    }
}

// ë™ê¸°í™”ëœ í˜„ì¬ ì‹œê°„ ë°˜í™˜
function getSyncedTime() {
    return Date.now() + serverTimeOffset;
}

// Supabase SDK ë¡œë“œ ë° ì´ˆê¸°í™”
function initSupabase() {
    return new Promise(function(resolve, reject) {
        console.log('ğŸ”„ Supabase ì´ˆê¸°í™” ì‹œì‘...');
        
        // headì—ì„œ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
        if (window.supabase && window.supabase.createClient) {
            console.log('âœ… Supabase SDK ë¡œë“œë¨');
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            window.supabaseClient = supabase;
            console.log('âœ… Supabase ì—°ê²°ë¨:', SUPABASE_URL);
            resolve(supabase);
            return;
        }
        
        // ì•„ì§ ë¡œë“œ ì•ˆëìœ¼ë©´ ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„
        console.log('â³ Supabase SDK ë¡œë”© ëŒ€ê¸°...');
        var attempts = 0;
        var maxAttempts = 20;
        
        var checkInterval = setInterval(function() {
            attempts++;
            if (window.supabase && window.supabase.createClient) {
                clearInterval(checkInterval);
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                window.supabaseClient = supabase;
                console.log('âœ… Supabase ì—°ê²°ë¨ (ëŒ€ê¸° í›„)');
                resolve(supabase);
            } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                console.error('âŒ Supabase SDK ë¡œë“œ ì‹¤íŒ¨ - íƒ€ì„ì•„ì›ƒ');
                reject(new Error('Supabase SDK load timeout'));
            }
        }, 200);
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ Supabase ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initSupabase().then(function() {
        loadSavedLogin();
    }).catch(function(e) {
        console.warn('Supabase ì—†ì´ ì§„í–‰:', e);
    });
});

// ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œê·¸ì¸ ì •ë³´ ë³µì›
function loadSavedLogin() {
    if (!supabase) return Promise.resolve(false);
    
    return supabase.auth.getSession().then(function(result) {
        var session = result.data.session;
        if (session && session.user) {
            // í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            return supabase
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single()
                .then(function(profileResult) {
                    var profile = profileResult.data;
                    if (profile) {
                        mpUser = {
                            id: session.user.id,
                            username: profile.username,
                            nickname: profile.nickname,
                            email: profile.email,
                            coins: profile.coins,
                            exp: profile.exp || 0,
                            currentShip: profile.current_ship,
                            unlockedShips: profile.unlocked_ships,
                            avatar_url: profile.avatar_url
                        };
                        mpUserId = session.user.id;
                        mpSessionToken = generateSessionToken();  // â˜…â˜…â˜… ì¤‘ë³µ ì ‘ì† ê°ì§€ìš© â˜…â˜…â˜…
                        mpNickname = profile.nickname;

                        // window ê°ì²´ì—ë„ ì„¤ì •
                        window.mpUser = mpUser;
                        window.mpUserId = mpUserId;
                        window.mpNickname = mpNickname;
                        window.currentUser = profile.username;
                        
                        // UI ì—…ë°ì´íŠ¸
                        if (typeof updateUserUI === 'function') {
                            updateUserUI();
                        }
                        
                        // â˜…â˜…â˜… ë©”ì¸ ë©”ë‰´ ë¡œê·¸ì¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸° â˜…â˜…â˜…
                        const loginMainBtn = document.getElementById('btn-login-main');
                        if (loginMainBtn) {
                            loginMainBtn.style.display = 'none';
                        }
                        
                        console.log('âœ… ìë™ ë¡œê·¸ì¸:', profile.nickname);
                        return true;
                    }
                    return false;
                });
        }
        return false;
    }).catch(function(e) {
        console.log('ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨:', e);
        return false;
    });
}

// ============ ë¡œê·¸ì¸ ì°½ ì—´ê¸° ============
function openAuthUI() {
    // â˜… ì´ë¯¸ ì •ì‹ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ì—´ì§€ ì•ŠìŒ (ê²ŒìŠ¤íŠ¸ëŠ” ì¬ë¡œê·¸ì¸ í—ˆìš©)
    const isGuest = window.mpUserId && window.mpUserId.indexOf('guest_') === 0;
    if (window.mpUser && !isGuest) {
        if (typeof showMsg === 'function') {
            showMsg('âœ… Already logged in.');
        }
        return;
    }
    
    // auth-overlayê°€ ì—†ìœ¼ë©´ ìƒì„±
    if (!document.getElementById('auth-overlay')) {
        if (typeof createAuthUI === 'function') {
            createAuthUI();
        }
    }
    // ì°½ í‘œì‹œ
    var ao = document.getElementById('auth-overlay');
    if (ao) {
        ao.style.display = 'flex';
    }
}

function closeAuthUI() {
    var ao = document.getElementById('auth-overlay');
    if (ao) {
        ao.style.display = 'none';
    }
}

// ============ ë¡œê·¸ì¸/íšŒì›ê°€ì… UI ============
function createAuthUI() {
    // t() í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì˜ì–´ ë°˜í™˜
    const _t = (key) => {
        if (typeof t === 'function') return t(key);
        const defaults = {
            login: 'Login', register: 'Register', emailAddress: 'Email Address',
            password: 'Password', passwordConfirm: 'Confirm Password',
            nickname: 'Nickname', nicknameDesc: '(Displayed in game)',
            email: 'Email', emailRequired: '(Required)',
            emailVerifyNote: 'â€» Please enter a valid email. Verification email will be sent.',
            privacyPolicy: 'Privacy Policy', termsOfService: 'Terms of Service',
            agreeToTerms: ' - I agree', guestStart: 'Start as Guest (Not saved)'
        };
        return defaults[key] || key;
    };
    
    const authUI = document.createElement('div');
    authUI.id = 'auth-ui';
    authUI.innerHTML = `
        <style>
            #auth-overlay {
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 10, 30, 0.95);
                z-index: 99999;
                display: none;
                justify-content: center;
                align-items: center;
                overflow-y: auto;
                padding: 20px 0;
            }
            #auth-box {
                background: linear-gradient(180deg, #0a1628 0%, #162a4a 100%);
                border: 2px solid #0ff;
                border-radius: 20px;
                padding: 40px;
                width: 350px;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                margin: auto;
                box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
            }
            #auth-box h2 {
                color: #0ff;
                text-align: center;
                margin-bottom: 30px;
                font-family: 'Orbitron', sans-serif;
                font-size: 24px;
            }
            #auth-box h2::before {
                content: "ğŸš€ ";
            }
            .auth-input {
                width: 100%;
                padding: 12px 15px;
                margin-bottom: 15px;
                background: rgba(0, 50, 80, 0.6);
                border: 1px solid #0ff;
                border-radius: 8px;
                color: #fff;
                font-size: 14px;
                box-sizing: border-box;
            }
            .auth-input:focus {
                outline: none;
                box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            }
            .auth-input::placeholder {
                color: #68a;
            }
            .auth-btn {
                width: 100%;
                padding: 12px;
                margin-top: 10px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                font-family: 'Orbitron', sans-serif;
                transition: all 0.3s;
            }
            .auth-btn-primary {
                background: linear-gradient(90deg, #0ff, #00f);
                color: #000;
            }
            .auth-btn-primary:hover {
                transform: scale(1.02);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            }
            .auth-btn-secondary {
                background: transparent;
                color: #0ff;
                border: 1px solid #0ff;
            }
            .auth-btn-secondary:hover {
                background: rgba(0, 255, 255, 0.1);
            }
            .auth-btn-guest {
                background: transparent;
                color: #888;
                border: 1px solid #444;
                margin-top: 20px;
            }
            .auth-switch {
                text-align: center;
                margin-top: 20px;
                color: #68a;
                font-size: 13px;
            }
            .auth-switch a {
                color: #0ff;
                cursor: pointer;
                text-decoration: underline;
            }
            .auth-error {
                color: #f55;
                text-align: center;
                margin-bottom: 15px;
                font-size: 13px;
            }
            .auth-tabs {
                display: flex;
                margin-bottom: 25px;
            }
            .auth-tab {
                flex: 1;
                padding: 10px;
                text-align: center;
                color: #68a;
                cursor: pointer;
                border-bottom: 2px solid #234;
                transition: all 0.3s;
            }
            .auth-tab.active {
                color: #0ff;
                border-bottom-color: #0ff;
            }
            #register-fields { display: none; }
            .auth-agree {
                margin: 10px 0;
                font-size: 12px;
                color: #8ab;
            }
            .auth-agree label {
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
            }
            .auth-agree input[type="checkbox"] {
                width: 18px;
                height: 18px;
                accent-color: #0ff;
                cursor: pointer;
            }
            .auth-agree a {
                color: #0ff;
                text-decoration: underline;
            }
            .auth-agree a:hover {
                color: #fff;
            }
            .auth-close-btn {
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: 1px solid #0ff;
                color: #0ff;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 16px;
            }
            .auth-close-btn:hover {
                background: rgba(0,255,255,0.2);
            }
        </style>
        <div id="auth-overlay">
            <div id="auth-box" style="position:relative;">
                <button class="auth-close-btn" onclick="closeAuthUI()">âœ•</button>
                <h2>STARÂ·WALKER</h2>
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="showLoginTab()">${_t('login')}</div>
                    <div class="auth-tab" onclick="showRegisterTab()">${_t('register')}</div>
                </div>
                <div id="auth-error" class="auth-error"></div>
                
                <input type="text" id="auth-username" class="auth-input" placeholder="${_t('emailAddress')}" maxlength="100">
                <input type="password" id="auth-password" class="auth-input" placeholder="${_t('password')}" maxlength="30">
                
                <div id="register-fields">
                    <input type="password" id="auth-password2" class="auth-input" placeholder="${_t('passwordConfirm')}" maxlength="30">
                    <input type="text" id="auth-nickname" class="auth-input" placeholder="${_t('nickname')} ${_t('nicknameDesc')}" maxlength="15">
                    <input type="email" id="auth-email" class="auth-input" placeholder="${_t('email')} ${_t('emailRequired')}" maxlength="100" required>
                    <div style="font-size: 11px; color: #8ab; margin-bottom: 10px;">
                        ${_t('emailVerifyNote')}
                    </div>
                    <div class="auth-agree">
                        <label>
                            <input type="checkbox" id="auth-privacy-agree">
                            <span><a href="privacy.html" target="_blank">${_t('privacyPolicy')}</a>${_t('agreeToTerms')}</span>
                        </label>
                    </div>
                    <div class="auth-agree">
                        <label>
                            <input type="checkbox" id="auth-terms-agree">
                            <span><a href="terms.html" target="_blank">${_t('termsOfService')}</a>${_t('agreeToTerms')}</span>
                        </label>
                    </div>
                </div>
                
                <button id="auth-submit-btn" class="auth-btn auth-btn-primary" onclick="submitAuth()">${_t('login')}</button>
                <button class="auth-btn auth-btn-guest" onclick="guestLogin()">${_t('guestStart')}</button>
            </div>
        </div>
    `;
    
    // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€
    const existingUI = document.getElementById('auth-ui');
    if (existingUI) {
        existingUI.remove();
    }
    
    document.body.appendChild(authUI);
    
    // â˜…â˜…â˜… ì˜¤ë²„ë ˆì´ í‘œì‹œ â˜…â˜…â˜…
    setTimeout(() => {
        const overlay = document.getElementById('auth-overlay');
        if (overlay) {
            overlay.style.display = 'flex';
        }
    }, 50);
    
    // ì—”í„°í‚¤ ë¡œê·¸ì¸
    document.getElementById('auth-password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isRegisterMode) submitAuth();
    });
}

let isRegisterMode = false;

function showLoginTab() {
    isRegisterMode = false;
    document.querySelectorAll('.auth-tab')[0].classList.add('active');
    document.querySelectorAll('.auth-tab')[1].classList.remove('active');
    document.getElementById('register-fields').style.display = 'none';
    document.getElementById('auth-submit-btn').textContent = t('login');
    document.getElementById('auth-error').textContent = '';
}

function showRegisterTab() {
    isRegisterMode = true;
    document.querySelectorAll('.auth-tab')[0].classList.remove('active');
    document.querySelectorAll('.auth-tab')[1].classList.add('active');
    document.getElementById('register-fields').style.display = 'block';
    document.getElementById('auth-submit-btn').textContent = t('register');
    document.getElementById('auth-error').textContent = '';
}

function submitAuth() {
    var username = document.getElementById('auth-username').value.trim();
    var password = document.getElementById('auth-password').value;
    var errorEl = document.getElementById('auth-error');
    
    if (!username || !password) {
        errorEl.textContent = t('enterEmailPassword');
        return;
    }
    
    if (isRegisterMode) {
        // íšŒì›ê°€ì…
        var password2 = document.getElementById('auth-password2').value;
        var nickname = document.getElementById('auth-nickname').value.trim();
        var email = document.getElementById('auth-email').value.trim();
        var privacyAgree = document.getElementById('auth-privacy-agree').checked;
        var termsAgree = document.getElementById('auth-terms-agree').checked;
        
        if (password !== password2) {
            errorEl.textContent = t('passwordsNotMatch');
            return;
        }
        if (!nickname) {
            errorEl.textContent = t('enterNickname');
            return;
        }
        // ì´ë©”ì¼ í•„ìˆ˜ ì²´í¬
        if (!email) {
            errorEl.textContent = t('enterEmailRequired');
            return;
        }
        if (!email.includes('@') || !email.includes('.')) {
            errorEl.textContent = t('invalidEmailFormat');
            return;
        }
        if (!privacyAgree) {
            errorEl.textContent = t('agreePrivacy');
            return;
        }
        if (!termsAgree) {
            errorEl.textContent = t('agreeTerms');
            return;
        }
        
        if (!supabase) {
            errorEl.textContent = t('connectingServer');
            return;
        }
        
        console.log('ğŸ“ Registration attempt:', email, nickname);
        
        // ì¸ì¦ ëŒ€ê¸°ìš© ì •ë³´ ì €ì¥
        window.pendingVerification = {
            email: email,
            password: password,
            username: username,
            nickname: nickname
        };
        
        // Supabase íšŒì›ê°€ì…
        supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    username: username,
                    nickname: nickname
                }
            }
        }).then(function(result) {
            console.log('ğŸ“ Registration result:', result);
            
            if (result.error) {
                console.error('âŒ Registration error:', result.error);
                if (result.error.message.includes('already registered')) {
                    errorEl.textContent = t('emailAlreadyRegistered');
                } else if (result.error.message.includes('valid email')) {
                    errorEl.textContent = t('enterValidEmail');
                } else {
                    errorEl.textContent = result.error.message;
                }
            } else {
                console.log('âœ… Registration request success');
                
                // ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•œì§€ í™•ì¸
                if (result.data.user && !result.data.session) {
                    // ì´ë©”ì¼ ì¸ì¦ í•„ìš”
                    console.log('ğŸ“§ Email verification required');
                    showEmailVerifyPanel(email);
                } else if (result.data.session) {
                    // ì¸ì¦ ì—†ì´ ë°”ë¡œ ë¡œê·¸ì¸ë¨ (ì´ë©”ì¼ í™•ì¸ ë¹„í™œì„±í™”ëœ ê²½ìš°)
                    console.log('âœ… Logged in directly');
                    processLogin(result.data.user, username, nickname);
                } else {
                    // íšŒì›ê°€ì… ì„±ê³µ, ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
                    errorEl.style.color = '#0f0';
                    errorEl.textContent = t('registrationComplete');
                    showLoginTab();
                    document.getElementById('auth-username').value = email;
                    document.getElementById('auth-password').value = '';
                }
            }
        }).catch(function(e) {
            console.error('âŒ Registration catch:', e);
            errorEl.textContent = t('serverConnectionFailed') + e.message;
        });
    } else {
        // ë¡œê·¸ì¸
        if (!supabase) {
            errorEl.textContent = t('connectingServer');
            return;
        }
        
        // ì´ë©”ì¼ í˜•ì‹ ì²´í¬
        var loginEmail = username;
        if (!loginEmail.includes('@')) {
            errorEl.textContent = t('enterEmailExample');
            return;
        }
        
        console.log('ğŸ” Login attempt:', loginEmail);
        
        supabase.auth.signInWithPassword({
            email: loginEmail,
            password: password
        }).then(function(result) {
            console.log('ğŸ” Login result:', result);
            
            if (result.error) {
                console.error('âŒ Login error:', result.error);
                
                // ì—ëŸ¬ ë©”ì‹œì§€ ë¶„ê¸°
                if (result.error.message.includes('Email not confirmed')) {
                    errorEl.style.color = '#fa0';
                    errorEl.innerHTML = t('emailVerificationRequired');
                    
                    // ì¸ì¦ ëŒ€ê¸° ì •ë³´ ì €ì¥
                    window.pendingVerification = {
                        email: loginEmail,
                        password: password,
                        username: loginEmail.split('@')[0],
                        nickname: loginEmail.split('@')[0]
                    };
                } else if (result.error.message.includes('Invalid login')) {
                    errorEl.textContent = t('invalidEmailOrPassword');
                } else {
                    errorEl.textContent = t('loginFailed') + result.error.message;
                }
                return;
            }
            
            var user = result.data.user;
            console.log('âœ… ì¸ì¦ ì„±ê³µ, ì‚¬ìš©ì:', user.id);
            
            // ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´ ì„¤ì • (profiles í…Œì´ë¸” ì—†ì–´ë„ ë™ì‘)
            mpUser = {
                id: user.id,
                username: username,
                nickname: username,
                email: user.email,
                coins: 1000,
                currentShip: 'shuttle',
                unlockedShips: ['shuttle']
            };
            mpUserId = user.id;
            mpSessionToken = generateSessionToken();  // â˜…â˜…â˜… ì¤‘ë³µ ì ‘ì† ê°ì§€ìš© â˜…â˜…â˜…
            mpNickname = username;

            // window ê°ì²´ì—ë„ ì„¤ì •
            window.mpUser = mpUser;
            window.mpUserId = mpUserId;
            window.mpNickname = mpNickname;
            window.currentUser = mpUser.username;
            
            // í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
            supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single()
                .then(function(profileResult) {
                    console.log('ğŸ“‹ í”„ë¡œí•„ ì¡°íšŒ ê²°ê³¼:', profileResult);
                    
                    if (profileResult.data) {
                        var profile = profileResult.data;
                        mpUser.username = profile.username || username;
                        mpUser.nickname = profile.nickname || username;
                        mpUser.coins = profile.coins || 1000;
                        mpUser.exp = profile.exp || 0;
                        mpUser.avatar_url = profile.avatar_url || null;
                        mpUser.currentShip = profile.current_ship || 'shuttle';
                        mpUser.unlockedShips = profile.unlocked_ships || ['shuttle'];
                        mpNickname = mpUser.nickname;
                        
                        window.mpUser = mpUser;
                        window.mpNickname = mpNickname;
                    }
                    
                    finishLogin();
                })
                .catch(function(e) {
                    console.warn('âš ï¸ í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ì§„í–‰):', e);
                    finishLogin();
                });
            
            function finishLogin() {
                // UI ì—…ë°ì´íŠ¸
                if (typeof updateUserUI === 'function') {
                    updateUserUI();
                }
                
                console.log('âœ… Supabase ë¡œê·¸ì¸ ì„±ê³µ:', mpUser.nickname);
                
                // ë¡œê·¸ì¸ UI ë‹«ê¸°
                document.getElementById('auth-overlay').style.display = 'none';
                
                // ë©€í‹°í”Œë ˆì´ì–´ UI ì¤€ë¹„
                if (!document.getElementById('multiplayer-ui')) {
                    createMultiplayerUI();
                }
                var mpUI = document.getElementById('multiplayer-ui');
                if (mpUI) mpUI.style.display = 'none';
                console.log('ë©€í‹°í”Œë ˆì´ì–´ ë¡œê·¸ì¸ ì™„ë£Œ');
                
                // â˜…â˜…â˜… ì €ì¥ëœ ìš°ì£¼ì„  ìœ„ì¹˜ í™•ì¸ â˜…â˜…â˜…
                if (typeof checkSavedShipOnLogin === 'function') {
                    checkSavedShipOnLogin();
                }
            }
        }).catch(function(e) {
            console.error('âŒ ë¡œê·¸ì¸ catch:', e);
            errorEl.textContent = 'Server connection failed: ' + e.message;
        });
    }
}

// ì´ë©”ì¼ ì¸ì¦ ëŒ€ê¸° í™”ë©´ í‘œì‹œ
function showEmailVerifyPanel(email) {
    // í¼ ìˆ¨ê¸°ê¸°
    document.getElementById('auth-username').style.display = 'none';
    document.getElementById('auth-password').style.display = 'none';
    document.getElementById('register-fields').style.display = 'none';
    document.getElementById('auth-submit-btn').style.display = 'none';
    document.querySelector('.auth-btn-guest').style.display = 'none';
    document.querySelector('.auth-tabs').style.display = 'none';
    document.getElementById('auth-error').style.display = 'none';
    
    // ì¸ì¦ ëŒ€ê¸° í™”ë©´ í‘œì‹œ
    document.getElementById('email-verify-panel').style.display = 'block';
    document.getElementById('verify-email-display').textContent = email + ' ìœ¼ë¡œ ì¸ì¦ ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤';
}

// ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
function backToLogin() {
    // í¼ ë‹¤ì‹œ í‘œì‹œ
    document.getElementById('auth-username').style.display = 'block';
    document.getElementById('auth-password').style.display = 'block';
    document.getElementById('auth-submit-btn').style.display = 'block';
    document.querySelector('.auth-btn-guest').style.display = 'block';
    document.querySelector('.auth-tabs').style.display = 'flex';
    document.getElementById('auth-error').style.display = 'block';
    
    // ì¸ì¦ ëŒ€ê¸° í™”ë©´ ìˆ¨ê¸°ê¸°
    document.getElementById('email-verify-panel').style.display = 'none';
    
    // ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ
    showLoginTab();
    
    // ì´ë©”ì¼ë¡œ ì•„ì´ë”” í•„ë“œ ì±„ìš°ê¸°
    if (window.pendingVerification && window.pendingVerification.email) {
        document.getElementById('auth-username').value = window.pendingVerification.email;
    }
}

// ì´ë©”ì¼ ì¸ì¦ í™•ì¸ í›„ ë¡œê·¸ì¸ ì‹œë„
function checkEmailVerified() {
    var statusEl = document.getElementById('verify-status');
    
    if (!window.pendingVerification) {
        statusEl.style.color = '#f55';
        statusEl.textContent = t('noAuthInfo');
        return;
    }
    
    statusEl.style.color = '#0ff';
    statusEl.textContent = t('verifying');
    
    var email = window.pendingVerification.email;
    var password = window.pendingVerification.password;
    
    // ë¡œê·¸ì¸ ì‹œë„
    supabase.auth.signInWithPassword({
        email: email,
        password: password
    }).then(function(result) {
        console.log('ğŸ” ì¸ì¦ í™•ì¸ ë¡œê·¸ì¸ ê²°ê³¼:', result);
        
        if (result.error) {
            if (result.error.message.includes('Email not confirmed')) {
                statusEl.style.color = '#f55';
                statusEl.textContent = t('emailPending');
            } else {
                statusEl.style.color = '#f55';
                statusEl.textContent = t('loginFailedMsg') + result.error.message;
            }
        } else {
            statusEl.style.color = '#0f0';
            statusEl.textContent = t('verified');
            
            // ë¡œê·¸ì¸ ì²˜ë¦¬
            var user = result.data.user;
            var pending = window.pendingVerification;
            processLogin(user, pending.username, pending.nickname);
        }
    }).catch(function(e) {
        statusEl.style.color = '#f55';
        statusEl.textContent = t('serverError') + e.message;
    });
}

// ì¸ì¦ ë©”ì¼ ì¬ë°œì†¡
function resendVerificationEmail() {
    var statusEl = document.getElementById('verify-status');
    
    if (!window.pendingVerification || !window.pendingVerification.email) {
        statusEl.style.color = '#f55';
        statusEl.textContent = t('emailNotFound');
        return;
    }
    
    statusEl.style.color = '#0ff';
    statusEl.textContent = t('sendingEmail');
    
    supabase.auth.resend({
        type: 'signup',
        email: window.pendingVerification.email
    }).then(function(result) {
        console.log('ğŸ“¨ ì¬ë°œì†¡ ê²°ê³¼:', result);
        
        if (result.error) {
            statusEl.style.color = '#f55';
            statusEl.textContent = t('resendFailed') + result.error.message;
        } else {
            statusEl.style.color = '#0f0';
            statusEl.textContent = t('resendSuccess');
        }
    }).catch(function(e) {
        statusEl.style.color = '#f55';
        statusEl.textContent = t('serverError') + e.message;
    });
}

// ë¡œê·¸ì¸ ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜
function processLogin(user, username, nickname) {
    // í”„ë¡œí•„ ì¡°íšŒ ë° ì„¤ì •
    mpUser = {
        id: user.id,
        username: username || user.email,
        nickname: nickname || username || user.email.split('@')[0],
        email: user.email,
        coins: 1000,
        currentShip: 'shuttle',
        unlockedShips: ['shuttle']
    };
    mpUserId = user.id;
    mpSessionToken = generateSessionToken();  // â˜…â˜…â˜… ì¤‘ë³µ ì ‘ì† ê°ì§€ìš© â˜…â˜…â˜…
    mpNickname = mpUser.nickname;

    window.mpUser = mpUser;
    window.mpUserId = mpUserId;
    window.mpNickname = mpNickname;
    window.currentUser = mpUser.username;

    // í”„ë¡œí•„ ì¡°íšŒ ì‹œë„
    supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single()
        .then(function(profileResult) {
            if (profileResult.data) {
                var profile = profileResult.data;
                mpUser.username = profile.username || mpUser.username;
                mpUser.nickname = profile.nickname || mpUser.nickname;
                mpUser.coins = profile.coins || 1000;
                mpUser.currentShip = profile.current_ship || 'shuttle';
                mpUser.unlockedShips = profile.unlocked_ships || ['shuttle'];
                mpNickname = mpUser.nickname;
                
                window.mpUser = mpUser;
                window.mpNickname = mpNickname;
            }
            completeLogin();
        })
        .catch(function(e) {
            console.warn('í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:', e);
            completeLogin();
        });
    
    function completeLogin() {
        if (typeof updateUserUI === 'function') {
            updateUserUI();
        }
        
        console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', mpUser.nickname);
        
        document.getElementById('auth-overlay').style.display = 'none';
        
        if (!document.getElementById('multiplayer-ui')) {
            createMultiplayerUI();
        }
        var mpUI = document.getElementById('multiplayer-ui');
        if (mpUI) mpUI.style.display = 'none';
        
        window.pendingVerification = null;
    }
}

function guestLogin() {
    // â˜…â˜…â˜… UUID í˜•ì‹ìœ¼ë¡œ ìƒì„± (í…Œì´ë¸”ì´ uuid íƒ€ì…) â˜…â˜…â˜…
    mpUserId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
    mpSessionToken = generateSessionToken();  // â˜…â˜…â˜… ì¤‘ë³µ ì ‘ì† ê°ì§€ìš© â˜…â˜…â˜…
    mpNickname = 'íƒí—˜ê°€' + Math.floor(Math.random() * 9999);
    mpUser = null;

    // â˜… window ê°ì²´ì—ë„ ì„¤ì •
    window.mpUserId = mpUserId;
    window.mpNickname = mpNickname;
    window.mpUser = null;
    
    document.getElementById('auth-overlay').style.display = 'none';
    
    // â˜… UI ì—…ë°ì´íŠ¸ (ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ìƒíƒœ ë°˜ì˜)
    if (typeof updateUserUI === 'function') {
        updateUserUI();
    }
    
    // ë©€í‹°í”Œë ˆì´ì–´ UI ì¤€ë¹„ (ê²Œì„ ëª¨ë“œ ì„ íƒ í›„ ì‹œì‘ë¨)
    if (!document.getElementById('multiplayer-ui')) {
        createMultiplayerUI();
    }
    const mpUI = document.getElementById('multiplayer-ui');
    if (mpUI) mpUI.style.display = 'none';
    console.log('ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ì™„ë£Œ (ê²Œì„ ëª¨ë“œ ì„ íƒ ëŒ€ê¸° ì¤‘)');
}

function logout() {
    var doLogout = function() {
        localStorage.removeItem('solar_user');
        mpUser = null;
        mpUserId = null;
        mpSessionToken = null;
        window.mpUser = null;
        window.mpUserId = null;
        window.currentUser = null;
        location.reload();
    };
    
    if (supabase) {
        supabase.auth.signOut().then(doLogout).catch(doLogout);
    } else {
        doLogout();
    }
}

// ============ ë©€í‹°í”Œë ˆì´ì–´ UI ============
function createMultiplayerUI() {
    const mpUI = document.createElement('div');
    mpUI.id = 'multiplayer-ui';
    mpUI.innerHTML = `
        <style>
            #multiplayer-ui {
                position: fixed;
                top: 60px;
                right: 10px;
                z-index: 10000;
                font-family: 'Orbitron', sans-serif;
            }
            #mp-toggle {
                background: rgba(0, 20, 40, 0.9);
                border: 1px solid #0ff;
                color: #0ff;
                padding: 8px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 12px;
                display: block;
                margin-bottom: 5px;
            }
            #mp-toggle:hover {
                background: rgba(0, 100, 150, 0.9);
            }
            #mp-panel {
                background: rgba(0, 20, 40, 0.9);
                border: 1px solid #0ff;
                border-radius: 10px;
                padding: 15px;
                color: #0ff;
                width: 250px;
                max-height: 60vh;
                overflow-y: auto;
                display: block;
            }
            #mp-panel.hidden {
                display: none;
            }
            #mp-user-info {
                font-size: 14px;
                margin-bottom: 10px;
                padding-bottom: 10px;
                border-bottom: 1px solid #234;
            }
            #mp-online {
                font-size: 12px;
                margin-bottom: 10px;
                color: #0f0;
            }
            #mp-chat-container {
                max-height: 150px;
                overflow-y: auto;
                font-size: 11px;
                background: rgba(0, 0, 0, 0.5);
                padding: 5px;
                border-radius: 5px;
                margin-bottom: 5px;
            }
            #mp-chat-container::-webkit-scrollbar { width: 5px; }
            #mp-chat-container::-webkit-scrollbar-thumb { background: #0ff; border-radius: 5px; }
            .mp-chat-msg { margin: 3px 0; word-break: break-word; display: flex; flex-wrap: wrap; align-items: baseline; gap: 5px; }
            .mp-chat-msg .nick { color: #ff0; }
            .mp-chat-msg .msg-text { flex: 1; }
            .mp-chat-msg .msg-time { color: #666; font-size: 8px; margin-left: auto; white-space: nowrap; }
            #mp-chat-input {
                width: calc(100% - 50px);
                padding: 5px;
                background: rgba(0, 50, 80, 0.8);
                border: 1px solid #0ff;
                border-radius: 3px;
                color: #fff;
                font-size: 11px;
            }
            #mp-chat-send {
                width: 45px;
                padding: 5px;
                background: #0ff;
                border: none;
                border-radius: 3px;
                color: #000;
                cursor: pointer;
                font-size: 11px;
            }
            #mp-logout {
                font-size: 10px;
                color: #f88;
                cursor: pointer;
                margin-left: 10px;
            }
            .mp-player-label {
                color: #0ff;
                font-size: 10px;
                background: rgba(0, 0, 0, 0.7);
                padding: 2px 5px;
                border-radius: 3px;
            }
        </style>
        <button id="mp-toggle">ğŸ’¬ ì±„íŒ…</button>
        <div id="mp-panel">
            <div id="mp-user-info">
                ğŸ‘¤ <span id="mp-nickname-display">${mpNickname}</span>
                ${mpUser ? '' : ' (ê²ŒìŠ¤íŠ¸)'}
            </div>
            <div id="mp-online"><span data-i18n="playersOnline">ğŸŸ¢ ì ‘ì†ì</span>: 1<span data-i18n="playersCount">ëª…</span></div>
            <div id="mp-chat-container"></div>
            <div>
                <input type="text" id="mp-chat-input" placeholder="ì±„íŒ…..." data-placeholder-i18n="chatTab" maxlength="100">
                <button id="mp-chat-send" onclick="sendChat()" data-i18n="send">ì „ì†¡</button>
            </div>
        </div>
    `;
    document.body.appendChild(mpUI);
    
    // í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('mp-toggle').addEventListener('click', toggleMpPanel);
    
    document.getElementById('mp-chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChat();
    });
    
    // ë“œë˜ê·¸ ì‹œìŠ¤í…œì— ë“±ë¡
    if (window.draggableUISystem && window.draggableUISystem.initialized) {
        const el = document.getElementById('multiplayer-ui');
        if (el) {
            el.classList.add('draggable-ui');
            el.dataset.draggable = 'true';
            window.draggableUISystem.elements.push(el);
            window.draggableUISystem.attachEvents(el);
            console.log('ë“œë˜ê·¸ ë“±ë¡: multiplayer-ui');
        }
    }
}

let mpPanelVisible = true;
function toggleMpPanel() {
    mpPanelVisible = !mpPanelVisible;
    const panel = document.getElementById('mp-panel');
    const btn = document.getElementById('mp-toggle');
    if (panel) {
        panel.classList.toggle('hidden', !mpPanelVisible);
    }
    if (btn) {
        btn.textContent = mpPanelVisible ? 'ğŸ’¬ ì±„íŒ…' : 'ğŸ’¬ ì±„íŒ… â–¶';
    }
}

// ============ ì„œë²„ í†µì‹  ============

function mpSendMyPosition(forceUpdate = false) {
    var ship = window.playerShip;
    if (!ship || !ship.mesh) return;
    if (!supabase) return;
    if (!mpUserId) return;

    var pos = ship.mesh.position;
    var rot = ship.mesh.rotation;

    // â˜…â˜…â˜… ë¸íƒ€ ì••ì¶•: ìœ„ì¹˜/íšŒì „ ë³€ê²½ í™•ì¸ â˜…â˜…â˜…
    var posChanged = Math.abs(pos.x - mpLastSentPosition.x) > MP_POSITION_THRESHOLD ||
                     Math.abs(pos.y - mpLastSentPosition.y) > MP_POSITION_THRESHOLD ||
                     Math.abs(pos.z - mpLastSentPosition.z) > MP_POSITION_THRESHOLD;

    var rotChanged = Math.abs(rot.x - mpLastSentRotation.x) > MP_ROTATION_THRESHOLD ||
                     Math.abs(rot.y - mpLastSentRotation.y) > MP_ROTATION_THRESHOLD ||
                     Math.abs(rot.z - mpLastSentRotation.z) > MP_ROTATION_THRESHOLD;

    // 5ì´ˆë§ˆë‹¤ ê°•ì œ ì—…ë°ì´íŠ¸ (í•˜íŠ¸ë¹„íŠ¸)
    mpForceUpdateCounter++;
    var heartbeat = mpForceUpdateCounter >= 50; // 100ms * 50 = 5ì´ˆ

    // ë³€ê²½ ì—†ê³  ê°•ì œ ì—…ë°ì´íŠ¸ë„ ì•„ë‹ˆë©´ ìŠ¤í‚µ
    if (!posChanged && !rotChanged && !heartbeat && !forceUpdate) {
        return;
    }

    if (heartbeat) mpForceUpdateCounter = 0;

    // ë§ˆì§€ë§‰ ìƒíƒœ ì €ì¥
    mpLastSentPosition = { x: pos.x, y: pos.y, z: pos.z };
    mpLastSentRotation = { x: rot.x, y: rot.y, z: rot.z };
    mpLastSentTime = Date.now();

    var shipType = 'shuttle';
    if (typeof SHIP_TYPES !== 'undefined' && window.selectedShipIndex !== undefined) {
        shipType = SHIP_TYPES[window.selectedShipIndex] ? SHIP_TYPES[window.selectedShipIndex].id : 'shuttle';
    }

    // ìš°ì£¼ì„  ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
    var shipColor = '#00aaff';
    if (typeof SHIP_TYPES !== 'undefined' && window.selectedShipIndex !== undefined) {
        var shipData = SHIP_TYPES[window.selectedShipIndex];
        if (shipData && shipData.color) {
            // â˜… hex ìˆ«ìë¥¼ ì˜¬ë°”ë¥¸ hex ë¬¸ìì—´ë¡œ ë³€í™˜
            shipColor = '#' + shipData.color.toString(16).padStart(6, '0');
        }
    }

    // ìƒíƒœ ê²°ì •
    var status = 'flying';
    if (window.autopilot && window.autopilot.engaged) {
        status = 'autopilot';
    } else if (ship.speed < 1) {
        status = 'idle';
    }

    // â˜…â˜…â˜… ìœ„ì¹˜ ë°ì´í„° â˜…â˜…â˜…
    var data = {
        user_id: mpUserId,
        nickname: mpNickname,
        x: pos.x,
        y: pos.y,
        z: pos.z,
        rot_x: rot.x,
        rot_y: rot.y,
        rot_z: rot.z,
        ship_type: shipType,
        ship_color: shipColor,
        status: status,
        current_body: window.focusedBody ? window.focusedBody.name : null
    };

    // â˜…â˜…â˜… user_idê°€ PRIMARY KEYë©´ onConflict ë¶ˆí•„ìš” â˜…â˜…â˜…
    supabase
        .from('player_positions')
        .upsert(data)
        .then(function(result) {
            if (result.error) {
                console.log('MP ìœ„ì¹˜ ì „ì†¡ ì—ëŸ¬:', result.error.message);
            }
        })
        .catch(function(e) {
            console.log('MP ìœ„ì¹˜ ì „ì†¡ ì‹¤íŒ¨:', e);
        });
}

function mpGetOtherPlayers() {
    if (!supabase) {
        console.log('âš ï¸ mpGetOtherPlayers: supabase ì—†ìŒ');
        return;
    }
    if (!mpUserId) {
        console.log('âš ï¸ mpGetOtherPlayers: mpUserId ì—†ìŒ');
        return;
    }

    // â˜…â˜…â˜… ì›ë˜ user_idë¡œ ìê¸° ìì‹  ì œì™¸ â˜…â˜…â˜…
    supabase
        .from('player_positions')
        .select('*')
        .neq('user_id', mpUserId)
        .then(function(result) {
            var players = result.data;
            var error = result.error;

            console.log('ğŸ“¡ player_positions ì¡°íšŒ ê²°ê³¼:', {
                players: players ? players.length : 0,
                error: error,
                myUserId: mpUserId
            });

            if (error) {
                console.log('MP í”Œë ˆì´ì–´ ì¡°íšŒ ì—ëŸ¬:', error.message);
                return;
            }

            // í”Œë ˆì´ì–´ê°€ ì—†ì–´ë„ updateOtherPlayers í˜¸ì¶œ (ê¸°ì¡´ í”Œë ˆì´ì–´ ì œê±°ìš©)
            var formattedPlayers = (players || []).map(function(p) {
                console.log('   - í”Œë ˆì´ì–´ ë°œê²¬:', p.user_id, p.nickname, 'x:', p.x, 'y:', p.y, 'z:', p.z);
                return {
                    user_id: p.user_id,
                    nickname: p.nickname || 'ìµëª…',
                    pos_x: p.x || 0,
                    pos_y: p.y || 0,
                    pos_z: p.z || 0,
                    rot_x: p.rot_x || 0,
                    rot_y: p.rot_y || 0,
                    rot_z: p.rot_z || 0,
                    ship_type: p.ship_type || 'shuttle',
                    ship_color: p.ship_color || '#00aaff',
                    status: p.status || 'flying',
                    current_location: p.current_body
                };
            });

            console.log('ğŸ“¡ ë‹¤ë¥¸ í”Œë ˆì´ì–´:', formattedPlayers.length, 'ëª…');
            updateOtherPlayers(formattedPlayers);

            var onlineEl = document.getElementById('mp-online');
            if (onlineEl) {
                onlineEl.textContent = t('playersOnline') + ': ' + (formattedPlayers.length + 1) + t('playersCount');
            }
        })
        .catch(function(e) {
            console.log('MP í”Œë ˆì´ì–´ ì¡°íšŒ ì‹¤íŒ¨:', e);
        });
}

function updateOtherPlayers(players) {
    const activeIds = new Set();

    players.forEach(player => {
        activeIds.add(player.user_id);

        // â˜…â˜…â˜… ê¸°ì¡´ ë©”ì‹œ ë²„ì „ ì²´í¬ - ì—†ìœ¼ë©´ ê°•ì œ ì¬ìƒì„± â˜…â˜…â˜…
        const existing = mpOtherPlayers[player.user_id];
        if (existing && !existing._v2) {
            // êµ¬ë²„ì „ ë©”ì‹œ ì œê±°
            console.log('ğŸ”„ êµ¬ë²„ì „ ë©”ì‹œ ì œê±°:', player.user_id);
            if (window.scene) window.scene.remove(existing.mesh);
            delete mpOtherPlayers[player.user_id];
        }

        if (!mpOtherPlayers[player.user_id]) {
            // ìƒˆ í”Œë ˆì´ì–´ ìƒì„±
            createOtherPlayerShip(player);
        } else {
            // â˜…â˜…â˜… ë°±ì—… ìŠ¤íƒ€ì¼: ì§ì ‘ lerp (ë‹¨ìˆœí•˜ê³  í™•ì‹¤) â˜…â˜…â˜…
            const ship = mpOtherPlayers[player.user_id];
            ship.mesh.position.lerp(
                new THREE.Vector3(
                    parseFloat(player.pos_x),
                    parseFloat(player.pos_y),
                    parseFloat(player.pos_z)
                ), 0.3
            );
            ship.mesh.rotation.set(
                parseFloat(player.rot_x),
                parseFloat(player.rot_y),
                parseFloat(player.rot_z)
            );
            if (ship.label) {
                ship.label.element.textContent = player.nickname;
            }
        }
    });

    Object.keys(mpOtherPlayers).forEach(id => {
        if (!activeIds.has(id)) {
            removeOtherPlayer(id);
        }
    });
}

// â˜…â˜…â˜… ë°±ì—… í˜¸í™˜ìš© ë¹ˆ í•¨ìˆ˜ (animateì—ì„œ í˜¸ì¶œë¨) â˜…â˜…â˜…
function mpInterpolateOtherPlayers(deltaTime) {
    // ìœ„ì¹˜ ì—…ë°ì´íŠ¸ëŠ” updateOtherPlayersì—ì„œ ì§ì ‘ ì²˜ë¦¬
}
window.mpInterpolateOtherPlayers = mpInterpolateOtherPlayers;

function createOtherPlayerShip(player) {
    console.log('ğŸš€ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ìš°ì£¼ì„  ìƒì„±:', player.nickname, 'pos:', player.pos_x, player.pos_y, player.pos_z);

    if (!window.scene) {
        console.error('âŒ scene ì—†ìŒ');
        return;
    }

    const shipGroup = new THREE.Group();
    shipGroup.position.set(
        parseFloat(player.pos_x) || 0,
        parseFloat(player.pos_y) || 0,
        parseFloat(player.pos_z) || 0
    );

    // â˜…â˜…â˜… ë‹¤ë¥¸ í”Œë ˆì´ì–´ëŠ” ë‚´ ìš°ì£¼ì„ ë³´ë‹¤ ë’¤ì— ë Œë”ë§ â˜…â˜…â˜…
    shipGroup.renderOrder = -100;

    // â˜…â˜…â˜… í”Œë ˆì´ì–´ ìš°ì£¼ì„  ìƒ‰ìƒ ê²°ì • â˜…â˜…â˜…
    const shipTypeId = player.ship_type || 'shuttle';
    const shipType = window.SHIP_TYPES
        ? window.SHIP_TYPES.find(s => s.id === shipTypeId) : null;

    // ìš°ì„ ìˆœìœ„: player.ship_color > shipType.color > ê¸°ë³¸ê°’
    let shipColorHex = 0x4fc3f7; // ê¸°ë³¸ í•˜ëŠ˜ìƒ‰
    if (player.ship_color) {
        // ship_colorê°€ ë¬¸ìì—´ì´ë©´ íŒŒì‹±
        if (typeof player.ship_color === 'string') {
            shipColorHex = parseInt(player.ship_color.replace('#', ''), 16);
        } else {
            shipColorHex = player.ship_color;
        }
    } else if (shipType && shipType.color) {
        if (typeof shipType.color === 'string') {
            shipColorHex = parseInt(shipType.color.replace('#', ''), 16);
        } else {
            shipColorHex = shipType.color;
        }
    }
    const shipColor = new THREE.Color(shipColorHex);

    // â˜…â˜…â˜… ë°±ì—… ìŠ¤íƒ€ì¼: ê¸°ë³¸ í˜•íƒœ ë¨¼ì € ì¶”ê°€ â˜…â˜…â˜…
    const geometry = new THREE.ConeGeometry(5, 15, 8);  // 0.5â†’5, 1.5â†’15 (10ë°° ì¦ê°€)
    geometry.rotateX(Math.PI / 2);
    const material = new THREE.MeshBasicMaterial({
        color: shipColor,
        transparent: true,
        opacity: 0.8,
        depthWrite: true,
        depthTest: true
    });
    const defaultMesh = new THREE.Mesh(geometry, material);
    shipGroup.add(defaultMesh);

    // â˜…â˜…â˜… GLB ëª¨ë¸ ë¡œë“œ ì‹œë„ â˜…â˜…â˜…
    console.log('ğŸ” ëª¨ë¸ ë¡œë“œ ì²´í¬:', {
        hasShipType: !!shipType,
        shipTypeId: shipType?.id,
        modelUrl: shipType?.model,
        hasGLTFLoader: !!window.GLTFLoader
    });

    if (shipType && shipType.model && window.GLTFLoader) {
        const loader = new window.GLTFLoader();

        // â˜… Draco ì••ì¶• ëª¨ë¸ ì§€ì›
        if (window.DRACOLoader) {
            const dracoLoader = new window.DRACOLoader();
            dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
            loader.setDRACOLoader(dracoLoader);
        }

        console.log('ğŸ“¥ GLB ë¡œë“œ ì‹œì‘:', shipType.model);

        loader.load(shipType.model, (gltf) => {
            const model = gltf.scene;
            model.scale.setScalar(0.4);  // 0.04â†’0.4 (10ë°° ì¦ê°€)
            model.rotation.y = Math.PI;

            // í”Œë ˆì´ì–´ ìš°ì£¼ì„  ìƒ‰ìƒìœ¼ë¡œ í‹´íŠ¸
            model.traverse((child) => {
                if (child.isMesh && child.material) {
                    child.material = child.material.clone();
                    child.material.emissive = shipColor;
                    child.material.emissiveIntensity = 0.3;
                }
            });

            // ê¸°ë³¸ í˜•íƒœ ì œê±°
            shipGroup.remove(defaultMesh);
            shipGroup.add(model);
            console.log('âœ… ë‹¤ë¥¸ í”Œë ˆì´ì–´ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ:', player.nickname);
        }, (progress) => {
            // ë¡œë”© ì§„í–‰ë¥ 
            if (progress.total > 0) {
                console.log('ğŸ“Š ë¡œë”©:', Math.round(progress.loaded / progress.total * 100) + '%');
            }
        }, (err) => {
            console.error('âŒ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:', err.message || err);
            console.error('   URL:', shipType.model);
        });
    } else {
        console.warn('âš ï¸ ëª¨ë¸ ë¡œë“œ ê±´ë„ˆëœ€:', {
            reason: !shipType ? 'shipType ì—†ìŒ' : !shipType.model ? 'model URL ì—†ìŒ' : 'GLTFLoader ì—†ìŒ'
        });
    }

    window.scene.add(shipGroup);

    // â˜…â˜…â˜… ë‹‰ë„¤ì„ ë¼ë²¨ â˜…â˜…â˜…
    let label = null;
    if (window.CSS2DObject) {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'mp-player-label';
        labelDiv.textContent = player.nickname || 'Player';
        // ìš°ì£¼ì„  ìƒ‰ìƒì„ CSS hexë¡œ ë³€í™˜
        const labelColorHex = '#' + shipColor.getHexString();
        labelDiv.style.cssText = `color:${labelColorHex}; font-size:12px; font-family:Orbitron,sans-serif; text-shadow:0 0 5px ${labelColorHex}; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:3px;`;
        label = new window.CSS2DObject(labelDiv);
        label.position.set(0, 20, 0);  // 2â†’20 (10ë°° ì¦ê°€)
        shipGroup.add(label);
    }

    mpOtherPlayers[player.user_id] = { mesh: shipGroup, label: label, _v2: true };
    console.log('âœ… ë‹¤ë¥¸ í”Œë ˆì´ì–´ ìƒì„± ì™„ë£Œ:', player.nickname, 'ìœ„ì¹˜:', shipGroup.position.x.toFixed(2), shipGroup.position.y.toFixed(2), shipGroup.position.z.toFixed(2));
}

// â˜…â˜…â˜… GLB ì—†ì„ ë•Œ ê¸°ë³¸ í˜•íƒœ ìƒì„± â˜…â˜…â˜…
function addFallbackGeometry(group, shipType, sizeScale) {
    const color = shipType ? shipType.color : 0x00ffff;

    // ë³¸ì²´ (ì½˜)
    const bodyGeo = new THREE.ConeGeometry(0.3, 1.0, 8);
    bodyGeo.rotateX(Math.PI / 2);
    const bodyMat = new THREE.MeshStandardMaterial({
        color: color,
        metalness: 0.7,
        roughness: 0.3
    });
    const body = new THREE.Mesh(bodyGeo, bodyMat);
    body.scale.setScalar(sizeScale);
    group.add(body);

    // ê¸€ë¡œìš°
    const glowGeo = new THREE.SphereGeometry(0.4, 16, 16);
    const glowMat = new THREE.MeshBasicMaterial({
        color: color,
        transparent: true,
        opacity: 0.3
    });
    const glow = new THREE.Mesh(glowGeo, glowMat);
    group.add(glow);
}

function removeOtherPlayer(userId) {
    const player = mpOtherPlayers[userId];
    if (player) {
        if (window.scene) {
            window.scene.remove(player.mesh);
        }
        delete mpOtherPlayers[userId];
    }
}

// ============ ì±„íŒ… ============

function sendChat() {
    var input = document.getElementById('mp-chat-input');
    var message = input.value.trim();
    if (!message || !supabase) return;
    
    var isGuest = mpUserId && mpUserId.indexOf('guest_') === 0;
    
    supabase
        .from('chat_messages')
        .insert({
            user_id: isGuest ? null : mpUserId,
            nickname: mpNickname,
            message: message,
            message_type: 'chat'
        })
        .then(function() {
            input.value = '';
        })
        .catch(function(e) {
            console.log('ì±„íŒ… ì „ì†¡ ì‹¤íŒ¨:', e);
        });
}

// í†µí•© ì±„íŒ…ì—ì„œ í˜¸ì¶œí•˜ëŠ” ì „ì—­ í•¨ìˆ˜
window.sendMultiChat = async function(message) {
    if (!message || !mpUserId || !supabase) return;
    
    var isGuest = mpUserId && mpUserId.indexOf('guest_') === 0;
    
    try {
        const { data, error } = await supabase
            .from('chat_messages')
            .insert({
                user_id: isGuest ? null : mpUserId,
                nickname: mpNickname,
                message: message,
                message_type: 'chat'
            })
            .select();
        
        if (error) {
            console.log('ì±„íŒ… ì „ì†¡ ì‹¤íŒ¨:', error);
        }
    } catch (e) {
        console.log('ì±„íŒ… ì „ì†¡ ì˜¤ë¥˜:', e);
    }
};

function getChat() {
    if (!supabase) return;
    
    supabase
        .from('chat_messages')
        .select('*')
        .gt('id', mpChatLastId)
        .order('id', { ascending: true })
        .limit(50)
        .then(function(result) {
            var messages = result.data;
            var error = result.error;
            
            if (!error && messages && messages.length > 0) {
                var container = document.getElementById('mp-chat-container');
                
                messages.forEach(function(msg) {
                    var div = document.createElement('div');
                    div.className = 'mp-chat-msg';
                    
                    // ì‹œê°„ í¬ë§·íŒ…
                    var timeStr = '';
                    if (msg.created_at) {
                        var date = new Date(msg.created_at);
                        var month = String(date.getMonth() + 1).padStart(2, '0');
                        var day = String(date.getDate()).padStart(2, '0');
                        var hours = String(date.getHours()).padStart(2, '0');
                        var minutes = String(date.getMinutes()).padStart(2, '0');
                        var seconds = String(date.getSeconds()).padStart(2, '0');
                        timeStr = month + '/' + day + ' ' + hours + ':' + minutes + ':' + seconds;
                    }
                    
                    div.innerHTML = '<span class="nick">' + msg.nickname + ':</span> <span class="msg-text">' + msg.message + '</span> <span class="msg-time">' + timeStr + '</span>';
                    container.appendChild(div);
                    mpChatLastId = Math.max(mpChatLastId, parseInt(msg.id));
                    
                    // í†µí•© ì±„íŒ…ì—ë„ í‘œì‹œ
                    if (typeof unifiedChatSystem !== 'undefined') {
                        unifiedChatSystem.addMultiMessage(msg.nickname, msg.message, timeStr);
                    }
                });
                
                container.scrollTop = container.scrollHeight;
            }
        })
        .catch(function(e) {
            console.log('ì±„íŒ… ì¡°íšŒ ì‹¤íŒ¨:', e);
        });
}

// ============ ì´ˆê¸°í™” ============

function startMultiplayer() {
    // UIê°€ ì—†ìœ¼ë©´ ìƒì„±
    if (!document.getElementById('multiplayer-ui')) {
        createMultiplayerUI();
    }

    // UI í‘œì‹œ
    const mpUI = document.getElementById('multiplayer-ui');
    if (mpUI) mpUI.style.display = 'block';

    // ì´ë¯¸ ì‹œì‘ëœ ê²½ìš° ì¤‘ë³µ ë°©ì§€
    if (window.mpStarted) {
        console.log('ë©€í‹°í”Œë ˆì´ì–´ ì´ë¯¸ ì‹¤í–‰ ì¤‘');
        return;
    }

    // ì„œë²„ì—ì„œ ë°©ë¬¸ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    if (typeof loadVisitedStations === 'function') {
        loadVisitedStations().then(() => {
            console.log('ë°©ë¬¸ ê¸°ë¡ ë¡œë“œ ì™„ë£Œ');
        });
    }

    // â˜…â˜…â˜… ìµœì í™”ëœ ì¸í„°ë²Œ ì„¤ì • â˜…â˜…â˜…
    // 100msë§ˆë‹¤ ì²´í¬í•˜ì§€ë§Œ ë¸íƒ€ ì••ì¶•ìœ¼ë¡œ ë³€ê²½ ì‹œì—ë§Œ ì „ì†¡
    mpIntervals.push(setInterval(mpSendMyPosition, MP_UPDATE_INTERVAL));
    // 500msë§ˆë‹¤ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ì¡°íšŒ (Realtime ë°±ì—…)
    mpIntervals.push(setInterval(mpGetOtherPlayers, MP_SYNC_INTERVAL));
    // 1.5ì´ˆë§ˆë‹¤ ì±„íŒ… ì¡°íšŒ
    mpIntervals.push(setInterval(getChat, MP_CHAT_INTERVAL));

    // â˜…â˜…â˜… Supabase Realtime êµ¬ë… (WebSocket) â˜…â˜…â˜…
    setupRealtimeSubscription();

    // ì´ˆê¸° ìœ„ì¹˜ ê°•ì œ ì „ì†¡
    setTimeout(() => mpSendMyPosition(true), 500);

    window.mpStarted = true;
    console.log('ğŸš€ ë©€í‹°í”Œë ˆì´ì–´ ì‹œì‘! ID:', mpUserId);
    console.log('ğŸ“¡ ë™ê¸°í™” ì„¤ì •: ìœ„ì¹˜ì „ì†¡=' + MP_UPDATE_INTERVAL + 'ms, ì¡°íšŒ=' + MP_SYNC_INTERVAL + 'ms');

    // UI ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸ ìƒíƒœ ë°˜ì˜)
    if (typeof updateUserUI === 'function') {
        updateUserUI();
    }
}

// â˜…â˜…â˜… Supabase Realtime êµ¬ë… ì„¤ì • â˜…â˜…â˜…
function setupRealtimeSubscription() {
    if (!supabase || mpRealtimeChannel) return;

    try {
        mpRealtimeChannel = supabase
            .channel('player_positions_realtime')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'player_positions'
            }, (payload) => {
                // INSERT ë˜ëŠ” UPDATE ì´ë²¤íŠ¸ ì²˜ë¦¬
                if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                    const p = payload.new;
                    if (p.user_id !== mpUserId) {  // â˜…â˜…â˜… ìê¸° ìì‹  ì œì™¸ â˜…â˜…â˜…
                        // â˜…â˜…â˜… í…Œì´ë¸” êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì • â˜…â˜…â˜…
                        const formattedPlayer = {
                            user_id: p.user_id,
                            nickname: p.nickname || 'ìµëª…',
                            pos_x: p.x || 0,
                            pos_y: p.y || 0,
                            pos_z: p.z || 0,
                            rot_x: p.rot_x || 0,
                            rot_y: p.rot_y || 0,
                            rot_z: p.rot_z || 0,
                            ship_type: p.ship_type || 'shuttle',
                            ship_color: p.ship_color || '#00aaff',
                            status: p.status || 'flying',
                            current_location: p.current_body
                        };

                        if (mpOtherPlayers[p.user_id]) {
                            // ê¸°ì¡´ í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸
                            const ship = mpOtherPlayers[p.user_id];
                            ship.targetPosition = new THREE.Vector3(p.x, p.y, p.z);
                            ship.targetRotation = new THREE.Euler(p.rot_x, p.rot_y, p.rot_z);
                            ship.status = p.status || 'flying';
                            // ë ˆì´ë¸” ì—…ë°ì´íŠ¸
                            if (ship.label) {
                                const statusIcon = p.status === 'autopilot' ? 'ğŸš€' : '';
                                ship.label.element.textContent = statusIcon + (p.nickname || 'ìµëª…');
                            }
                        } else {
                            // ìƒˆ í”Œë ˆì´ì–´ ìƒì„±
                            createOtherPlayerShip(formattedPlayer);
                        }
                    }
                } else if (payload.eventType === 'DELETE') {
                    // í”Œë ˆì´ì–´ í‡´ì¥
                    removeOtherPlayer(payload.old.user_id);
                }
            })
            .subscribe((status) => {
                console.log('ğŸ“¡ Realtime ìƒíƒœ:', status);
            });

        console.log('âœ… Supabase Realtime êµ¬ë… ì‹œì‘');
    } catch (e) {
        console.log('âš ï¸ Realtime êµ¬ë… ì‹¤íŒ¨, í´ë§ ëª¨ë“œë¡œ ë™ì‘:', e);
    }
}

window.addEventListener('load', () => {
    setTimeout(() => {
        // ì €ì¥ëœ ë¡œê·¸ì¸ ì •ë³´ë§Œ ë¡œë“œ (ì¸ì¦ UIëŠ” ë©€í‹° ëª¨ë“œ ì„ íƒ ì‹œ í‘œì‹œ)
        loadSavedLogin();
        console.log('ë¡œê·¸ì¸ ì •ë³´ ì²´í¬ ì™„ë£Œ');
    }, 2000);
});

window.addEventListener('beforeunload', function() {
    // â˜…â˜…â˜… user_idë¡œ í”Œë ˆì´ì–´ ìœ„ì¹˜ ì‚­ì œ â˜…â˜…â˜…
    if (supabase && mpUserId) {
        // REST APIë¡œ ì§ì ‘ DELETE ìš”ì²­ (sendBeacon í˜¸í™˜)
        navigator.sendBeacon(
            SUPABASE_URL + '/rest/v1/player_positions?user_id=eq.' + encodeURIComponent(mpUserId),
            ''
        );
    }

    // ì‹¤ì‹œê°„ êµ¬ë… í•´ì œ
    if (mpRealtimeChannel && supabase) {
        supabase.removeChannel(mpRealtimeChannel);
    }
});
</script>

<script>
// ===== ê´‘ê³  ë³´ìƒ ì‹œìŠ¤í…œ =====
const adBooster = {
    active: false,
    multiplier: 2.0,
    endTime: 0,
    duration: 300000  // 5ë¶„
};

const emergencyEscapeCharge = {
    charged: false,
    chargeEndTime: 0  // 10ë¶„ ìœ íš¨
};

const spaceExplorer = {
    active: false,
    remainingTime: 0,
    duration: 180000  // 3ë¶„
};

// ê´‘ê³  ì‹œì²­ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” ê´‘ê³  SDK ì—°ë™)
function simulateAdWatch(callback) {
    const adModal = document.createElement('div');
    adModal.id = 'ad-modal';
    adModal.innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:100000;">
            <div style="color:#fff;font-size:2em;margin-bottom:20px;">ğŸ“º ê´‘ê³  ì‹œì²­ ì¤‘...</div>
            <div id="ad-countdown" style="color:#0ff;font-size:3em;">3</div>
        </div>
    `;
    document.body.appendChild(adModal);
    
    let count = 3;
    const interval = setInterval(() => {
        count--;
        document.getElementById('ad-countdown').textContent = count;
        if (count <= 0) {
            clearInterval(interval);
            document.body.removeChild(adModal);
            callback();
        }
    }, 1000);
}

// ê´‘ê³  ë³´ê³  2ë°° ë¶€ìŠ¤í„° ì–»ê¸°
function watchAdForBooster() {
    simulateAdWatch(() => {
        adBooster.active = true;
        adBooster.endTime = Date.now() + adBooster.duration;
        updateAdUI();
        if (typeof showMessage === 'function') {
            showMessage('ğŸš€ 2ë°° ë¶€ìŠ¤í„° í™œì„±í™”! (5ë¶„)');
        }
    });
}

// ê´‘ê³  ë³´ê³  ê¸´ê¸‰íƒˆì¶œ ì¶©ì „
function watchAdForEscape() {
    simulateAdWatch(() => {
        emergencyEscapeCharge.charged = true;
        emergencyEscapeCharge.chargeEndTime = Date.now() + 600000; // 10ë¶„
        updateAdUI();
        if (typeof showMessage === 'function') {
            showMessage('âš¡ ê¸´ê¸‰íƒˆì¶œ ì¶©ì „ ì™„ë£Œ! (10ë¶„ê°„ ìœ íš¨)');
        }
    });
}

// ê´‘ê³  ë³´ê³  ë‘˜ëŸ¬ë³´ê¸° (ë©€í‹° ì „ìš©)
function watchAdForExplore() {
    if (window.gameMode !== 'multi') return;
    simulateAdWatch(() => {
        spaceExplorer.active = true;
        spaceExplorer.remainingTime += spaceExplorer.duration;
        updateAdUI();
        if (typeof showMessage === 'function') {
            showMessage('ğŸ”­ ë‘˜ëŸ¬ë³´ê¸° ëª¨ë“œ +3ë¶„ ì¶”ê°€!');
        }
    });
}

// ê´‘ê³  UI ì—…ë°ì´íŠ¸
function updateAdUI() {
    // ì´ˆê¸°í™” ì „ì—ëŠ” ì‹¤í–‰ ì•ˆí•¨
    if (typeof window.gameMode === 'undefined') return;
    
    const boosterBtn = document.getElementById('ad-booster-btn');
    const escapeBtn = document.getElementById('ad-escape-btn');
    const exploreBtn = document.getElementById('ad-explore-btn');
    const boosterStatus = document.getElementById('booster-status');
    const escapeStatus = document.getElementById('escape-status');
    const exploreStatus = document.getElementById('explore-status');
    const exploreItem = document.getElementById('ad-item-explore');
    
    if (boosterBtn && boosterStatus) {
        if (adBooster.active) {
            const remaining = Math.max(0, adBooster.endTime - Date.now());
            const mins = Math.floor(remaining / 60000);
            const secs = Math.floor((remaining % 60000) / 1000);
            boosterStatus.textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
            boosterStatus.style.color = '#0f0';
            boosterBtn.textContent = t('activated');
            boosterBtn.disabled = true;
            boosterBtn.style.opacity = '0.6';
        } else {
            boosterStatus.textContent = '';
            boosterBtn.textContent = t('watchAdBtn');
            boosterBtn.disabled = false;
            boosterBtn.style.opacity = '1';
        }
    }
    
    if (escapeBtn && escapeStatus) {
        if (emergencyEscapeCharge.charged) {
            const remaining = Math.max(0, emergencyEscapeCharge.chargeEndTime - Date.now());
            const mins = Math.floor(remaining / 60000);
            escapeStatus.textContent = `${mins}${t('minutes')}`;
            escapeStatus.style.color = '#0f0';
            escapeBtn.textContent = t('chargeComplete');
            escapeBtn.disabled = true;
            escapeBtn.style.opacity = '0.6';
        } else {
            escapeStatus.textContent = '';
            escapeBtn.textContent = t('watchAdBtn');
            escapeBtn.disabled = false;
            escapeBtn.style.opacity = '1';
        }
    }
    
    if (exploreItem) {
        exploreItem.style.display = (window.gameMode === 'multi') ? 'block' : 'none';
    }
    
    if (exploreBtn && exploreStatus) {
        if (spaceExplorer.active && spaceExplorer.remainingTime > 0) {
            const mins = Math.floor(spaceExplorer.remainingTime / 60000);
            const secs = Math.floor((spaceExplorer.remainingTime % 60000) / 1000);
            exploreStatus.textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
            exploreStatus.style.color = '#0f0';
        } else {
            exploreStatus.textContent = '';
        }
    }
}

// íƒ€ì´ë¨¸ ì²´í¬ (ë§¤ í”„ë ˆì„)
function checkAdTimers() {
    const now = Date.now();
    
    if (adBooster.active && now >= adBooster.endTime) {
        adBooster.active = false;
        if (typeof showMessage === 'function') {
            showMessage('â° ë¶€ìŠ¤í„° íš¨ê³¼ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
        }
    }
    
    if (emergencyEscapeCharge.charged && now >= emergencyEscapeCharge.chargeEndTime) {
        emergencyEscapeCharge.charged = false;
        if (typeof showMessage === 'function') {
            showMessage('â° ê¸´ê¸‰íƒˆì¶œ ì¶©ì „ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
        }
    }
    
    // ë©”ë‰´ ë²„íŠ¼ ìƒíƒœ í‘œì‹œ
    const menuToggle = document.getElementById('ad-menu-toggle');
    if (menuToggle) {
        if (adBooster.active || emergencyEscapeCharge.charged) {
            menuToggle.style.borderColor = '#0f0';
            menuToggle.style.boxShadow = '0 0 10px #0f0';
        } else {
            menuToggle.style.borderColor = '#0ff';
            menuToggle.style.boxShadow = 'none';
        }
    }
    
    // ê¸´ê¸‰íƒˆì¶œ ë¶€ìŠ¤í„° HUD í‘œì‹œ (ì¡°ì¢… ì¤‘ì¼ ë•Œë§Œ)
    const escapeHUD = document.getElementById('warn-escape-ready');
    if (escapeHUD && typeof isPilotMode !== 'undefined') {
        if (isPilotMode && emergencyEscapeCharge.charged) {
            escapeHUD.style.display = 'block';
            // ì¤‘ë ¥ ìœ„í—˜ ì‹œ ë²ˆì©ì„
            if (typeof isGravityWarning !== 'undefined' && isGravityWarning) {
                escapeHUD.style.animation = 'escapeFlash 0.5s ease-in-out infinite alternate';
            } else {
                escapeHUD.style.animation = 'none';
            }
        } else {
            escapeHUD.style.display = 'none';
        }
    }
    
    updateAdUI();
}

// 1ì´ˆë§ˆë‹¤ íƒ€ì´ë¨¸ ì²´í¬ (DOM ë¡œë“œ í›„)
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        setInterval(checkAdTimers, 1000);
    }, 2000);
});

// ===== ì²œì²´ ì •ë³´ í‘œì‹œ (ë©€í‹°ëª¨ë“œìš©) =====
const BODY_RESOURCES = {
    'SUN': ['ìˆ˜ì†Œ', 'í—¬ë¥¨', 'í”Œë¼ì¦ˆë§ˆ ì—ë„ˆì§€'],
    'MERCURY': ['ì² ', 'ë‹ˆì¼ˆ', 'ê·œì†Œ', 'í™©'],
    'VENUS': ['í™©ì‚°', 'ì´ì‚°í™”íƒ„ì†Œ', 'ì§ˆì†Œ', 'í™©'],
    'EARTH': ['ë¬¼', 'ì‚°ì†Œ', 'ì² ', 'ê¸ˆ', 'ì„ìœ ', 'í¬í† ë¥˜'],
    'MARS': ['ì² ', 'ë§ˆê·¸ë„¤ìŠ˜', 'ë¬¼(ì–¼ìŒ)', 'ì´ì‚°í™”íƒ„ì†Œ', 'ê·œì†Œ'],
    'JUPITER': ['ìˆ˜ì†Œ', 'í—¬ë¥¨', 'ë©”íƒ„', 'ì•”ëª¨ë‹ˆì•„'],
    'SATURN': ['ìˆ˜ì†Œ', 'í—¬ë¥¨', 'ì•”ëª¨ë‹ˆì•„', 'ë©”íƒ„'],
    'URANUS': ['ë©”íƒ„', 'ìˆ˜ì†Œ', 'í—¬ë¥¨', 'ì–¼ìŒ', 'ì•”ëª¨ë‹ˆì•„'],
    'NEPTUNE': ['ë©”íƒ„', 'ìˆ˜ì†Œ', 'í—¬ë¥¨', 'ë‹¤ì´ì•„ëª¬ë“œ', 'ì–¼ìŒ'],
    'MOON': ['í—¬ë¥¨-3', 'í‹°íƒ€ëŠ„', 'ì² ', 'ë¬¼(ì–¼ìŒ)', 'ì•Œë£¨ë¯¸ëŠ„'],
    'TITAN': ['ë©”íƒ„', 'ì—íƒ„', 'ì§ˆì†Œ', 'ë¬¼(ì–¼ìŒ)', 'ìœ ê¸°ë¬¼'],
    'EUROPA': ['ë¬¼(ì–¼ìŒ)', 'ì‚°ì†Œ', 'ì†Œê¸ˆ', 'í™©ì‚°ë§ˆê·¸ë„¤ìŠ˜'],
    'GANYMEDE': ['ë¬¼(ì–¼ìŒ)', 'ì² ', 'ê·œì†Œ', 'ë§ˆê·¸ë„¤ìŠ˜'],
    'CALLISTO': ['ë¬¼(ì–¼ìŒ)', 'ì•”ì„', 'ì´ì‚°í™”íƒ„ì†Œ'],
    'IO': ['í™©', 'ì´ì‚°í™”í™©', 'ê·œì†Œ', 'ë‚˜íŠ¸ë¥¨'],
    'ENCELADUS': ['ë¬¼(ì–¼ìŒ)', 'ìœ ê¸°ë¬¼', 'ì†Œê¸ˆ', 'ìˆ˜ì†Œ'],
    'TRITON': ['ì§ˆì†Œ(ì–¼ìŒ)', 'ë©”íƒ„', 'ë¬¼(ì–¼ìŒ)', 'ì´ì‚°í™”íƒ„ì†Œ'],
    'PLUTO': ['ì§ˆì†Œ(ì–¼ìŒ)', 'ë©”íƒ„(ì–¼ìŒ)', 'ë¬¼(ì–¼ìŒ)'],
    'CERES': ['ë¬¼(ì–¼ìŒ)', 'ì•”ëª¨ë‹ˆì•„', 'íƒ„ì‚°ì—¼'],
    'PHOBOS': ['ì² ', 'íƒ„ì†Œ', 'ê·œì†Œ'],
    'DEIMOS': ['íƒ„ì†Œ', 'ê·œì†Œ', 'ì² ']
};

// í…Œë¼í¬ë° ìƒíƒœ ë°ì´í„°
const BODY_TERRAFORMING = {
    'EARTH': { percent: 100, status: 'ì™„ì „ ìƒíƒœê³„', phase: 'ìœ ì§€' },
    'MOON': { percent: 8, status: 'ë” ê¸°ì§€ ê±´ì„¤ ì¤‘', phase: '1ë‹¨ê³„' },
    'MARS': { percent: 3, status: 'ëŒ€ê¸° ì¦ê°€ ì¤‘', phase: '1ë‹¨ê³„' },
    'VENUS': { percent: 0.1, status: 'ëŒ€ê¸° ëƒ‰ê° ì—°êµ¬ ì¤‘', phase: 'ê³„íš' },
    'TITAN': { percent: 0.5, status: 'ë©”íƒ„ í˜¸ìˆ˜ ì—°êµ¬ ì¤‘', phase: 'íƒì‚¬' },
    'EUROPA': { percent: 1, status: 'ì–¼ìŒ ì•„ë˜ í•´ì–‘ íƒì‚¬', phase: 'íƒì‚¬' },
    'GANYMEDE': { percent: 0.2, status: 'ìê¸°ì¥ ì—°êµ¬ ì¤‘', phase: 'ê³„íš' },
    'ENCELADUS': { percent: 0.3, status: 'ì—´ìˆ˜êµ¬ íƒì‚¬', phase: 'íƒì‚¬' },
    'default': { percent: 0, status: 'ë¯¸íƒì‚¬', phase: '-' }
};

// ì¸í”„ë¼ ë°ì´í„°
const BODY_INFRASTRUCTURE = {
    'EARTH': { 
        spaceport: true, refuel: true, repair: true, shop: true, research: true, mining: true,
        description: 'ì™„ì „í•œ ë¬¸ëª… ì¸í”„ë¼'
    },
    'MOON': { 
        spaceport: true, refuel: true, repair: true, shop: false, research: true, mining: true,
        description: 'ë‹¬ ê¸°ì§€ (ì•„ë¥´í…Œë¯¸ìŠ¤)'
    },
    'MARS': { 
        spaceport: true, refuel: true, repair: false, shop: false, research: true, mining: false,
        description: 'í™”ì„± ì „ì´ˆê¸°ì§€'
    },
    'ISS': { 
        spaceport: true, refuel: true, repair: true, shop: true, research: true, mining: false,
        description: 'êµ­ì œìš°ì£¼ì •ê±°ì¥'
    },
    'EUROPA': { 
        spaceport: false, refuel: false, repair: false, shop: false, research: true, mining: false,
        description: 'ìœ ë¡œíŒŒ íƒì‚¬ì„ '
    },
    'TITAN': { 
        spaceport: false, refuel: false, repair: false, shop: false, research: true, mining: false,
        description: 'íƒ€ì´íƒ„ ì°©ë¥™ì„ '
    },
    'default': { 
        spaceport: false, refuel: false, repair: false, shop: false, research: false, mining: false,
        description: 'ì¸í”„ë¼ ì—†ìŒ'
    }
};

// ì‹ë¯¼ì§€ ìƒíƒœ
const BODY_COLONY_STATUS = {
    'EARTH': { status: 'ëª¨í–‰ì„±', population: '80ì–µ', level: '5' },
    'MOON': { status: 'ê¸°ì§€ ê±´ì„¤ ì¤‘', population: '1,200ëª…', level: '2' },
    'MARS': { status: 'ì´ˆê¸° ì •ì°©', population: '150ëª…', level: '1' },
    'ISS': { status: 'ìš´ì˜ ì¤‘', population: '7ëª…', level: '3' },
    'default': { status: 'ë¯¸ê°œì²™', population: '0ëª…', level: '0' }
};

// ì²œì²´ ë¬¼ë¦¬ ë°ì´í„°
const BODY_PHYSICS = {
    'SUN': { gravity: '274 m/sÂ²', temp: '5,500Â°C (í‘œë©´)' },
    'MERCURY': { gravity: '3.7 m/sÂ²', temp: '-180~430Â°C' },
    'VENUS': { gravity: '8.87 m/sÂ²', temp: '465Â°C' },
    'EARTH': { gravity: '9.8 m/sÂ²', temp: '-89~57Â°C' },
    'MARS': { gravity: '3.72 m/sÂ²', temp: '-140~20Â°C' },
    'JUPITER': { gravity: '24.79 m/sÂ²', temp: '-145Â°C' },
    'SATURN': { gravity: '10.44 m/sÂ²', temp: '-178Â°C' },
    'URANUS': { gravity: '8.69 m/sÂ²', temp: '-224Â°C' },
    'NEPTUNE': { gravity: '11.15 m/sÂ²', temp: '-218Â°C' },
    'MOON': { gravity: '1.62 m/sÂ²', temp: '-173~127Â°C' },
    'TITAN': { gravity: '1.35 m/sÂ²', temp: '-179Â°C' },
    'EUROPA': { gravity: '1.31 m/sÂ²', temp: '-160Â°C' },
    'GANYMEDE': { gravity: '1.43 m/sÂ²', temp: '-163Â°C' },
    'IO': { gravity: '1.79 m/sÂ²', temp: '-143Â°C' },
    'ENCELADUS': { gravity: '0.11 m/sÂ²', temp: '-198Â°C' },
    'TRITON': { gravity: '0.78 m/sÂ²', temp: '-235Â°C' },
    'PLUTO': { gravity: '0.62 m/sÂ²', temp: '-229Â°C' },
    'default': { gravity: 'ì•Œ ìˆ˜ ì—†ìŒ', temp: 'ì•Œ ìˆ˜ ì—†ìŒ' }
};

function showBodyInfo(bodyName, bodyData) {
    const modal = document.getElementById('body-info-modal');
    
    // ëŒ€ì†Œë¬¸ì í†µì¼ (ëŒ€ë¬¸ìë¡œ)
    const keyName = bodyName.toUpperCase();
    
    // í•œê¸€ ì´ë¦„ ë§¤í•‘
    const KOREAN_NAMES = {
        'SUN': 'íƒœì–‘', 'MERCURY': 'ìˆ˜ì„±', 'VENUS': 'ê¸ˆì„±', 'EARTH': 'ì§€êµ¬', 'MARS': 'í™”ì„±',
        'JUPITER': 'ëª©ì„±', 'SATURN': 'í† ì„±', 'URANUS': 'ì²œì™•ì„±', 'NEPTUNE': 'í•´ì™•ì„±',
        'MOON': 'ë‹¬', 'PHOBOS': 'í¬ë³´ìŠ¤', 'DEIMOS': 'ë°ì´ëª¨ìŠ¤',
        'IO': 'ì´ì˜¤', 'EUROPA': 'ìœ ë¡œíŒŒ', 'GANYMEDE': 'ê°€ë‹ˆë©”ë°', 'CALLISTO': 'ì¹¼ë¦¬ìŠ¤í† ',
        'TITAN': 'íƒ€ì´íƒ„', 'ENCELADUS': 'ì—”ì…€ë¼ë‘ìŠ¤', 'MIMAS': 'ë¯¸ë§ˆìŠ¤', 
        'RHEA': 'ë ˆì•„', 'DIONE': 'ë””ì˜¤ë„¤', 'IAPETUS': 'ì´ì•„í˜íˆ¬ìŠ¤',
        'TITANIA': 'í‹°íƒ€ë‹ˆì•„', 'OBERON': 'ì˜¤ë² ë¡ ', 'MIRANDA': 'ë¯¸ë€ë‹¤', 
        'ARIEL': 'ì•„ë¦¬ì—˜', 'UMBRIEL': 'ì›€ë¸Œë¦¬ì—˜',
        'TRITON': 'íŠ¸ë¦¬í†¤', 'PLUTO': 'ëª…ì™•ì„±', 'CHARON': 'ì¹´ë¡ ', 
        'CERES': 'ì„¸ë ˆìŠ¤', 'ERIS': 'ì—ë¦¬ìŠ¤', 'ISS': 'êµ­ì œìš°ì£¼ì •ê±°ì¥'
    };
    
    // ìœ í˜• í•œê¸€ ë§¤í•‘
    const TYPE_NAMES = {
        'star': 'í•­ì„±', 'planet': 'í–‰ì„±', 'moon': 'ìœ„ì„±', 
        'dwarf': 'ì™œì†Œí–‰ì„±', 'asteroid': 'ì†Œí–‰ì„±', 'station': 'ìš°ì£¼ì •ê±°ì¥'
    };
    
    // ë²ˆì—­ëœ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const translatedName = translateBodyName(bodyName);
    
    // ê¸°ë³¸ ì •ë³´
    document.getElementById('body-info-name').textContent = translatedName;
    document.getElementById('info-type').textContent = TYPE_NAMES[bodyData.type] || bodyData.type || t('unknownValue');
    document.getElementById('info-radius').textContent = bodyData.radius ? (bodyData.radius * 1000).toLocaleString() : '-';
    document.getElementById('info-mass').textContent = bodyData.mass ? bodyData.mass.toExponential(2) + ' kg' : '-';
    document.getElementById('info-orbit').textContent = bodyData.orbitPeriod ? bodyData.orbitPeriod.toFixed(1) + ' ' + t('days') : '-';
    
    // ë¬¼ë¦¬ ë°ì´í„°
    const physics = BODY_PHYSICS[keyName] || BODY_PHYSICS['default'];
    document.getElementById('info-gravity').textContent = physics.gravity === 'ì•Œ ìˆ˜ ì—†ìŒ' ? t('unknownValue') : physics.gravity;
    document.getElementById('info-temp').textContent = physics.temp === 'ì•Œ ìˆ˜ ì—†ìŒ' ? t('unknownValue') : physics.temp;
    
    // í…Œë¼í¬ë° ìƒíƒœ
    const terraform = BODY_TERRAFORMING[keyName] || BODY_TERRAFORMING['default'];
    document.getElementById('info-terraform-bar').style.width = terraform.percent + '%';
    document.getElementById('info-terraform-percent').textContent = terraform.percent + '%';
    document.getElementById('info-terraform-status').textContent = `${terraform.status} (${terraform.phase})`;
    
    // ì¸í”„ë¼
    const infra = BODY_INFRASTRUCTURE[keyName] || BODY_INFRASTRUCTURE['default'];
    const infraHTML = `
        <div style="color: ${infra.spaceport ? '#0f0' : '#555'};">ğŸš€ ${t('infraSpaceport')}: ${infra.spaceport ? 'O' : 'X'}</div>
        <div style="color: ${infra.refuel ? '#0f0' : '#555'};">â›½ ${t('infraFuel')}: ${infra.refuel ? 'O' : 'X'}</div>
        <div style="color: ${infra.repair ? '#0f0' : '#555'};">ğŸ”§ ${t('infraRepair')}: ${infra.repair ? 'O' : 'X'}</div>
        <div style="color: ${infra.shop ? '#0f0' : '#555'};">ğŸ›’ ${t('infraShop')}: ${infra.shop ? 'O' : 'X'}</div>
        <div style="color: ${infra.research ? '#0f0' : '#555'};">ğŸ”¬ ${t('infraResearch')}: ${infra.research ? 'O' : 'X'}</div>
        <div style="color: ${infra.mining ? '#0f0' : '#555'};">â›ï¸ ${t('infraMining')}: ${infra.mining ? 'O' : 'X'}</div>
    `;
    document.getElementById('info-infrastructure').innerHTML = infraHTML;
    
    // ìì› (íƒœê·¸ ìŠ¤íƒ€ì¼ë¡œ)
    const resources = BODY_RESOURCES[keyName] || ['ì •ë³´ ì—†ìŒ'];
    const resourceColors = ['#f0f', '#0ff', '#ff0', '#0f0', '#f90', '#f55'];
    const resourceHTML = resources.map((r, i) => 
        `<span style="background: ${resourceColors[i % resourceColors.length]}33; color: ${resourceColors[i % resourceColors.length]}; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; border: 1px solid ${resourceColors[i % resourceColors.length]}55;">${r}</span>`
    ).join('');
    document.getElementById('info-resources').innerHTML = resourceHTML;
    
    // ì‹ë¯¼ì§€ ì •ë³´
    const colony = BODY_COLONY_STATUS[keyName] || BODY_COLONY_STATUS['default'];
    document.getElementById('info-colony').textContent = colony.status;
    document.getElementById('info-population').textContent = colony.population;
    
    // ì¸ê³µìœ„ì„± ìˆ˜ ê³„ì‚°
    let satelliteCount = 0;
    if (typeof bodies !== 'undefined') {
        bodies.forEach(b => {
            if (b.parent && (b.parent.name === bodyName || b.parent.name === koreanName)) satelliteCount++;
        });
    }
    document.getElementById('info-satellites').textContent = satelliteCount;
    
    // ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('body-info-goto').onclick = () => {
        modal.style.display = 'none';
        // í•´ë‹¹ ì²œì²´ë¡œ í¬ì»¤ìŠ¤
        if (typeof bodies !== 'undefined') {
            const targetBody = bodies.find(b => 
                b.name === bodyName || 
                b.name === koreanName || 
                b.name.toUpperCase() === keyName
            );
            if (targetBody) {
                focusedBody = targetBody;
                if (typeof showMessage === 'function') showMessage(`ğŸ¯ ${koreanName}(ìœ¼)ë¡œ ì´ë™í•©ë‹ˆë‹¤`);
            }
        }
    };
    
    modal.style.display = 'block';
}

// ë©€í‹°ëª¨ë“œì—ì„œ ë„ê° ì œëª© ë³€ê²½
function updateCatalogTitle() {
    const title = document.getElementById('catalog-title');
    if (title) {
        if (window.gameMode === 'multi') {
            title.textContent = 'ğŸŒŒ íƒœì–‘ê³„ ì²œì²´ ì •ë³´';
        } else {
            title.textContent = 'ğŸŒŒ ì²œì²´ ë„ê° (í´ë¦­í•˜ì—¬ ìƒì„±)';
        }
    }
}

// ê´‘ê³  ëª¨ë‹¬ ì´ë²¤íŠ¸ (DOM ë¡œë“œ í›„)
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        // ê´‘ê³  ëª¨ë‹¬ í† ê¸€
        const adMenuToggle = document.getElementById('ad-menu-toggle');
        const adModalMenu = document.getElementById('ad-modal-menu');
        const adModalClose = document.getElementById('ad-modal-close');
        const adBoosterBtn = document.getElementById('ad-booster-btn');
        const adEscapeBtn = document.getElementById('ad-escape-btn');
        const adExploreBtn = document.getElementById('ad-explore-btn');
        
        if (adMenuToggle) {
            adMenuToggle.addEventListener('click', function() {
                if (adModalMenu) {
                    adModalMenu.style.display = 'flex';
                    updateAdUI();
                }
            });
        }
        
        if (adModalClose) {
            adModalClose.addEventListener('click', function() {
                if (adModalMenu) adModalMenu.style.display = 'none';
            });
        }
        
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if (adModalMenu) {
            adModalMenu.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        }
        
        // ê´‘ê³  ë²„íŠ¼ ì´ë²¤íŠ¸
        if (adBoosterBtn) {
            adBoosterBtn.addEventListener('click', function() {
                if (!adBooster.active) {
                    if (adModalMenu) adModalMenu.style.display = 'none';
                    watchAdForBooster();
                }
            });
        }
        
        if (adEscapeBtn) {
            adEscapeBtn.addEventListener('click', function() {
                if (!emergencyEscapeCharge.charged) {
                    if (adModalMenu) adModalMenu.style.display = 'none';
                    watchAdForEscape();
                }
            });
        }
        
        if (adExploreBtn) {
            adExploreBtn.addEventListener('click', function() {
                if (adModalMenu) adModalMenu.style.display = 'none';
                watchAdForExplore();
            });
        }
        
        console.log('ê´‘ê³  ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
    }, 500);
});

// ===== ì¤‘ë ¥ ìœ„í—˜ ë¶„ì„ ì‹œìŠ¤í…œ =====
const G_CONST = 6.674e-11;  // ì¤‘ë ¥ ìƒìˆ˜

function analyzeGravityDanger() {
    if (!playerShip || !playerShip.mesh) return null;
    
    const shipPos = playerShip.mesh.position;
    let mostDangerous = null;
    let maxDanger = 0;
    
    // ëª¨ë“  ì²œì²´ì— ëŒ€í•´ ìœ„í—˜ë„ ê³„ì‚°
    if (typeof celestialBodies !== 'undefined') {
        celestialBodies.forEach(body => {
            if (!body.mesh) return;
            
            const bodyPos = body.mesh.position;
            const dist = shipPos.distanceTo(bodyPos);
            const mass = body.mass || 1e24;
            const dangerRadius = (body.radius || 1) * 50;  // ìœ„í—˜ ë°˜ê²½
            
            if (dist < dangerRadius) {
                // ìœ„í—˜ë„ = ì§ˆëŸ‰ / ê±°ë¦¬^2 * (ìœ„í—˜ë°˜ê²½/ê±°ë¦¬)
                const danger = (mass / (dist * dist)) * (dangerRadius / dist);
                
                if (danger > maxDanger) {
                    maxDanger = danger;
                    mostDangerous = {
                        body: body,
                        dist: dist,
                        mass: mass,
                        radius: body.radius || 1
                    };
                }
            }
        });
    }
    
    return mostDangerous;
}

function calculateEscapeRecommendation(dangerInfo) {
    if (!dangerInfo || !playerShip || !playerShip.mesh) return null;
    
    const { body, dist, mass } = dangerInfo;
    const bodyPos = body.mesh.position;
    const shipPos = playerShip.mesh.position;
    
    // íƒˆì¶œ ì†ë„ ê³„ì‚° (ê°„ì†Œí™”ëœ ë²„ì „)
    const escapeVelocity = Math.sqrt(2 * mass * G_CONST / (dist * 1000)) / 1000;  // km/s
    const scaledEscapeVel = Math.min(escapeVelocity * 0.001, 100);  // ìŠ¤ì¼€ì¼ ì¡°ì •
    
    const currentSpeed = Math.abs(playerShip.speed);
    const speedDeficit = Math.max(0, scaledEscapeVel - currentSpeed);
    
    // íƒˆì¶œ ë°©í–¥ ê³„ì‚° (ì²œì²´ ë°˜ëŒ€ ë°©í–¥)
    const escapeDir = new window.THREE.Vector3().subVectors(shipPos, bodyPos).normalize();
    
    // í˜„ì¬ ìš°ì£¼ì„  ë°©í–¥
    const shipDir = new window.THREE.Vector3(0, 0, -1);
    shipDir.applyQuaternion(playerShip.mesh.quaternion);
    
    // í•„ìš” íšŒì „ ê°ë„
    const angleToEscape = Math.acos(Math.max(-1, Math.min(1, shipDir.dot(escapeDir)))) * 180 / Math.PI;
    
    // íšŒì „ ë°©í–¥ (ì¢Œ/ìš°)
    const cross = new window.THREE.Vector3().crossVectors(shipDir, escapeDir);
    const turnDirection = cross.y > 0 ? 'ì¢Œì¸¡' : 'ìš°ì¸¡';
    
    return {
        escapeVelocity: scaledEscapeVel,
        currentSpeed: currentSpeed,
        speedDeficit: speedDeficit,
        angleToEscape: angleToEscape,
        turnDirection: turnDirection,
        bodyName: body.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì²œì²´'
    };
}

function updateGravityWarningHUD() {
    if (!window.isPilotMode) {
        const hud = document.getElementById('gravity-hud-warning');
        if (hud) hud.style.display = 'none';
        return;
    }
    
    const dangerInfo = analyzeGravityDanger();
    const hud = document.getElementById('gravity-hud-warning');
    
    if (!dangerInfo) {
        if (hud) hud.style.display = 'none';
        return;
    }
    
    const recommendation = calculateEscapeRecommendation(dangerInfo);
    if (!recommendation || recommendation.speedDeficit <= 0) {
        if (hud) hud.style.display = 'none';
        return;
    }
    
    // HUD í‘œì‹œ
    if (hud) {
        hud.style.display = 'block';
        document.getElementById('gravity-body-name').textContent = recommendation.bodyName;
        document.getElementById('gravity-escape-vel').textContent = recommendation.escapeVelocity.toFixed(1);
        document.getElementById('gravity-current-vel').textContent = recommendation.currentSpeed.toFixed(1);
        document.getElementById('gravity-deficit').textContent = recommendation.speedDeficit.toFixed(1);
        document.getElementById('gravity-turn-dir').textContent = recommendation.turnDirection;
        document.getElementById('gravity-turn-angle').textContent = Math.round(recommendation.angleToEscape);
    }
}

// 1ì´ˆë§ˆë‹¤ ì¤‘ë ¥ ê²½ê³  ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', () => {
    setInterval(updateGravityWarningHUD, 1000);
});

// â˜…â˜…â˜… ì¢Œí‘œ ë³µì‚¬ ê¸°ëŠ¥ (ë©€í‹°ëª¨ë“œ) â˜…â˜…â˜…
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const coordsPanel = document.getElementById('pilot-coords-panel');
        if (coordsPanel) {
            coordsPanel.addEventListener('click', async () => {
                if (!playerShip || !playerShip.mesh) return;
                
                const pos = playerShip.mesh.position;
                const coordsText = `X: ${pos.x.toFixed(1)}, Y: ${pos.y.toFixed(1)}, Z: ${pos.z.toFixed(1)}`;
                
                try {
                    await navigator.clipboard.writeText(coordsText);
                    coordsPanel.classList.add('copied');
                    const label = coordsPanel.querySelector('.coords-label');
                    const originalText = label.textContent;
                    label.textContent = 'âœ… ë³µì‚¬ë¨!';
                    
                    setTimeout(() => {
                        coordsPanel.classList.remove('copied');
                        label.textContent = originalText;
                    }, 1500);
                    
                    showMsg('ğŸ“‹ ì¢Œí‘œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (err) {
                    showMsg('âŒ ì¢Œí‘œ ë³µì‚¬ ì‹¤íŒ¨');
                }
            });
        }
    }, 1000);
});

// â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
// â˜…â˜…â˜… AudioManager - ê²Œì„ ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ â˜…â˜…â˜…
// BGM ë° íš¨ê³¼ìŒ ì¬ìƒ ê´€ë¦¬
// â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
const AudioManager = {
    // ì˜¤ë””ì˜¤ ì„¤ì • (Supabaseì—ì„œ ë¡œë“œ)
    config: {
        bgm_menu: null,
        bgm_explore: null,
        bgm_battle: null,
        bgm_station: null,
        sfx_engine: null,
        sfx_boost: null,
        sfx_fire: null,
        sfx_explosion: null,
        sfx_hit: null,
        sfx_dock: null,
        sfx_warning: null,
        sfx_fuel_low: null,
        sfx_mission_complete: null,
        sfx_click: null,
        sfx_autopilot: null,
        sfx_warp: null,
        sfx_shield: null,
        sfx_scan: null,
        sfx_cockpit: null
    },

    // ì˜¤ë””ì˜¤ ê°ì²´ ìºì‹œ
    audioCache: {},

    // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ BGM
    currentBGM: null,
    currentBGMType: null,

    // ë³¼ë¥¨ ì„¤ì •
    bgmVolume: 0.5,
    sfxVolume: 0.7,

    // ìŒì†Œê±° ìƒíƒœ
    muted: false,

    // ì´ˆê¸°í™” ì—¬ë¶€
    initialized: false,

    // ì„¤ì • ë¡œë“œ
    loadConfig: async function() {
        try {
            const { data, error } = await supabase
                .from('config')
                .select('value')
                .eq('key', 'game_audio')
                .single();

            if (data && data.value) {
                this.config = { ...this.config, ...data.value };
                console.log('ğŸ”Š ì˜¤ë””ì˜¤ ì„¤ì • ë¡œë“œ ì™„ë£Œ');
            }
            this.initialized = true;
        } catch (err) {
            console.log('ğŸ”‡ ì˜¤ë””ì˜¤ ì„¤ì • ì—†ìŒ (ê¸°ë³¸ê°’ ì‚¬ìš©)');
            this.initialized = true;
        }
    },

    // ì˜¤ë””ì˜¤ ê°ì²´ ê°€ì ¸ì˜¤ê¸° (ìºì‹œ ì‚¬ìš©)
    getAudio: function(type) {
        if (!this.config[type]) return null;

        if (!this.audioCache[type]) {
            this.audioCache[type] = new Audio(this.config[type]);
        }
        return this.audioCache[type];
    },

    // BGM ì¬ìƒ
    playBGM: function(type) {
        if (this.muted) return;
        if (!this.config[type]) return;

        // ì´ë¯¸ ê°™ì€ BGM ì¬ìƒ ì¤‘ì´ë©´ ë¬´ì‹œ
        if (this.currentBGMType === type && this.currentBGM && !this.currentBGM.paused) {
            return;
        }

        // í˜„ì¬ BGM ì •ì§€
        this.stopBGM();

        // ìƒˆ BGM ì¬ìƒ
        const audio = this.getAudio(type);
        if (audio) {
            audio.volume = this.bgmVolume;
            audio.loop = true;
            audio.play().catch(e => console.log('BGM ì¬ìƒ ëŒ€ê¸°:', e.message));
            this.currentBGM = audio;
            this.currentBGMType = type;
        }
    },

    // BGM ì •ì§€
    stopBGM: function() {
        if (this.currentBGM) {
            this.currentBGM.pause();
            this.currentBGM.currentTime = 0;
            this.currentBGM = null;
            this.currentBGMType = null;
        }
    },

    // íš¨ê³¼ìŒ ì¬ìƒ
    playSFX: function(type) {
        if (this.muted) return;
        if (!this.config[type]) return;

        // íš¨ê³¼ìŒì€ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ë™ì‹œ ì¬ìƒ ê°€ëŠ¥)
        const audio = new Audio(this.config[type]);
        audio.volume = this.sfxVolume;
        audio.play().catch(e => console.log('SFX ì¬ìƒ ì‹¤íŒ¨:', e.message));
    },

    // BGM ë³¼ë¥¨ ì„¤ì •
    setBGMVolume: function(volume) {
        this.bgmVolume = Math.max(0, Math.min(1, volume));
        if (this.currentBGM) {
            this.currentBGM.volume = this.bgmVolume;
        }
    },

    // íš¨ê³¼ìŒ ë³¼ë¥¨ ì„¤ì •
    setSFXVolume: function(volume) {
        this.sfxVolume = Math.max(0, Math.min(1, volume));
    },

    // ìŒì†Œê±° í† ê¸€
    toggleMute: function() {
        this.muted = !this.muted;
        if (this.muted) {
            this.stopBGM();
        }
        return this.muted;
    },

    // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ ì˜¤ë””ì˜¤ í™œì„±í™” (ë¸Œë¼ìš°ì € ì •ì±… ëŒ€ì‘)
    enableAudio: function() {
        // ë¬´ìŒ ì˜¤ë””ì˜¤ ì¬ìƒìœ¼ë¡œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í™œì„±í™”
        const silentAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
        silentAudio.play().catch(() => {});
    }
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ë””ì˜¤ ì„¤ì • ë¡œë“œ
document.addEventListener('DOMContentLoaded', () => {
    AudioManager.loadConfig();
});

// ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œ ì˜¤ë””ì˜¤ í™œì„±í™”
document.addEventListener('click', () => {
    AudioManager.enableAudio();
}, { once: true });

// â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
// â˜…â˜…â˜… GameDataManager - ë©€í‹°í”Œë ˆì´ì–´ ì„œë²„ ì €ì¥ ì‹œìŠ¤í…œ â˜…â˜…â˜…
// ì‹±ê¸€ëª¨ë“œ: localStorage ì‚¬ìš© (ê¸°ì¡´ í˜¸í™˜)
// ë©€í‹°ëª¨ë“œ: Supabase ì„œë²„ ì‚¬ìš© (ì¹˜íŒ… ë°©ì§€)
// â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
const GameDataManager = {
    // API ì—”ë“œí¬ì¸íŠ¸
    API_URL: '/api/gamedata',

    // í˜„ì¬ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
    getUserId: function() {
        if (window.currentUser) {
            return window.currentUser.id || window.currentUser.email;
        }
        if (window.mpUserId) return window.mpUserId;
        if (window.mpUser) return window.mpUser.id;
        return null;
    },

    // ë©€í‹°ëª¨ë“œ ì—¬ë¶€ í™•ì¸
    isMultiMode: function() {
        return window.gameMode === 'multi';
    },

    // â˜… ë°ì´í„° ì €ì¥ (ë©€í‹°: ì„œë²„, ì‹±ê¸€: localStorage)
    save: async function(dataType, data, localStorageKey) {
        // ë©€í‹°ëª¨ë“œ + ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ì„œë²„ ì‚¬ìš©
        if (this.isMultiMode() && this.getUserId()) {
            try {
                const response = await fetch(`${this.API_URL}?userId=${encodeURIComponent(this.getUserId())}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dataType, data })
                });

                if (!response.ok) {
                    const err = await response.json();
                    console.warn('GameDataManager ì„œë²„ ì €ì¥ ì‹¤íŒ¨:', err);
                    // ì„œë²„ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ì—ë„ ì €ì¥ (ë°±ì—…)
                    if (localStorageKey) {
                        localStorage.setItem(localStorageKey, JSON.stringify(data));
                    }
                    return false;
                }

                console.log(`âœ… GameData ì„œë²„ ì €ì¥ ì„±ê³µ: ${dataType}`);
                return true;
            } catch (e) {
                console.error('GameDataManager ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', e);
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ë¡œì»¬ì—ë„ ì €ì¥ (ë°±ì—…)
                if (localStorageKey) {
                    localStorage.setItem(localStorageKey, JSON.stringify(data));
                }
                return false;
            }
        } else {
            // ì‹±ê¸€ëª¨ë“œ ë˜ëŠ” ë¹„ë¡œê·¸ì¸: localStorage ì‚¬ìš©
            if (localStorageKey) {
                localStorage.setItem(localStorageKey, JSON.stringify(data));
            }
            return true;
        }
    },

    // â˜… ë°ì´í„° ë¡œë“œ (ë©€í‹°: ì„œë²„, ì‹±ê¸€: localStorage)
    load: async function(dataType, localStorageKey) {
        // ë©€í‹°ëª¨ë“œ + ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ì„œë²„ ì‚¬ìš©
        if (this.isMultiMode() && this.getUserId()) {
            try {
                const response = await fetch(
                    `${this.API_URL}?userId=${encodeURIComponent(this.getUserId())}&dataType=${dataType}`
                );

                if (!response.ok) {
                    console.warn('GameDataManager ì„œë²„ ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ í´ë°±');
                    // ì„œë²„ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ì—ì„œ ë¡œë“œ
                    if (localStorageKey) {
                        const local = localStorage.getItem(localStorageKey);
                        return local ? JSON.parse(local) : null;
                    }
                    return null;
                }

                const result = await response.json();
                console.log(`âœ… GameData ì„œë²„ ë¡œë“œ ì„±ê³µ: ${dataType}`);
                return result[dataType] || null;
            } catch (e) {
                console.error('GameDataManager ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', e);
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ë¡œì»¬ì—ì„œ ë¡œë“œ
                if (localStorageKey) {
                    const local = localStorage.getItem(localStorageKey);
                    return local ? JSON.parse(local) : null;
                }
                return null;
            }
        } else {
            // ì‹±ê¸€ëª¨ë“œ ë˜ëŠ” ë¹„ë¡œê·¸ì¸: localStorage ì‚¬ìš©
            if (localStorageKey) {
                const local = localStorage.getItem(localStorageKey);
                return local ? JSON.parse(local) : null;
            }
            return null;
        }
    },

    // â˜… ë°ì´í„° ì‚­ì œ
    delete: async function(dataType, localStorageKey) {
        if (this.isMultiMode() && this.getUserId()) {
            try {
                await fetch(`${this.API_URL}?userId=${encodeURIComponent(this.getUserId())}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dataType })
                });
            } catch (e) {
                console.error('GameDataManager ì‚­ì œ ì˜¤ë¥˜:', e);
            }
        }
        // ë¡œì»¬ë„ í•­ìƒ ì‚­ì œ
        if (localStorageKey) {
            localStorage.removeItem(localStorageKey);
        }
    }
};

window.GameDataManager = GameDataManager;

// â˜…â˜…â˜… ìš°ì£¼ì„  ë§ˆì§€ë§‰ ìœ„ì¹˜ ì €ì¥/ë¡œë“œ ì‹œìŠ¤í…œ â˜…â˜…â˜…
// â˜… ë©€í‹°ëª¨ë“œ: GameDataManager ì‚¬ìš© (ì„œë²„ ì €ì¥)
// â˜… ì‹±ê¸€ëª¨ë“œ: localStorage ì‚¬ìš© (ê¸°ì¡´ í˜¸í™˜)
const ShipPositionManager = {
    // â˜… ê²Œì„ ëª¨ë“œë³„ ì €ì¥ í‚¤ ë°˜í™˜
    getStorageKey: function() {
        const mode = window.gameMode || 'single';
        return `milkyway-ship-position-${mode}`;
    },

    // â˜… ìœ„ì¹˜ ë°ì´í„° ìƒì„± (ê³µí†µ)
    createPositionData: function() {
        if (!playerShip || !playerShip.mesh || !window.currentUser) return null;

        // í˜„ì¬ ì§„í–‰ ë°©í–¥ ê³„ì‚°
        const fwd = new THREE.Vector3(0, 0, -1).applyQuaternion(playerShip.mesh.quaternion);

        return {
            userId: window.currentUser.id || window.currentUser.email,
            gameMode: window.gameMode || 'single',
            position: {
                x: playerShip.mesh.position.x,
                y: playerShip.mesh.position.y,
                z: playerShip.mesh.position.z
            },
            rotation: {
                x: playerShip.mesh.rotation.x,
                y: playerShip.mesh.rotation.y,
                z: playerShip.mesh.rotation.z
            },
            direction: { x: fwd.x, y: fwd.y, z: fwd.z },
            shipType: window.currentShipType ? window.currentShipType.id : 'shuttle',
            shipName: window.currentShipType ? window.currentShipType.name : 'ì…”í‹€',
            fuel: playerShip.fuel,
            speed: playerShip.speed,
            autopilot: {
                engaged: window.autopilot?.engaged || false,
                targetName: window.shipTargetBody?.name || null
            },
            timestamp: Date.now()
        };
    },

    // í˜„ì¬ ìš°ì£¼ì„  ìœ„ì¹˜ ì €ì¥ (ë°©í–¥, ìë™í•­ë²• í¬í•¨)
    // â˜… ë©€í‹°ëª¨ë“œ: ì„œë²„ì— ì €ì¥, ì‹±ê¸€ëª¨ë“œ: localStorage
    save: function() {
        const data = this.createPositionData();
        if (!data) return;

        // â˜… GameDataManagerë¥¼ í†µí•´ ì €ì¥ (ë©€í‹°ëª¨ë“œëŠ” ì„œë²„, ì‹±ê¸€ì€ ë¡œì»¬)
        GameDataManager.save('ship_position', data, this.getStorageKey());
        console.log(`ìš°ì£¼ì„  ìœ„ì¹˜ ì €ì¥ë¨ (${data.gameMode}):`, data.position);
    },

    // ì €ì¥ëœ ìš°ì£¼ì„  ìœ„ì¹˜ ë¡œë“œ (ë™ê¸° ë²„ì „ - ì‹±ê¸€ëª¨ë“œ í˜¸í™˜)
    load: function() {
        // ì‹±ê¸€ëª¨ë“œëŠ” ê¸°ì¡´ ë°©ì‹ ìœ ì§€
        if (window.gameMode !== 'multi') {
            const saved = localStorage.getItem(this.getStorageKey());
            if (!saved) return null;
            return this.validateAndParse(saved);
        }
        // ë©€í‹°ëª¨ë“œëŠ” ë¹„ë™ê¸° loadAsync ì‚¬ìš© ê¶Œì¥
        // í˜¸í™˜ì„±ì„ ìœ„í•´ ë¡œì»¬ ìºì‹œ ë°˜í™˜
        const saved = localStorage.getItem(this.getStorageKey());
        if (!saved) return null;
        return this.validateAndParse(saved);
    },

    // â˜… ë¹„ë™ê¸° ë¡œë“œ (ë©€í‹°ëª¨ë“œìš©)
    loadAsync: async function() {
        const localKey = this.getStorageKey();
        const data = await GameDataManager.load('ship_position', localKey);
        if (!data) return null;
        return this.validateData(data);
    },

    // â˜… ë°ì´í„° íŒŒì‹± ë° ê²€ì¦ (ë¬¸ìì—´ìš©)
    validateAndParse: function(saved) {
        try {
            const data = JSON.parse(saved);
            return this.validateData(data);
        } catch (e) {
            return null;
        }
    },

    // â˜… ë°ì´í„° ê²€ì¦ (ê°ì²´ìš©)
    validateData: function(data) {
        // 24ì‹œê°„ ì´ë‚´ ë°ì´í„°ë§Œ ìœ íš¨
        if (Date.now() - data.timestamp > 24 * 60 * 60 * 1000) {
            this.clear();
            return null;
        }
        // ê²Œì„ ëª¨ë“œ í™•ì¸
        const currentMode = window.gameMode || 'single';
        if (data.gameMode && data.gameMode !== currentMode) {
            return null;
        }
        return data;
    },

    // ì €ì¥ëœ ìš°ì£¼ì„  ìœ„ì¹˜ ë¡œë“œ (ê¸°ì¡´ í˜¸í™˜ìš© - deprecated)
    loadLegacy: function() {
        const saved = localStorage.getItem(this.getStorageKey());
        if (!saved) return null;
        
        try {
            const data = JSON.parse(saved);
            // 24ì‹œê°„ ì´ë‚´ ë°ì´í„°ë§Œ ìœ íš¨
            if (Date.now() - data.timestamp > 24 * 60 * 60 * 1000) {
                localStorage.removeItem(this.getStorageKey());
                return null;
            }
            // â˜… ê²Œì„ ëª¨ë“œ í™•ì¸ (í˜¹ì‹œ ì˜ëª»ëœ ë°ì´í„° ë°©ì§€)
            const currentMode = window.gameMode || 'single';
            if (data.gameMode && data.gameMode !== currentMode) {
                return null;
            }
            return data;
        } catch (e) {
            return null;
        }
    },
    
    // ì €ì¥ëœ ìœ„ì¹˜ ì‚­ì œ
    clear: function() {
        // â˜… GameDataManagerë¥¼ í†µí•´ ì‚­ì œ (ì„œë²„ + ë¡œì»¬ ëª¨ë‘)
        GameDataManager.delete('ship_position', this.getStorageKey());
    },
    
    // ì €ì¥ëœ ìœ„ì¹˜ì—ì„œ íƒ‘ìŠ¹ (ì‹œê°„ ê¸°ë°˜ ìœ„ì¹˜ ë³´ì • í¬í•¨)
    restoreShip: function(data) {
        if (!data || !playerShip || !playerShip.mesh) return false;

        let finalPosition = { ...data.position };
        let travelMessage = '';

        // â˜… ì‹œê°„ ê¸°ë°˜ ìœ„ì¹˜ ë³´ì • (ìµœëŒ€ 5ë¶„)
        if (data.timestamp && data.speed > 0.1 && data.direction) {
            const elapsedTime = (Date.now() - data.timestamp) / 1000;  // ì´ˆ ë‹¨ìœ„
            const maxCompensationTime = 5 * 60;  // ìµœëŒ€ 5ë¶„
            const compensationTime = Math.min(elapsedTime, maxCompensationTime);

            if (compensationTime > 1) {  // 1ì´ˆ ì´ìƒ ê²½ê³¼ ì‹œì—ë§Œ ë³´ì •
                const travelDistance = data.speed * compensationTime;

                // ìë™í•­ë²• ì¤‘ì´ì—ˆìœ¼ë©´ ëª©í‘œ ë°©í–¥ìœ¼ë¡œ, ì•„ë‹ˆë©´ ë§ˆì§€ë§‰ ë°©í–¥ìœ¼ë¡œ
                let dir = data.direction;
                if (data.autopilot?.engaged && data.autopilot?.targetName) {
                    // ëª©í‘œ ì²œì²´ ì°¾ê¸°
                    const targetBody = allBodies.find(b => b.name === data.autopilot.targetName);
                    if (targetBody && targetBody.mesh) {
                        const targetPos = targetBody.mesh.position;
                        const dx = targetPos.x - data.position.x;
                        const dy = targetPos.y - data.position.y;
                        const dz = targetPos.z - data.position.z;
                        const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
                        if (dist > 0) {
                            dir = { x: dx/dist, y: dy/dist, z: dz/dist };
                        }
                    }
                }

                // ìœ„ì¹˜ ë³´ì • ì ìš©
                finalPosition.x += dir.x * travelDistance;
                finalPosition.y += dir.y * travelDistance;
                finalPosition.z += dir.z * travelDistance;

                const minutes = Math.floor(compensationTime / 60);
                const seconds = Math.floor(compensationTime % 60);
                if (minutes > 0) {
                    travelMessage = ` (${minutes}ë¶„ ${seconds}ì´ˆ ë™ì•ˆ ${travelDistance.toFixed(0)} ì´ë™)`;
                } else {
                    travelMessage = ` (${seconds}ì´ˆ ë™ì•ˆ ${travelDistance.toFixed(0)} ì´ë™)`;
                }

                console.log(`â±ï¸ ì‹œê°„ ë³´ì •: ${compensationTime.toFixed(1)}ì´ˆ ê²½ê³¼, ${travelDistance.toFixed(0)} ì´ë™`);
            }
        }

        playerShip.mesh.position.set(finalPosition.x, finalPosition.y, finalPosition.z);
        playerShip.mesh.rotation.set(data.rotation.x, data.rotation.y, data.rotation.z);
        playerShip.fuel = data.fuel || SHIP_CONFIG.maxFuel;
        playerShip.speed = 0;  // ì†ë„ëŠ” 0ìœ¼ë¡œ ì‹œì‘

        showMsg(`ğŸš€ ${data.shipName}ì— íƒ‘ìŠ¹í–ˆìŠµë‹ˆë‹¤!${travelMessage}`);
        console.log('ìš°ì£¼ì„  ìœ„ì¹˜ ë³µì›ë¨:', finalPosition);
        return true;
    }
};

// ìš°ì£¼ì„  ìœ„ì¹˜ ìë™ ì €ì¥ (10ì´ˆë§ˆë‹¤)
setInterval(() => {
    if (window.isPilotMode && playerShip && playerShip.mesh && window.currentUser && !playerShip.isDocked) {
        ShipPositionManager.save();
    }
}, 10000);

// í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì €ì¥
window.addEventListener('beforeunload', () => {
    if (window.isPilotMode && playerShip && playerShip.mesh && window.currentUser) {
        ShipPositionManager.save();
    }
});

// â˜…â˜…â˜… ì €ì¥ëœ ìš°ì£¼ì„  ìœ„ì¹˜ ì•ˆë‚´ ëª¨ë‹¬ â˜…â˜…â˜…
function showSavedShipPrompt() {
    const savedData = ShipPositionManager.load();
    if (!savedData) return false;
    
    // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ìì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
    if (window.currentUser && (window.currentUser.id === savedData.userId || window.currentUser.email === savedData.userId)) {
        const pos = savedData.position;
        const coordsStr = `X: ${pos.x.toFixed(0)}, Y: ${pos.y.toFixed(0)}, Z: ${pos.z.toFixed(0)}`;
        
        // ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ
        const modal = document.createElement('div');
        modal.id = 'saved-ship-modal';
        modal.innerHTML = `
            <div class="saved-ship-content">
                <div class="saved-ship-icon">ğŸš€</div>
                <div class="saved-ship-title">${t('savedShipFound')}</div>
                <div class="saved-ship-info">
                    <div class="ship-name">${savedData.shipName}</div>
                    <div class="ship-coords">ğŸ“ ${coordsStr}</div>
                    <div class="ship-fuel">${t('fuelPercent')}: ${Math.round(savedData.fuel)}%</div>
                </div>
                <div class="saved-ship-buttons">
                    <button id="btn-restore-ship" class="restore-btn">ğŸš€ ${t('restoreShip')}</button>
                    <button id="btn-new-ship" class="new-btn">ğŸ›¸ ${t('newShipStart')}</button>
                </div>
            </div>
        `;
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; align-items: center;
            justify-content: center; z-index: 100000;
        `;
        document.body.appendChild(modal);
        
        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            .saved-ship-content {
                background: linear-gradient(135deg, rgba(0,40,80,0.95) 0%, rgba(0,20,50,0.98) 100%);
                border: 2px solid #00aaff; border-radius: 15px; padding: 30px;
                text-align: center; max-width: 350px;
                box-shadow: 0 0 30px rgba(0,170,255,0.4);
                animation: fadeIn 0.3s;
            }
            .saved-ship-icon { font-size: 50px; margin-bottom: 10px; }
            .saved-ship-title { font-size: 20px; color: #00aaff; font-family: 'Orbitron', sans-serif; margin-bottom: 15px; }
            .saved-ship-info { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
            .ship-name { font-size: 16px; color: #fff; font-weight: bold; margin-bottom: 8px; }
            .ship-coords { font-size: 12px; color: #00ff88; font-family: monospace; margin-bottom: 5px; }
            .ship-fuel { font-size: 12px; color: #ffaa00; }
            .saved-ship-buttons { display: flex; flex-direction: column; gap: 10px; }
            .restore-btn { background: linear-gradient(135deg, #0088ff, #00aaff); color: #fff; border: none;
                padding: 12px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; font-family: 'Orbitron', sans-serif; }
            .restore-btn:hover { background: linear-gradient(135deg, #00aaff, #00ccff); }
            .new-btn { background: transparent; color: #888; border: 1px solid #555;
                padding: 10px 20px; border-radius: 8px; font-size: 12px; cursor: pointer; }
            .new-btn:hover { border-color: #888; color: #aaa; }
            @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        `;
        document.head.appendChild(style);
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('btn-restore-ship').onclick = () => {
            modal.remove();
            // ìš°ì£¼ì„  ìƒì„± í›„ ìœ„ì¹˜ ë³µì›
            setTimeout(() => {
                if (ShipPositionManager.restoreShip(savedData)) {
                    isPilotMode = true;
                    enterCockpitView();
                }
            }, 500);
        };
        
        document.getElementById('btn-new-ship').onclick = () => {
            ShipPositionManager.clear();
            modal.remove();
            // ì •ìƒì ì¸ ë¡œê·¸ì¸ íë¦„
        };
        
        return true;
    }
    return false;
}

// ë¡œê·¸ì¸ ì‹œ ì €ì¥ëœ ìš°ì£¼ì„  í™•ì¸
window.checkSavedShipOnLogin = function() {
    if (window.currentUser) {
        setTimeout(() => {
            showSavedShipPrompt();
        }, 1000);
    }
};

// ===== ì‚¬ìš´ë“œ ìŠ¬ë¼ì´ë“œ ì»¨íŠ¸ë¡¤ (DOM ë¡œë“œ í›„) =====
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        // â˜…â˜…â˜… BGM ìë™ ì¬ìƒ (ì²« ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„) â˜…â˜…â˜…
        const startBgmOnce = () => {
            if (typeof SpaceAudio !== 'undefined' && !SpaceAudio.isPlaying) {
                SpaceAudio.playSpace();
                const soundOnoff = document.getElementById('sound-onoff');
                if (soundOnoff) {
                    soundOnoff.textContent = 'ğŸ”Š';
                    soundOnoff.classList.add('on');
                }
                console.log('ğŸµ BGM ìë™ ì¬ìƒ ì‹œì‘');
            }
            // ì´ë²¤íŠ¸ ì œê±° (í•œ ë²ˆë§Œ ì‹¤í–‰)
            document.removeEventListener('click', startBgmOnce);
            document.removeEventListener('touchstart', startBgmOnce);
            document.removeEventListener('keydown', startBgmOnce);
        };
        
        // ì²« ìƒí˜¸ì‘ìš© ì‹œ BGM ì‹œì‘ (ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì •ì±… ìš°íšŒ)
        document.addEventListener('click', startBgmOnce);
        document.addEventListener('touchstart', startBgmOnce);
        document.addEventListener('keydown', startBgmOnce);
        
        // ì²œì²´ ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
        const bodyInfoClose = document.getElementById('body-info-close');
        if (bodyInfoClose) {
            bodyInfoClose.addEventListener('click', () => {
                const modal = document.getElementById('body-info-modal');
                if (modal) modal.style.display = 'none';
            });
        }
        
        // í™”ì‚´í‘œ í´ë¦­: ìŠ¬ë¼ì´ë“œ ì—´ê¸°/ë‹«ê¸°
        const soundArrow = document.getElementById('sound-arrow');
        if (soundArrow) {
            soundArrow.addEventListener('click', function() {
                const slide = document.getElementById('sound-slide');
                if (!slide) return;
                const isCollapsed = slide.classList.contains('collapsed');
                
                if (isCollapsed) {
                    slide.classList.remove('collapsed');
                    slide.classList.add('expanded');
                    this.textContent = 'â–¶';
                } else {
                    slide.classList.remove('expanded');
                    slide.classList.add('collapsed');
                    this.textContent = 'â—€';
                }
            });
        }
        
        // ON/OFF ë²„íŠ¼
        const soundOnoff = document.getElementById('sound-onoff');
        if (soundOnoff) {
            soundOnoff.addEventListener('click', function() {
                if (typeof SpaceAudio !== 'undefined') {
                    if (SpaceAudio.isPlaying) {
                        SpaceAudio.stop();
                        this.textContent = 'ğŸ”‡';
                        this.classList.remove('on');
                    } else {
                        SpaceAudio.playSpace();
                        this.textContent = 'ğŸ”Š';
                        this.classList.add('on');
                    }
                }
            });
        }
        
        // ë³¼ë¥¨ ìŠ¬ë¼ì´ë”
        const soundSlider = document.getElementById('sound-slider');
        if (soundSlider) {
            soundSlider.addEventListener('input', function() {
                const vol = this.value / 100;
                const valDisplay = document.getElementById('sound-val');
                if (valDisplay) valDisplay.textContent = this.value + '%';
                if (typeof SpaceAudio !== 'undefined') {
                    SpaceAudio.setVolume(vol);
                }
            });
        }
        
        console.log('ì‚¬ìš´ë“œ ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™” ì™„ë£Œ');
    }, 500);
});

// ===== ë§ì›ê²½ ëª¨ë“œ (ì™„ì „ ê°œì„ ) =====
const telescopeMode = {
    active: false,
    zoom: 1,
    baseMaxZoom: 20,      // ê¸°ë³¸ ìµœëŒ€ ì¤Œ
    maxZoom: 20,          // í˜„ì¬ ìµœëŒ€ ì¤Œ (ì—…ê·¸ë ˆì´ë“œì— ë”°ë¼ ë³€ê²½)
    originalFOV: 75,
    equippedTelescope: 'basic',  // basic, advanced, professional
    fineControl: { x: 0, y: 0 },
    originalCameraParent: null,
    originalControlsEnabled: true
};

// ë§ì›ê²½ ì—…ê·¸ë ˆì´ë“œ ì •ë³´
const telescopeUpgrades = {
    basic: { name: 'ê¸°ë³¸ ë§ì›ê²½', maxZoom: 20, price: 0, owned: true, description: 'ê¸°ë³¸ ì¥ì°©. 20ë°° ì¤Œ.' },
    standard: { name: 'í‘œì¤€ ë§ì›ê²½', maxZoom: 30, price: 2000, owned: false, description: '30ë°° ì¤Œ. í–¥ìƒëœ ì„±ëŠ¥.' },
    advanced: { name: 'ê³ ê¸‰ ë§ì›ê²½', maxZoom: 50, price: 5000, owned: false, description: '50ë°° ì¤Œ. ì„ ëª…í•œ í™”ì§ˆ.' },
    professional: { name: 'ì „ë¬¸ê°€ ë§ì›ê²½', maxZoom: 100, price: 15000, owned: false, description: '100ë°° ì¤Œ. ìµœê³  ì„±ëŠ¥.' }
};

function enterTelescopeMode() {
    // â˜… ìš°ì£¼ ëª¨ë“œ(ì™¸ë¶€ ë·°)ì—ì„œë§Œ ë§ì›ê²½ ì‚¬ìš© ê°€ëŠ¥
    if (window.isPilotMode) {
        if (typeof showMsg === 'function') showMsg('ğŸ”­ ìš°ì£¼ ëª¨ë“œì—ì„œë§Œ ë§ì›ê²½ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Ví‚¤ë¡œ ì „í™˜)');
        return;
    }
    
    if (!playerShip) {
        if (typeof showMsg === 'function') showMsg('ìš°ì£¼ì„ ì— íƒ‘ìŠ¹í•´ì•¼ ë§ì›ê²½ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    // â˜… camera í™•ì¸
    if (!window.camera) {
        if (typeof showMsg === 'function') showMsg('ì¹´ë©”ë¼ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
        return;
    }
    
    telescopeMode.active = true;
    telescopeMode.originalFOV = window.camera.fov;
    telescopeMode.zoom = 1;
    
    // í˜„ì¬ ì¥ì°©ëœ ë§ì›ê²½ì— ë”°ë¥¸ ìµœëŒ€ ì¤Œ ì„¤ì •
    const equipped = telescopeUpgrades[telescopeMode.equippedTelescope];
    telescopeMode.maxZoom = equipped ? equipped.maxZoom : 20;
    
    // UI ì—…ë°ì´íŠ¸
    updateTelescopeUI();
    
    // ì˜¤ë²„ë ˆì´ í‘œì‹œ
    document.getElementById('telescope-overlay').style.display = 'flex';
    
    // ìŠ¬ë¼ì´ë” ìµœëŒ€ê°’ ì—…ë°ì´íŠ¸
    const slider = document.getElementById('telescope-zoom-slider');
    if (slider) {
        slider.max = telescopeMode.maxZoom;
        slider.value = 1;
    }
    
    // OrbitControls ë¹„í™œì„±í™” (ë§ì›ê²½ ì „ìš© ì»¨íŠ¸ë¡¤ ì‚¬ìš©)
    if (window.controls) {
        telescopeMode.originalControlsEnabled = window.controls.enabled;
        window.controls.enabled = false;
    }
    
    if (typeof showMsg === 'function') showMsg('ğŸ”­ ë§ì›ê²½ ëª¨ë“œ - ë“œë˜ê·¸ë¡œ ì‹œì  ì´ë™, íœ ë¡œ ì¤Œ');
}

function exitTelescopeMode() {
    telescopeMode.active = false;
    telescopeMode.zoom = 1;
    if (window.camera) {
        window.camera.fov = telescopeMode.originalFOV || 60;
        window.camera.updateProjectionMatrix();
    }
    document.getElementById('telescope-overlay').style.display = 'none';
    
    // OrbitControls ë³µì›
    if (window.controls) {
        window.controls.enabled = telescopeMode.originalControlsEnabled !== false;
    }
    
    if (typeof showMsg === 'function') showMsg('ë§ì›ê²½ ëª¨ë“œ ì¢…ë£Œ');
}

function updateTelescopeZoom(zoom) {
    if (!window.camera) return;
    telescopeMode.zoom = Math.max(1, Math.min(telescopeMode.maxZoom, zoom));
    window.camera.fov = telescopeMode.originalFOV / telescopeMode.zoom;
    window.camera.updateProjectionMatrix();
    
    // UI ì—…ë°ì´íŠ¸
    const zoomValue = document.getElementById('telescope-zoom-value');
    const zoomDisplay = document.getElementById('telescope-zoom-display');
    const slider = document.getElementById('telescope-zoom-slider');
    
    if (zoomValue) zoomValue.textContent = telescopeMode.zoom.toFixed(1) + 'x';
    if (zoomDisplay) zoomDisplay.textContent = telescopeMode.zoom.toFixed(1);
    if (slider) slider.value = telescopeMode.zoom;
    
    // ì¤Œì— ë”°ë¥¸ ë Œì¦ˆ íš¨ê³¼ ë³€ê²½
    updateTelescopeLensEffect();
}

function updateTelescopeLensEffect() {
    const lens = document.getElementById('telescope-lens');
    if (!lens) return;
    
    // ì¤Œì´ ë†’ì„ìˆ˜ë¡ ë¹„ë„¤íŒ… ë²”ìœ„ í™•ëŒ€
    const vignetteSize = 25 + (telescopeMode.zoom / telescopeMode.maxZoom) * 15;
    lens.style.background = `radial-gradient(circle at center, 
        transparent 0%, 
        transparent ${vignetteSize}%, 
        rgba(0,0,0,0.3) ${vignetteSize + 10}%, 
        rgba(0,0,0,0.7) ${vignetteSize + 20}%, 
        rgba(0,0,0,0.95) ${vignetteSize + 30}%)`;
}

function updateTelescopeUI() {
    // ìµœëŒ€ ì¤Œ í‘œì‹œ
    const maxZoomDisplay = document.getElementById('telescope-max-zoom-display');
    if (maxZoomDisplay) maxZoomDisplay.textContent = telescopeMode.maxZoom;
    
    // ì¥ì°©ëœ ë§ì›ê²½ ì •ë³´
    const equipped = telescopeUpgrades[telescopeMode.equippedTelescope];
    const equippedName = document.getElementById('telescope-equipped-name');
    if (equippedName && equipped) {
        equippedName.textContent = `${equipped.name} (${equipped.maxZoom}x)`;
    }
    
    // í”„ë¦¬ì…‹ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.telescope-preset-btn').forEach(btn => {
        const zoom = parseInt(btn.dataset.zoom);
        if (zoom <= telescopeMode.maxZoom) {
            btn.classList.remove('locked');
            btn.style.background = '#1a3a5c';
            btn.style.color = '#fff';
            btn.style.border = '1px solid #00aaff';
            btn.style.cursor = 'pointer';
            btn.textContent = btn.textContent.replace('ğŸ”’ ', '');
        } else {
            btn.classList.add('locked');
            btn.style.background = '#333';
            btn.style.color = '#888';
            btn.style.border = '1px solid #555';
            btn.style.cursor = 'not-allowed';
            if (!btn.textContent.startsWith('ğŸ”’')) {
                btn.textContent = 'ğŸ”’ ' + btn.textContent;
            }
        }
    });
}

// ë§ì›ê²½ êµ¬ë§¤ í•¨ìˆ˜
function buyTelescopeUpgrade(type) {
    const upgrade = telescopeUpgrades[type];
    if (!upgrade) return false;
    
    if (upgrade.owned) {
        showMsg('ì´ë¯¸ ë³´ìœ í•œ ë§ì›ê²½ì…ë‹ˆë‹¤.');
        return false;
    }
    
    const userCoins = getUserCoins();
    if (userCoins < upgrade.price) {
        showMsg(`ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${upgrade.price}, ë³´ìœ : ${userCoins})`);
        return false;
    }
    
    // ì½”ì¸ ì°¨ê°
    if (typeof addCoins === 'function') {
        addCoins(-upgrade.price);
    }
    
    // êµ¬ë§¤ ì™„ë£Œ
    upgrade.owned = true;
    telescopeMode.equippedTelescope = type;
    telescopeMode.maxZoom = upgrade.maxZoom;
    
    // ì„œë²„ì— ì €ì¥ (í”„ë¡œí•„ ì—…ë°ì´íŠ¸)
    if (window.supabaseClient && window.mpUserId) {
        window.supabaseClient
            .from('profiles')
            .update({ 
                telescope_level: type,
                telescope_owned: Object.keys(telescopeUpgrades).filter(k => telescopeUpgrades[k].owned)
            })
            .eq('id', window.mpUserId)
            .then(() => console.log('ë§ì›ê²½ ì—…ê·¸ë ˆì´ë“œ ì €ì¥ë¨'))
            .catch(e => console.warn('ë§ì›ê²½ ì €ì¥ ì‹¤íŒ¨:', e));
    }
    
    showMsg(`ğŸ”­ ${upgrade.name} êµ¬ë§¤ ì™„ë£Œ! (ìµœëŒ€ ${upgrade.maxZoom}ë°° ì¤Œ)`);
    return true;
}

// ë§ì›ê²½ ì¥ì°© í•¨ìˆ˜
function equipTelescope(type) {
    const upgrade = telescopeUpgrades[type];
    if (!upgrade || !upgrade.owned) {
        showMsg('ë¨¼ì € êµ¬ë§¤í•´ì•¼ í•©ë‹ˆë‹¤.');
        return false;
    }
    
    telescopeMode.equippedTelescope = type;
    telescopeMode.maxZoom = upgrade.maxZoom;
    
    if (telescopeMode.active) {
        updateTelescopeUI();
        const slider = document.getElementById('telescope-zoom-slider');
        if (slider) slider.max = telescopeMode.maxZoom;
    }
    
    showMsg(`ğŸ”­ ${upgrade.name} ì¥ì°© ì™„ë£Œ!`);
    return true;
}

// íƒ€ê²Ÿ ì •ë³´ ì—…ë°ì´íŠ¸ (ë ˆì´ìºìŠ¤íŠ¸ë¡œ ë°”ë¼ë³´ëŠ” ì²œì²´ í™•ì¸)
function updateTelescopeTarget() {
    if (!telescopeMode.active) return;
    if (!window.THREE || !window.camera) return;  // â˜… ë°©ì–´ ì½”ë“œ
    
    const targetInfo = document.getElementById('telescope-target-info');
    if (!targetInfo) return;
    
    // í™”ë©´ ì¤‘ì•™ì—ì„œ ë ˆì´ìºìŠ¤íŠ¸
    const raycaster = new window.THREE.Raycaster();
    raycaster.setFromCamera(new window.THREE.Vector2(0, 0), window.camera);
    
    // ëª¨ë“  ì²œì²´ ë©”ì‹œ ìˆ˜ì§‘
    const meshes = [];
    if (window.bodies) {
        window.bodies.forEach(b => {
            if (b.mesh) meshes.push({ mesh: b.mesh, name: b.name, body: b });
        });
    }
    if (window.satellites) {
        window.satellites.forEach(s => {
            if (s.mesh) meshes.push({ mesh: s.mesh, name: s.name, body: s });
        });
    }
    
    if (meshes.length === 0) return;  // â˜… ë©”ì‹œ ì—†ìœ¼ë©´ ë¦¬í„´
    
    const intersects = raycaster.intersectObjects(meshes.map(m => m.mesh), true);
    
    if (intersects.length > 0) {
        // ê°€ì¥ ê°€ê¹Œìš´ êµì°¨ì ì˜ ë¶€ëª¨ ì°¾ê¸°
        let targetMesh = intersects[0].object;
        while (targetMesh.parent && !meshes.find(m => m.mesh === targetMesh)) {
            targetMesh = targetMesh.parent;
        }
        
        const found = meshes.find(m => m.mesh === targetMesh || m.mesh.children.includes(targetMesh));
        if (found) {
            const dist = intersects[0].distance.toFixed(0);
            targetInfo.innerHTML = `íƒ€ê²Ÿ: <strong style="color:#ffff00;">${found.name}</strong> (${dist} km)`;
            return;
        }
    }
    
    targetInfo.textContent = t('targetNone');
}

// ë§ì›ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (DOM ë¡œë“œ í›„)
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const zoomSlider = document.getElementById('telescope-zoom-slider');
        const closeBtn = document.getElementById('btn-telescope-close');
        
        // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        if (zoomSlider) {
            zoomSlider.addEventListener('input', function() {
                updateTelescopeZoom(parseFloat(this.value));
            });
        }
        
        // ë‹«ê¸° ë²„íŠ¼
        if (closeBtn) {
            closeBtn.addEventListener('click', exitTelescopeMode);
        }
        
        // í”„ë¦¬ì…‹ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.telescope-preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.classList.contains('locked')) {
                    showMsg('ì´ ì¤Œ ë ˆë²¨ì€ ê³ ê¸‰ ë§ì›ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤. ìš°ì£¼ì •ê±°ì¥ì—ì„œ êµ¬ë§¤í•˜ì„¸ìš”.');
                    return;
                }
                const zoom = parseFloat(this.dataset.zoom);
                updateTelescopeZoom(zoom);
            });
        });
        
        // íœ  ì¤Œ ì´ë²¤íŠ¸
        document.getElementById('telescope-overlay')?.addEventListener('wheel', function(e) {
            if (!telescopeMode.active) return;
            e.preventDefault();
            
            const delta = e.deltaY > 0 ? -1 : 1;
            const step = telescopeMode.maxZoom > 50 ? 2 : 1;
            updateTelescopeZoom(telescopeMode.zoom + delta * step);
        }, { passive: false });
        
        // â˜…â˜…â˜… ë§ì›ê²½ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ì¹´ë©”ë¼ íšŒì „ â˜…â˜…â˜…
        let telescopeDragging = false;
        let telescopeLastMouse = { x: 0, y: 0 };
        
        document.getElementById('telescope-overlay')?.addEventListener('mousedown', function(e) {
            if (!telescopeMode.active) return;
            telescopeDragging = true;
            telescopeLastMouse = { x: e.clientX, y: e.clientY };
            e.preventDefault();
        });
        
        document.addEventListener('mouseup', function() {
            telescopeDragging = false;
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!telescopeMode.active || !telescopeDragging) return;
            if (!window.THREE || !window.camera || !window.controls) return;
            
            const deltaX = e.clientX - telescopeLastMouse.x;
            const deltaY = e.clientY - telescopeLastMouse.y;
            
            // â˜… ì¤Œ ë ˆë²¨ì— ë”°ë¼ ê°ë„ í¬ê²Œ ì¡°ì ˆ (ì¤Œì´ ë†’ì„ìˆ˜ë¡ í›¨ì”¬ ëŠë¦¬ê²Œ)
            // ê¸°ë³¸ ê°ë„ 0.003, ì¤Œ ë°°ìœ¨ì˜ ì œê³±ì— ë°˜ë¹„ë¡€
            const baseSensitivity = 0.003;
            const sensitivity = baseSensitivity / (telescopeMode.zoom * telescopeMode.zoom * 0.1 + 1);
            
            // ì¹´ë©”ë¼ íšŒì „ (OrbitControlsì™€ ìœ ì‚¬í•˜ê²Œ)
            if (window.controls.target) {
                // spherical ì¢Œí‘œë¡œ íšŒì „
                const offset = new window.THREE.Vector3().copy(window.camera.position).sub(window.controls.target);
                const spherical = new window.THREE.Spherical().setFromVector3(offset);
                
                spherical.theta -= deltaX * sensitivity;
                spherical.phi -= deltaY * sensitivity;
                
                // phi ì œí•œ (0.1 ~ PI - 0.1)
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                
                offset.setFromSpherical(spherical);
                window.camera.position.copy(window.controls.target).add(offset);
                window.camera.lookAt(window.controls.target);
            }
            
            telescopeLastMouse = { x: e.clientX, y: e.clientY };
        });
        
        // â˜…â˜…â˜… ëª¨ë°”ì¼ í„°ì¹˜ ë“œë˜ê·¸ â˜…â˜…â˜…
        let telescopeTouchStart = { x: 0, y: 0 };
        
        document.getElementById('telescope-overlay')?.addEventListener('touchstart', function(e) {
            if (!telescopeMode.active) return;
            if (e.touches.length === 1) {
                telescopeTouchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        }, { passive: true });
        
        document.getElementById('telescope-overlay')?.addEventListener('touchmove', function(e) {
            if (!telescopeMode.active || e.touches.length !== 1) return;
            if (!window.THREE || !window.camera || !window.controls) return;
            
            const deltaX = e.touches[0].clientX - telescopeTouchStart.x;
            const deltaY = e.touches[0].clientY - telescopeTouchStart.y;
            
            // â˜… ì¤Œ ë ˆë²¨ì— ë”°ë¼ ê°ë„ í¬ê²Œ ì¡°ì ˆ (ì¤Œì´ ë†’ì„ìˆ˜ë¡ í›¨ì”¬ ëŠë¦¬ê²Œ)
            const baseSensitivity = 0.004;
            const sensitivity = baseSensitivity / (telescopeMode.zoom * telescopeMode.zoom * 0.1 + 1);
            
            if (window.controls.target) {
                const offset = new window.THREE.Vector3().copy(window.camera.position).sub(window.controls.target);
                const spherical = new window.THREE.Spherical().setFromVector3(offset);
                
                spherical.theta -= deltaX * sensitivity;
                spherical.phi -= deltaY * sensitivity;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                
                offset.setFromSpherical(spherical);
                window.camera.position.copy(window.controls.target).add(offset);
                window.camera.lookAt(window.controls.target);
            }
            
            telescopeTouchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }, { passive: true });
        
        // í•€ì¹˜ ì¤Œ
        let telescopeLastPinchDist = 0;
        
        document.getElementById('telescope-overlay')?.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                telescopeLastPinchDist = Math.sqrt(dx * dx + dy * dy);
            }
        }, { passive: true });
        
        document.getElementById('telescope-overlay')?.addEventListener('touchmove', function(e) {
            if (!telescopeMode.active || e.touches.length !== 2) return;
            
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            if (telescopeLastPinchDist > 0) {
                const delta = (dist - telescopeLastPinchDist) * 0.05;
                updateTelescopeZoom(telescopeMode.zoom + delta);
            }
            
            telescopeLastPinchDist = dist;
        }, { passive: true });
        
        // ESC í‚¤ë¡œ ì¢…ë£Œ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && telescopeMode.active) {
                exitTelescopeMode();
            }
        });
        
        // ì£¼ê¸°ì ìœ¼ë¡œ íƒ€ê²Ÿ ì •ë³´ ì—…ë°ì´íŠ¸
        setInterval(updateTelescopeTarget, 500);
    }, 500);
});

// â˜…â˜…â˜… ë©€í‹°ëª¨ë“œ íŠœí† ë¦¬ì–¼ ì‹œìŠ¤í…œ â˜…â˜…â˜…
const MultiTutorial = {
    STORAGE_KEY: 'starwalker_tutorial',
    currentStep: 0,
    overlay: null,
    highlightedElement: null,
    savedPosition: '',
    savedZIndex: '',
    
    // ì•ˆì „í•˜ê²Œ í˜„ì¬ ì–¸ì–´ ê°€ì ¸ì˜¤ê¸°
    getLang() {
        return window.currentLang || (typeof currentLang !== 'undefined' ? currentLang : 'en');
    },
    
    // ë‹¤êµ­ì–´ íŠœí† ë¦¬ì–¼ ë‹¨ê³„ ì •ì˜
    getSteps() {
        const lang = this.getLang();
        const isKo = lang === 'ko';
        const isJa = lang === 'ja';
        
        if (isKo) {
            return [
                {
                    id: 'welcome',
                    title: 'ğŸŒŒ STARÂ·WALKERì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!',
                    content: `
                        <p>ìš°ì£¼ íƒí—˜ì˜ ì„¸ê³„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</p>
                        <p>ì´ ê°€ì´ë“œê°€ ê¸°ë³¸ì ì¸ ì¡°ì‘ë²•ê³¼ ê¸°ëŠ¥ì„ ì•ˆë‚´í•´ ë“œë¦´ê²Œìš”.</p>
                        <div style="margin-top:15px;padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;">
                            <p style="margin:0;color:#00ffff;">ğŸ’¡ íŒ: ì–¸ì œë“ ì§€ <b>ESC</b> í‚¤ë¥¼ ëˆŒëŸ¬ ê°€ì´ë“œë¥¼ ê±´ë„ˆë›¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    `,
                    target: null,
                    position: 'center'
                },
                {
                    id: 'nav-panel',
                    title: 'ğŸª ì²œì²´ ëª©ë¡',
                    content: `
                        <p>ì¢Œì¸¡ì—ì„œ íƒœì–‘ê³„ì˜ ëª¨ë“  ì²œì²´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <ul style="margin:10px 0;padding-left:20px;">
                            <li><b>íƒœì–‘</b> - ìš°ë¦¬ íƒœì–‘ê³„ì˜ ì¤‘ì‹¬</li>
                            <li><b>í–‰ì„±ë“¤</b> - ìˆ˜ì„±, ê¸ˆì„±, ì§€êµ¬, í™”ì„± ë“±</li>
                            <li><b>ì •ê±°ì¥</b> - ì—°ë£Œ ë³´ê¸‰ ë° íƒí—˜ ê±°ì </li>
                        </ul>
                        <p style="color:#00ff88;">í´ë¦­í•˜ë©´ í•´ë‹¹ ì²œì²´ë¡œ ì¹´ë©”ë¼ê°€ ì´ë™í•©ë‹ˆë‹¤.</p>
                    `,
                    target: '#nav-panel',
                    position: 'right'
                },
                {
                    id: 'top-bar',
                    title: 'ğŸ›ï¸ ìƒë‹¨ ë©”ë‰´',
                    content: `
                        <div style="display:grid;gap:10px;">
                            <div><b style="color:#00ff88;">â›½ ì •ê±°ì¥</b> - ìš°ì£¼ ì •ê±°ì¥ ëª©ë¡ ë³´ê¸°</div>
                            <div><b style="color:#a855f7;">ğŸ“š ë„ê°</b> - ë°œê²¬í•œ ì²œì²´ ë„ê° í™•ì¸</div>
                            <div><b style="color:#00ffff;">ğŸ–¥ï¸ ì „ì²´í™”ë©´</b> - ëª°ì…ê° ìˆëŠ” í”Œë ˆì´</div>
                            <div><b style="color:#ff9500;">â±ï¸ 0.1x</b> - ì‹œê°„ ë°°ì† í‘œì‹œ</div>
                        </div>
                    `,
                    target: '#top-bar',
                    position: 'bottom'
                },
                {
                    id: 'login',
                    title: 'ğŸ‘¤ ë¡œê·¸ì¸',
                    content: `
                        <p>ìš°ì¸¡ ìƒë‹¨ì˜ <b style="color:#00ff88;">ë¡œê·¸ì¸</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³„ì •ì„ ë§Œë“¤ê±°ë‚˜ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
                        <p style="margin-top:10px;">ë¡œê·¸ì¸í•˜ë©´:</p>
                        <ul style="margin:10px 0;padding-left:20px;">
                            <li>ë‹¤ë¥¸ í”Œë ˆì´ì–´ì™€ í•¨ê»˜ íƒí—˜</li>
                            <li>ì§„í–‰ ìƒí™© ì €ì¥</li>
                            <li>ìš°ì£¼ì„  ì†Œìœ  ë° ì—…ê·¸ë ˆì´ë“œ</li>
                        </ul>
                        <p style="margin-top:10px;color:#00ffff;font-size:13px;">ğŸ’¡ ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆë‹¤ë©´ ì´ ë‹¨ê³„ëŠ” ê±´ë„ˆë›°ì„¸ìš”!</p>
                    `,
                    target: '#btn-login',
                    position: 'left'
                },
                {
                    id: 'boarding',
                    title: 'ğŸš€ ìš°ì£¼ì„  íƒ‘ìŠ¹',
                    content: `
                        <p>ìš°ì£¼ì„ ì€ <b style="color:#00ffff;">ìš°ì£¼ ì •ê±°ì¥</b>ì—ì„œ íƒ‘ìŠ¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <div style="margin:15px 0;padding:12px;background:rgba(0,255,136,0.15);border:1px solid #00ff88;border-radius:8px;">
                            <p style="margin:0;color:#00ff88;"><b>ğŸŒ ì²« ìš°ì£¼ì„  ë°›ê¸°</b></p>
                            <p style="margin:8px 0 0 0;">ì§€êµ¬ ê·¼ì²˜ì˜ <b>ISS ìš°ì£¼ì •ê±°ì¥</b>ìœ¼ë¡œ ì´ë™í•˜ë©´<br>ì²« ìš°ì£¼ì„ ì„ ì§€ê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
                        </div>
                        <div style="margin-top:15px;padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;">
                            <p style="margin:0;"><b>ì¡°ì¢… ë°©ë²•:</b></p>
                            <p style="margin:5px 0 0 0;">â€¢ <b>W/S</b> ë˜ëŠ” <b>â†‘/â†“</b> - ê°€ì†/ê°ì†</p>
                            <p style="margin:5px 0 0 0;">â€¢ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ - ë°©í–¥ ì „í™˜</p>
                            <p style="margin:5px 0 0 0;">â€¢ <b>ìë™í•­ë²•</b> - ëª©ì ì§€ ìë™ ë¹„í–‰</p>
                        </div>
                    `,
                    target: null,
                    position: 'center'
                },
                {
                    id: 'complete',
                    title: 'ğŸ‰ ì¤€ë¹„ ì™„ë£Œ!',
                    content: `
                        <p>ì´ì œ ìš°ì£¼ íƒí—˜ì„ ì‹œì‘í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                        <div style="margin-top:15px;display:grid;gap:8px;">
                            <div style="padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;">
                                ğŸ¯ <b>ë¯¸ì…˜</b>: ì²œì²´ë¥¼ ë°©ë¬¸í•˜ë©´ âœ“ í‘œì‹œê°€ ë©ë‹ˆë‹¤
                            </div>
                            <div style="padding:10px;background:rgba(255,149,0,0.1);border-radius:8px;">
                                â›½ <b>ì—°ë£Œ</b>: ì •ê±°ì¥ì—ì„œ ì—°ë£Œë¥¼ ë³´ê¸‰í•˜ì„¸ìš”
                            </div>
                            <div style="padding:10px;background:rgba(168,85,247,0.1);border-radius:8px;">
                                ğŸ‘¥ <b>ë©€í‹°í”Œë ˆì´</b>: ë‹¤ë¥¸ í”Œë ˆì´ì–´ì™€ ì‹¤ì‹œê°„ íƒí—˜!
                            </div>
                        </div>
                        <p style="margin-top:15px;color:#00ff88;text-align:center;">ì¦ê±°ìš´ ìš°ì£¼ íƒí—˜ ë˜ì„¸ìš”! ğŸš€</p>
                    `,
                    target: null,
                    position: 'center'
                }
            ];
        } else if (isJa) {
            return [
                {
                    id: 'welcome',
                    title: 'ğŸŒŒ STARÂ·WALKERã¸ã‚ˆã†ã“ãï¼',
                    content: `
                        <p>å®‡å®™æ¢æ¤œã®ä¸–ç•Œã¸ã‚ˆã†ã“ãï¼</p>
                        <p>ã“ã®ã‚¬ã‚¤ãƒ‰ãŒåŸºæœ¬çš„ãªæ“ä½œæ–¹æ³•ã¨æ©Ÿèƒ½ã‚’ã”æ¡ˆå†…ã—ã¾ã™ã€‚</p>
                        <div style="margin-top:15px;padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;">
                            <p style="margin:0;color:#00ffff;">ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã„ã¤ã§ã‚‚<b>ESC</b>ã‚­ãƒ¼ã§ã‚¬ã‚¤ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã™ã€‚</p>
                        </div>
                    `,
                    target: null,
                    position: 'center'
                },
                {
                    id: 'nav-panel',
                    title: 'ğŸª å¤©ä½“ãƒªã‚¹ãƒˆ',
                    content: `
                        <p>å·¦å´ã§å¤ªé™½ç³»ã®ã™ã¹ã¦ã®å¤©ä½“ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
                        <ul style="margin:10px 0;padding-left:20px;">
                            <li><b>å¤ªé™½</b> - å¤ªé™½ç³»ã®ä¸­å¿ƒ</li>
                            <li><b>æƒ‘æ˜Ÿ</b> - æ°´æ˜Ÿã€é‡‘æ˜Ÿã€åœ°çƒã€ç«æ˜Ÿãªã©</li>
                            <li><b>ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</b> - ç‡ƒæ–™è£œçµ¦ã¨æ¢æ¤œæ‹ ç‚¹</li>
                        </ul>
                        <p style="color:#00ff88;">ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚«ãƒ¡ãƒ©ãŒãã®å¤©ä½“ã«ç§»å‹•ã—ã¾ã™ã€‚</p>
                    `,
                    target: '#nav-panel',
                    position: 'right'
                },
                {
                    id: 'top-bar',
                    title: 'ğŸ›ï¸ ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼',
                    content: `
                        <div style="display:grid;gap:10px;">
                            <div><b style="color:#00ff88;">â›½ ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</b> - å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ</div>
                            <div><b style="color:#a855f7;">ğŸ“š å›³é‘‘</b> - ç™ºè¦‹ã—ãŸå¤©ä½“ã®æƒ…å ±</div>
                            <div><b style="color:#00ffff;">ğŸ–¥ï¸ å…¨ç”»é¢</b> - æ²¡å…¥æ„Ÿã®ã‚ã‚‹ãƒ—ãƒ¬ã‚¤</div>
                            <div><b style="color:#ff9500;">â±ï¸ 0.1x</b> - æ™‚é–“å€é€Ÿè¡¨ç¤º</div>
                        </div>
                    `,
                    target: '#top-bar',
                    position: 'bottom'
                },
                {
                    id: 'login',
                    title: 'ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³',
                    content: `
                        <p>å³ä¸Šã®<b style="color:#00ff88;">ãƒ­ã‚°ã‚¤ãƒ³</b>ãƒœã‚¿ãƒ³ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
                        <p style="margin-top:10px;">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨:</p>
                        <ul style="margin:10px 0;padding-left:20px;">
                            <li>ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ä¸€ç·’ã«æ¢æ¤œ</li>
                            <li>é€²è¡ŒçŠ¶æ³ã®ä¿å­˜</li>
                            <li>å®‡å®™èˆ¹ã®æ‰€æœ‰ã¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</li>
                        </ul>
                    `,
                    target: '#btn-login',
                    position: 'left'
                },
                {
                    id: 'boarding',
                    title: 'ğŸš€ å®‡å®™èˆ¹ã«ä¹—ã‚‹',
                    content: `
                        <p>å®‡å®™èˆ¹ã¯<b style="color:#00ffff;">å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</b>ã§æ­ä¹—ã§ãã¾ã™ã€‚</p>
                        <div style="margin:15px 0;padding:12px;background:rgba(0,255,136,0.15);border:1px solid #00ff88;border-radius:8px;">
                            <p style="margin:0;color:#00ff88;"><b>ğŸŒ æœ€åˆã®å®‡å®™èˆ¹ã‚’å…¥æ‰‹</b></p>
                            <p style="margin:8px 0 0 0;">åœ°çƒè¿‘ãã®<b>ISSå®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</b>ã«ç§»å‹•ã™ã‚‹ã¨<br>æœ€åˆã®å®‡å®™èˆ¹ãŒã‚‚ã‚‰ãˆã¾ã™ï¼</p>
                        </div>
                        <div style="margin-top:15px;padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;">
                            <p style="margin:0;"><b>æ“ç¸¦æ–¹æ³•:</b></p>
                            <p style="margin:5px 0 0 0;">â€¢ <b>W/S</b>ã¾ãŸã¯<b>â†‘/â†“</b> - åŠ é€Ÿ/æ¸›é€Ÿ</p>
                            <p style="margin:5px 0 0 0;">â€¢ ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚° - æ–¹å‘è»¢æ›</p>
                            <p style="margin:5px 0 0 0;">â€¢ <b>è‡ªå‹•èˆªæ³•</b> - ç›®çš„åœ°ã¾ã§è‡ªå‹•é£›è¡Œ</p>
                        </div>
                    `,
                    target: null,
                    position: 'center'
                },
                {
                    id: 'complete',
                    title: 'ğŸ‰ æº–å‚™å®Œäº†ï¼',
                    content: `
                        <p>å®‡å®™æ¢æ¤œã‚’å§‹ã‚ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸï¼</p>
                        <div style="margin-top:15px;display:grid;gap:8px;">
                            <div style="padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;">
                                ğŸ¯ <b>ãƒŸãƒƒã‚·ãƒ§ãƒ³</b>: å¤©ä½“ã‚’è¨ªå•ã™ã‚‹ã¨âœ“ãŒã¤ãã¾ã™
                            </div>
                            <div style="padding:10px;background:rgba(255,149,0,0.1);border-radius:8px;">
                                â›½ <b>ç‡ƒæ–™</b>: ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ç‡ƒæ–™ã‚’è£œçµ¦
                            </div>
                            <div style="padding:10px;background:rgba(168,85,247,0.1);border-radius:8px;">
                                ğŸ‘¥ <b>ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤</b>: ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¢æ¤œï¼
                            </div>
                        </div>
                        <p style="margin-top:15px;color:#00ff88;text-align:center;">æ¥½ã—ã„å®‡å®™æ¢æ¤œã‚’ï¼ ğŸš€</p>
                    `,
                    target: null,
                    position: 'center'
                }
            ];
        } else {
            // English (default)
            return [
                {
                    id: 'welcome',
                    title: 'ğŸŒŒ Welcome to STARÂ·WALKER!',
                    content: `
                        <p>Welcome to the world of space exploration!</p>
                        <p>This guide will walk you through the basic controls and features.</p>
                        <div style="margin-top:15px;padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;">
                            <p style="margin:0;color:#00ffff;">ğŸ’¡ Tip: Press <b>ESC</b> anytime to skip this guide.</p>
                        </div>
                    `,
                    target: null,
                    position: 'center'
                },
                {
                    id: 'nav-panel',
                    title: 'ğŸª Celestial Bodies',
                    content: `
                        <p>View all celestial bodies in our solar system on the left panel.</p>
                        <ul style="margin:10px 0;padding-left:20px;">
                            <li><b>Sun</b> - Center of our solar system</li>
                            <li><b>Planets</b> - Mercury, Venus, Earth, Mars, etc.</li>
                            <li><b>Stations</b> - Refuel and exploration hubs</li>
                        </ul>
                        <p style="color:#00ff88;">Click to move the camera to that body.</p>
                    `,
                    target: '#nav-panel',
                    position: 'right'
                },
                {
                    id: 'top-bar',
                    title: 'ğŸ›ï¸ Top Menu',
                    content: `
                        <div style="display:grid;gap:10px;">
                            <div><b style="color:#00ff88;">â›½ Station</b> - View space station list</div>
                            <div><b style="color:#a855f7;">ğŸ“š Catalog</b> - Check discovered bodies</div>
                            <div><b style="color:#00ffff;">ğŸ–¥ï¸ Fullscreen</b> - Immersive gameplay</div>
                            <div><b style="color:#ff9500;">â±ï¸ 0.1x</b> - Time speed display</div>
                        </div>
                    `,
                    target: '#top-bar',
                    position: 'bottom'
                },
                {
                    id: 'login',
                    title: 'ğŸ‘¤ Login',
                    content: `
                        <p>Click the <b style="color:#00ff88;">Login</b> button in the top right to create an account or sign in.</p>
                        <p style="margin-top:10px;">With login you can:</p>
                        <ul style="margin:10px 0;padding-left:20px;">
                            <li>Explore with other players</li>
                            <li>Save your progress</li>
                            <li>Own and upgrade ships</li>
                        </ul>
                        <p style="margin-top:10px;color:#00ffff;font-size:13px;">ğŸ’¡ Skip this step if already logged in!</p>
                    `,
                    target: '#btn-login',
                    position: 'left'
                },
                {
                    id: 'boarding',
                    title: 'ğŸš€ Board a Ship',
                    content: `
                        <p>Ships can be boarded at <b style="color:#00ffff;">Space Stations</b>.</p>
                        <div style="margin:15px 0;padding:12px;background:rgba(0,255,136,0.15);border:1px solid #00ff88;border-radius:8px;">
                            <p style="margin:0;color:#00ff88;"><b>ğŸŒ Get Your First Ship</b></p>
                            <p style="margin:8px 0 0 0;">Travel to <b>ISS Space Station</b> near Earth<br>to receive your first ship!</p>
                        </div>
                        <div style="margin-top:15px;padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;">
                            <p style="margin:0;"><b>Controls:</b></p>
                            <p style="margin:5px 0 0 0;">â€¢ <b>W/S</b> or <b>â†‘/â†“</b> - Accelerate/Decelerate</p>
                            <p style="margin:5px 0 0 0;">â€¢ Mouse drag - Turn direction</p>
                            <p style="margin:5px 0 0 0;">â€¢ <b>Autopilot</b> - Auto-fly to destination</p>
                        </div>
                    `,
                    target: null,
                    position: 'center'
                },
                {
                    id: 'complete',
                    title: 'ğŸ‰ Ready to Go!',
                    content: `
                        <p>You're all set to begin your space adventure!</p>
                        <div style="margin-top:15px;display:grid;gap:8px;">
                            <div style="padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;">
                                ğŸ¯ <b>Missions</b>: Visit bodies to mark them âœ“
                            </div>
                            <div style="padding:10px;background:rgba(255,149,0,0.1);border-radius:8px;">
                                â›½ <b>Fuel</b>: Refuel at stations
                            </div>
                            <div style="padding:10px;background:rgba(168,85,247,0.1);border-radius:8px;">
                                ğŸ‘¥ <b>Multiplayer</b>: Real-time exploration with others!
                            </div>
                        </div>
                        <p style="margin-top:15px;color:#00ff88;text-align:center;">Enjoy your space journey! ğŸš€</p>
                    `,
                    target: null,
                    position: 'center'
                }
            ];
        }
    },
    
    // ë‹¤êµ­ì–´ ë²„íŠ¼ í…ìŠ¤íŠ¸
    getButtonText() {
        const lang = this.getLang();
        const isKo = lang === 'ko';
        const isJa = lang === 'ja';
        return {
            skip: isKo ? 'ê±´ë„ˆë›°ê¸°' : isJa ? 'ã‚¹ã‚­ãƒƒãƒ—' : 'Skip',
            next: isKo ? 'ë‹¤ìŒ' : isJa ? 'æ¬¡ã¸' : 'Next',
            start: isKo ? 'ì‹œì‘í•˜ê¸°' : isJa ? 'å§‹ã‚ã‚‹' : 'Start'
        };
    },
    
    // ê¸°ëŠ¥ë³„ ê°€ì´ë“œ (ì²« ì‚¬ìš© ì‹œ)
    getFeatureGuides() {
        const lang = this.getLang();
        const isKo = lang === 'ko';
        const isJa = lang === 'ja';
        
        if (isKo) {
            return {
                'station-modal': { title: 'â›½ ìš°ì£¼ ì •ê±°ì¥', content: 'ì—¬ê¸°ì„œ ì—°ë£Œ ì •ê±°ì¥ ëª©ë¡ì„ í™•ì¸í•˜ê³  ë¹ ë¥´ê²Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', shown: false },
                'catalog-modal': { title: 'ğŸ“š ì²œì²´ ë„ê°', content: 'ë°œê²¬í•œ ì²œì²´ë“¤ì˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ì²œì²´ë¥¼ ë°©ë¬¸í•´ë³´ì„¸ìš”!', shown: false },
                'ship-select': { title: 'ğŸš€ ìš°ì£¼ì„  ì„ íƒ', content: 'ë‹¤ì–‘í•œ ìš°ì£¼ì„  ì¤‘ ì›í•˜ëŠ” ê²ƒì„ ì„ íƒí•˜ì„¸ìš”. ê° ìš°ì£¼ì„ ë§ˆë‹¤ íŠ¹ì„±ì´ ë‹¤ë¦…ë‹ˆë‹¤.', shown: false },
                'pilot-mode': { title: 'ğŸ® ì¡°ì¢… ëª¨ë“œ', content: 'W/Së¡œ ê°€ì†/ê°ì†, ë§ˆìš°ìŠ¤ë¡œ ë°©í–¥ ì „í™˜! ìë™í•­ë²•ìœ¼ë¡œ í¸í•˜ê²Œ ì´ë™í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.', shown: false },
                'autopilot': { title: 'ğŸ¤– ìë™í•­ë²•', content: 'ëª©ì ì§€ë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ë¹„í–‰í•©ë‹ˆë‹¤. ë„ì°©í•˜ë©´ ìë™ ì •ì§€!', shown: false }
            };
        } else if (isJa) {
            return {
                'station-modal': { title: 'â›½ å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³', content: 'ã“ã“ã§ç‡ƒæ–™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã€ç´ æ—©ãç§»å‹•ã§ãã¾ã™ã€‚', shown: false },
                'catalog-modal': { title: 'ğŸ“š å¤©ä½“å›³é‘‘', content: 'ç™ºè¦‹ã—ãŸå¤©ä½“ã®æƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™ã€‚ã™ã¹ã¦ã®å¤©ä½“ã‚’è¨ªå•ã—ã¦ã¿ã¦ãã ã•ã„ï¼', shown: false },
                'ship-select': { title: 'ğŸš€ å®‡å®™èˆ¹é¸æŠ', content: 'æ§˜ã€…ãªå®‡å®™èˆ¹ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚ãã‚Œãã‚Œç‰¹æ€§ãŒç•°ãªã‚Šã¾ã™ã€‚', shown: false },
                'pilot-mode': { title: 'ğŸ® æ“ç¸¦ãƒ¢ãƒ¼ãƒ‰', content: 'W/Sã§åŠ é€Ÿ/æ¸›é€Ÿã€ãƒã‚¦ã‚¹ã§æ–¹å‘è»¢æ›ï¼è‡ªå‹•èˆªæ³•ã§æ¥½ã«ç§»å‹•ã‚‚ã§ãã¾ã™ã€‚', shown: false },
                'autopilot': { title: 'ğŸ¤– è‡ªå‹•èˆªæ³•', content: 'ç›®çš„åœ°ã‚’é¸ã¶ã¨è‡ªå‹•ã§é£›è¡Œã—ã¾ã™ã€‚åˆ°ç€ã™ã‚‹ã¨è‡ªå‹•åœæ­¢ï¼', shown: false }
            };
        } else {
            return {
                'station-modal': { title: 'â›½ Space Station', content: 'View fuel station list and quickly travel here.', shown: false },
                'catalog-modal': { title: 'ğŸ“š Celestial Catalog', content: 'Check info on discovered bodies. Visit them all!', shown: false },
                'ship-select': { title: 'ğŸš€ Ship Selection', content: 'Choose from various ships. Each has unique characteristics.', shown: false },
                'pilot-mode': { title: 'ğŸ® Pilot Mode', content: 'W/S to accelerate/decelerate, mouse to turn! Autopilot available too.', shown: false },
                'autopilot': { title: 'ğŸ¤– Autopilot', content: 'Select a destination and fly automatically. Auto-stop on arrival!', shown: false }
            };
        }
    },
    
    featureGuidesShown: {},
    
    // ì €ì¥ëœ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
    loadState() {
        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (saved) {
                const state = JSON.parse(saved);
                this.featureGuidesShown = state.featureGuidesShown || {};
                return state.completed;
            }
        } catch (e) {}
        return false;
    },
    
    // ìƒíƒœ ì €ì¥
    saveState(completed = false) {
        try {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify({
                completed,
                featureGuidesShown: this.featureGuidesShown,
                timestamp: Date.now()
            }));
        } catch (e) {}
    },
    
    // íŠœí† ë¦¬ì–¼ ì‹œì‘ ì²´í¬
    checkAndStart() {
        if (!this.loadState()) {
            this.start();
        }
    },
    
    // íŠœí† ë¦¬ì–¼ ì‹œì‘
    start() {
        this.currentStep = 0;
        document.body.classList.add('tutorial-active');
        this.createOverlay();
        this.showStep(0);
        
        // ESC í‚¤ë¡œ ê±´ë„ˆë›°ê¸°
        document.addEventListener('keydown', this.handleKeydown.bind(this));
    },
    
    handleKeydown(e) {
        if (e.key === 'Escape') {
            this.complete();
        }
    },
    
    // ì˜¤ë²„ë ˆì´ ìƒì„±
    createOverlay() {
        if (this.overlay) return;
        
        this.overlay = document.createElement('div');
        this.overlay.id = 'tutorial-overlay';
        this.overlay.innerHTML = `
            <style>
                #tutorial-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    z-index: 99990;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                /* íŠœí† ë¦¬ì–¼ ì¤‘ UI ìš”ì†Œë“¤ ìœ„ë¡œ ì˜¬ë¦¬ê¸° */
                body.tutorial-active #top-bar,
                body.tutorial-active #nav-container,
                body.tutorial-active #btn-login,
                body.tutorial-active .login-status {
                    position: relative;
                    z-index: 99995 !important;
                }
                #tutorial-box {
                    background: linear-gradient(135deg, rgba(10, 15, 25, 0.98) 0%, rgba(15, 20, 35, 0.95) 100%);
                    border: 2px solid #00ffff;
                    border-radius: 0;
                    clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
                    padding: 30px;
                    max-width: 450px;
                    width: 90%;
                    color: #fff;
                    font-family: 'Rajdhani', sans-serif;
                    box-shadow: 0 0 50px rgba(0, 255, 255, 0.3), inset 0 0 30px rgba(0, 255, 255, 0.05);
                    position: relative;
                    z-index: 100001;
                }
                #tutorial-box::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 3px;
                    background: linear-gradient(90deg, transparent, #00ffff, transparent);
                }
                #tutorial-step {
                    position: absolute;
                    top: 10px;
                    right: 15px;
                    font-family: 'Orbitron', sans-serif;
                    font-size: 11px;
                    color: #00ffff;
                    opacity: 0.7;
                }
                #tutorial-title {
                    font-family: 'Orbitron', sans-serif;
                    font-size: 20px;
                    font-weight: 700;
                    color: #00ffff;
                    margin-bottom: 20px;
                    text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
                }
                #tutorial-content {
                    font-size: 15px;
                    line-height: 1.7;
                    color: #c8d6e5;
                }
                #tutorial-content p { margin: 10px 0; }
                #tutorial-content ul { margin: 10px 0; }
                #tutorial-content li { margin: 5px 0; }
                #tutorial-content b { color: #fff; }
                #tutorial-buttons {
                    display: flex;
                    justify-content: space-between;
                    margin-top: 25px;
                    gap: 15px;
                }
                .tutorial-btn {
                    flex: 1;
                    padding: 12px 20px;
                    border: 1px solid;
                    background: transparent;
                    font-family: 'Orbitron', sans-serif;
                    font-size: 12px;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);
                }
                .tutorial-btn.skip {
                    border-color: #6b7c93;
                    color: #6b7c93;
                }
                .tutorial-btn.skip:hover {
                    background: rgba(107, 124, 147, 0.2);
                    color: #fff;
                }
                .tutorial-btn.next {
                    border-color: #00ffff;
                    color: #00ffff;
                    background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(0, 255, 255, 0.02) 100%);
                }
                .tutorial-btn.next:hover {
                    background: linear-gradient(135deg, rgba(0, 255, 255, 0.3) 0%, rgba(0, 255, 255, 0.1) 100%);
                    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
                }
                .tutorial-btn.complete {
                    border-color: #00ff88;
                    color: #00ff88;
                    background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.02) 100%);
                }
                .tutorial-btn.complete:hover {
                    background: linear-gradient(135deg, rgba(0, 255, 136, 0.3) 0%, rgba(0, 255, 136, 0.1) 100%);
                    box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
                }
                #tutorial-highlight {
                    position: fixed;
                    border: 3px solid #00ffff;
                    border-radius: 8px;
                    box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
                    pointer-events: none;
                    z-index: 99999;
                    animation: tutorialPulse 2s infinite;
                    display: none;
                }
                @keyframes tutorialPulse {
                    0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
                    50% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.8); }
                }
                #tutorial-progress {
                    display: flex;
                    justify-content: center;
                    gap: 8px;
                    margin-top: 20px;
                }
                .progress-dot {
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    background: rgba(0, 255, 255, 0.2);
                    border: 1px solid rgba(0, 255, 255, 0.5);
                    transition: all 0.3s ease;
                }
                .progress-dot.active {
                    background: #00ffff;
                    box-shadow: 0 0 10px #00ffff;
                }
                .progress-dot.completed {
                    background: #00ff88;
                    border-color: #00ff88;
                }
            </style>
            <div id="tutorial-highlight"></div>
            <div id="tutorial-box">
                <div id="tutorial-step"></div>
                <div id="tutorial-title"></div>
                <div id="tutorial-content"></div>
                <div id="tutorial-buttons">
                    <button class="tutorial-btn skip" id="tutorial-skip-btn">${this.getButtonText().skip}</button>
                    <button class="tutorial-btn next" id="tutorial-next-btn">${this.getButtonText().next}</button>
                </div>
                <div id="tutorial-progress"></div>
            </div>
        `;
        document.body.appendChild(this.overlay);
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('tutorial-skip-btn').onclick = () => this.complete();
        document.getElementById('tutorial-next-btn').onclick = () => this.nextStep();
    },
    
    // ë‹¨ê³„ í‘œì‹œ
    showStep(index) {
        const steps = this.getSteps();
        if (index >= steps.length) {
            this.complete();
            return;
        }
        
        const step = steps[index];
        this.currentStep = index;
        
        // â˜… ì´ì „ í•˜ì´ë¼ì´íŠ¸ ëŒ€ìƒ ìŠ¤íƒ€ì¼ ë³µì›
        if (this.highlightedElement) {
            this.highlightedElement.style.position = this.savedPosition || '';
            this.highlightedElement.style.zIndex = this.savedZIndex || '';
            this.highlightedElement = null;
        }
        
        document.getElementById('tutorial-step').textContent = `${index + 1} / ${steps.length}`;
        document.getElementById('tutorial-title').textContent = step.title;
        document.getElementById('tutorial-content').innerHTML = step.content;
        
        // ë²„íŠ¼ ì—…ë°ì´íŠ¸
        const nextBtn = document.getElementById('tutorial-next-btn');
        const btnText = this.getButtonText();
        if (index === steps.length - 1) {
            nextBtn.textContent = btnText.start;
            nextBtn.className = 'tutorial-btn complete';
            nextBtn.onclick = () => this.complete();
        } else {
            nextBtn.textContent = btnText.next;
            nextBtn.className = 'tutorial-btn next';
            nextBtn.onclick = () => this.nextStep();
        }
        
        // ì§„í–‰ í‘œì‹œ ì—…ë°ì´íŠ¸
        let progressHtml = '';
        for (let i = 0; i < steps.length; i++) {
            const cls = i < index ? 'completed' : (i === index ? 'active' : '');
            progressHtml += `<div class="progress-dot ${cls}"></div>`;
        }
        document.getElementById('tutorial-progress').innerHTML = progressHtml;
        
        // í•˜ì´ë¼ì´íŠ¸
        const highlight = document.getElementById('tutorial-highlight');
        if (step.target) {
            const target = document.querySelector(step.target);
            if (target) {
                const rect = target.getBoundingClientRect();
                highlight.style.display = 'block';
                highlight.style.left = (rect.left - 5) + 'px';
                highlight.style.top = (rect.top - 5) + 'px';
                highlight.style.width = (rect.width + 10) + 'px';
                highlight.style.height = (rect.height + 10) + 'px';
                
                // â˜… í•˜ì´ë¼ì´íŠ¸ ëŒ€ìƒì„ ì˜¤ë²„ë ˆì´ ìœ„ë¡œ ì˜¬ë¦¬ê¸°
                this.savedPosition = target.style.position;
                this.savedZIndex = target.style.zIndex;
                target.style.position = 'relative';
                target.style.zIndex = '100001';
                this.highlightedElement = target;
            }
        } else {
            highlight.style.display = 'none';
        }
    },
    
    // ë‹¤ìŒ ë‹¨ê³„
    nextStep() {
        this.showStep(this.currentStep + 1);
    },
    
    // ì™„ë£Œ
    complete() {
        this.saveState(true);
        document.removeEventListener('keydown', this.handleKeydown);
        document.body.classList.remove('tutorial-active');  // â˜… UI ìŠ¤íƒ€ì¼ ë³µì›
        
        // â˜… í•˜ì´ë¼ì´íŠ¸ ëŒ€ìƒ ìŠ¤íƒ€ì¼ ë³µì›
        if (this.highlightedElement) {
            this.highlightedElement.style.position = this.savedPosition || '';
            this.highlightedElement.style.zIndex = this.savedZIndex || '';
            this.highlightedElement = null;
        }
        
        if (this.overlay) {
            this.overlay.style.opacity = '0';
            this.overlay.style.transition = 'opacity 0.3s';
            setTimeout(() => {
                this.overlay.remove();
                this.overlay = null;
            }, 300);
        }
    },
    
    // ê¸°ëŠ¥ ê°€ì´ë“œ í‘œì‹œ (ì²« ì‚¬ìš© ì‹œ)
    showFeatureGuide(featureId) {
        // ì´ë¯¸ í‘œì‹œí•œ ê°€ì´ë“œì¸ì§€ í™•ì¸
        if (this.featureGuidesShown[featureId]) return;
        
        const guides = this.getFeatureGuides();
        const guide = guides[featureId];
        if (!guide) return;
        
        this.featureGuidesShown[featureId] = true;
        this.saveState();
        
        const lang = this.getLang();
        const isKo = lang === 'ko';
        const isJa = lang === 'ja';
        const okText = isKo ? 'í™•ì¸' : isJa ? 'OK' : 'OK';
        
        // ì‘ì€ íŒì—… í‘œì‹œ
        const popup = document.createElement('div');
        popup.className = 'feature-guide-popup';
        popup.innerHTML = `
            <style>
                .feature-guide-popup {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, rgba(10, 15, 25, 0.98) 0%, rgba(15, 20, 35, 0.95) 100%);
                    border: 2px solid #00ffff;
                    padding: 25px 30px;
                    z-index: 100001;
                    font-family: 'Rajdhani', sans-serif;
                    max-width: 350px;
                    clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
                    box-shadow: 0 0 40px rgba(0, 255, 255, 0.4);
                    animation: featurePopIn 0.3s ease;
                }
                @keyframes featurePopIn {
                    from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                    to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
                .feature-guide-popup h3 {
                    font-family: 'Orbitron', sans-serif;
                    color: #00ffff;
                    margin: 0 0 15px 0;
                    font-size: 16px;
                }
                .feature-guide-popup p {
                    color: #c8d6e5;
                    margin: 0;
                    line-height: 1.6;
                }
                .feature-guide-popup button {
                    margin-top: 15px;
                    width: 100%;
                    padding: 10px;
                    background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(0, 255, 255, 0.05) 100%);
                    border: 1px solid #00ffff;
                    color: #00ffff;
                    font-family: 'Orbitron', sans-serif;
                    font-size: 11px;
                    cursor: pointer;
                    transition: all 0.3s;
                }
                .feature-guide-popup button:hover {
                    background: rgba(0, 255, 255, 0.3);
                }
            </style>
            <h3>${guide.title}</h3>
            <p>${guide.content}</p>
            <button onclick="this.parentElement.remove()">${okText}</button>
        `;
        document.body.appendChild(popup);
        
        // 5ì´ˆ í›„ ìë™ ë‹«ê¸°
        setTimeout(() => {
            if (popup.parentElement) {
                popup.style.opacity = '0';
                popup.style.transition = 'opacity 0.3s';
                setTimeout(() => popup.remove(), 300);
            }
        }, 5000);
    },
    
    // íŠœí† ë¦¬ì–¼ ë¦¬ì…‹ (ë””ë²„ê·¸ìš©)
    reset() {
        localStorage.removeItem(this.STORAGE_KEY);
        console.log('Tutorial reset');
    }
};

// ì „ì—­ ë…¸ì¶œ
window.MultiTutorial = MultiTutorial;
</script>

<!-- Service Worker ë“±ë¡ (PWA) -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('âœ… Service Worker ë“±ë¡ ì„±ê³µ:', reg.scope))
      .catch(err => console.log('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:', err));
  });
}

// PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  console.log('ğŸ“± PWA ì„¤ì¹˜ ê°€ëŠ¥');
});
</script>

</body>
</html>
