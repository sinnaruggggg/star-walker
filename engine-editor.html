<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ ì—”ì§„ ë¶ˆê½ƒ ìœ„ì¹˜ ì—ë””í„° v3</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
        }
        
        #container { display: flex; height: 100vh; }
        
        #viewer {
            flex: 1;
            position: relative;
            background: #0a0a15;
        }
        
        #sidebar {
            width: 350px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(0,255,255,0.2);
        }
        
        h1 {
            font-size: 1.2em;
            color: #00ffff;
            margin-bottom: 15px;
        }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .section h3 {
            font-size: 0.85em;
            color: #88ccff;
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            font-size: 0.8em;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        input[type="file"] { display: none; }
        
        .file-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #0066ff, #00aaff);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .file-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,150,255,0.4);
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        
        .btn-thrust { background: linear-gradient(135deg, #0066ff, #00aaff); color: #fff; }
        .btn-reverse { background: linear-gradient(135deg, #ff6600, #ffaa00); color: #000; }
        .btn-clear { background: linear-gradient(135deg, #ff4444, #ff6666); color: #fff; }
        .btn-copy { background: linear-gradient(135deg, #00cc66, #00ff88); color: #000; width: 100%; margin-top: 10px; }
        
        .btn:hover { transform: scale(1.05); }
        .btn.active { box-shadow: 0 0 15px currentColor; transform: scale(1.1); }
        
        .engine-list { max-height: 180px; overflow-y: auto; }
        
        .engine-item {
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .engine-item:hover { background: rgba(0,0,0,0.5); }
        .engine-item.selected { border-color: #00ff00; background: rgba(0,255,0,0.1); }
        .engine-item.thrust { border-left: 3px solid #00aaff; }
        .engine-item.reverse { border-left: 3px solid #ffaa00; }
        
        .engine-item .header { display: flex; justify-content: space-between; align-items: center; }
        .engine-item .type-badge { font-size: 0.7em; font-weight: bold; }
        .engine-item .type-badge.thrust { color: #00aaff; }
        .engine-item .type-badge.reverse { color: #ffaa00; }
        .engine-item .delete-btn { background: #ff4444; color: #fff; border: none; border-radius: 3px; padding: 2px 6px; font-size: 0.7em; cursor: pointer; }
        .engine-item .coords { font-size: 0.65em; color: #888; margin-top: 4px; }
        .engine-item .direction { font-size: 0.65em; color: #aaa; }
        
        .mode-toggle { display: flex; gap: 5px; flex-wrap: wrap; }
        .mode-btn {
            flex: 1;
            min-width: 45px;
            padding: 6px 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            color: #888;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn:hover { background: rgba(255,255,255,0.2); }
        .mode-btn.active { background: #0066ff; color: #fff; border-color: #0088ff; }
        
        .slider-group { margin-bottom: 10px; }
        .slider-group input[type="range"] { width: 100%; }
        .slider-value { float: right; color: #00ffff; }
        
        .direction-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .dir-btn {
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            color: #aaa;
            font-size: 0.7em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dir-btn:hover { background: rgba(255,255,255,0.2); }
        .dir-btn.selected { background: #00aa00; color: #fff; border-color: #00ff00; }
        
        #output {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.65em;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            color: #aaffaa;
        }
        
        #instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.75em;
            color: #aaa;
            max-width: 280px;
        }
        #instructions strong { color: #00ffff; }
        .thrust-color { color: #00aaff; }
        .reverse-color { color: #ffaa00; }
        
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            font-size: 30px;
            text-shadow: 0 0 10px currentColor;
            display: none;
        }
        
        .flame-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }
        
        .flame-preview input[type="color"] {
            width: 35px;
            height: 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #model-info { font-size: 0.7em; color: #888; margin-top: 8px; }
        .help-tip { font-size: 0.7em; color: #666; margin-top: 5px; }
        .add-mode-group { display: flex; gap: 8px; margin-bottom: 10px; }
        
        .selected-engine {
            background: rgba(0,255,0,0.1);
            border: 1px solid #00ff00;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }
        .selected-engine h4 { font-size: 0.8em; color: #00ff00; margin-bottom: 8px; }
        
        /* â˜…â˜…â˜… ëª¨ë¸ ì „ë°© ë°©í–¥ ìŠ¤íƒ€ì¼ â˜…â˜…â˜… */
        .model-forward-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .forward-btn {
            padding: 8px 12px;
            border: 1px solid rgba(0,255,255,0.3);
            border-radius: 6px;
            background: rgba(0,100,150,0.3);
            color: #88ccff;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        
        .forward-btn:hover {
            background: rgba(0,150,200,0.4);
            border-color: rgba(0,255,255,0.5);
        }
        
        .forward-btn.active {
            background: linear-gradient(135deg, #0066ff, #00aaff);
            color: #fff;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0,255,255,0.4);
        }
        
        #forward-info {
            background: rgba(0,50,100,0.3);
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
        }
        
        .forward-arrow-display {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .arrow-label { color: #888; font-size: 0.75em; }
        
        #forward-direction-text {
            color: #00ffff;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .rotation-display {
            font-size: 0.75em;
            color: #888;
        }
        
        .rotation-display strong {
            color: #ffaa00;
        }
        
        /* ì§„í–‰ ë°©í–¥ í™”ì‚´í‘œ (3D ë·°ì–´ ë‚´) */
        #direction-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(0,255,255,0.3);
            font-size: 0.8em;
        }
        
        #direction-indicator .arrow {
            color: #00aaff;
            font-size: 1.5em;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="viewer">
            <div id="crosshair">+</div>
            <div id="instructions">
                <strong>ğŸ–±ï¸ ì¡°ì‘ë²•</strong><br>
                â€¢ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸: íšŒì „<br>
                â€¢ ìŠ¤í¬ë¡¤: ì¤Œ<br>
                â€¢ <span class="thrust-color">ğŸ”µ ì¶”ì§„</span> í´ë¦­ â†’ ëª¨ë¸ í´ë¦­: ë©”ì¸ ì—”ì§„<br>
                â€¢ <span class="reverse-color">ğŸŸ  ì—­ì¶”ì§„</span> í´ë¦­ â†’ ëª¨ë¸ í´ë¦­: ì—­ì¶”ì§„<br>
                â€¢ ì—”ì§„ ì„ íƒ í›„ ë°©í–¥ ë²„íŠ¼ìœ¼ë¡œ ì¡°ì •
            </div>
            <div id="direction-indicator">
                <span class="arrow">â†’</span>
                <span>íŒŒë€ í™”ì‚´í‘œ = ì§„í–‰ ë°©í–¥</span>
            </div>
        </div>
        
        <div id="sidebar">
            <h1>ğŸ”¥ ì—”ì§„ ì—ë””í„° v3</h1>
            
            <div class="section">
                <h3>ğŸ“‚ ëª¨ë¸ ë¡œë“œ</h3>
                <label for="glb-file" class="file-btn">ğŸ’¾ ë¡œì»¬ íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="glb-file" accept=".glb,.gltf">
                <div style="margin: 10px 0; text-align: center; color: #666;">ë˜ëŠ”</div>
                <button class="file-btn" id="load-storage-btn" style="background: linear-gradient(135deg, #00aa66, #00dd88);">â˜ï¸ Supabase Storageì—ì„œ ë¡œë“œ</button>
                <select id="storage-models" style="display:none; width:100%; margin-top:10px; padding:10px; background:#1a1a2e; color:#fff; border:1px solid #00ffff; border-radius:8px;">
                    <option value="">-- ëª¨ë¸ ì„ íƒ --</option>
                </select>
                <div id="model-info"></div>
            </div>
            
            <!-- â˜…â˜…â˜… ëª¨ë¸ ë°©í–¥ íšŒì „ ì„¹ì…˜ â˜…â˜…â˜… -->
            <div class="section">
                <h3>ğŸ§­ ëª¨ë¸ ì „ë°© ë°©í–¥ (ì¤‘ìš”!)</h3>
                <p class="help-tip">ğŸ’¡ GLB ëª¨ë¸ì´ ì•ìœ¼ë¡œ ë‚ ì•„ê°ˆ ë°©í–¥ ì„ íƒ</p>
                <div class="model-forward-group">
                    <button class="forward-btn" data-forward="+Z">+Z</button>
                    <button class="forward-btn active" data-forward="-Z">-Z (ê¸°ë³¸)</button>
                    <button class="forward-btn" data-forward="+X">+X</button>
                    <button class="forward-btn" data-forward="-X">-X</button>
                </div>
                <div id="forward-info">
                    <div class="forward-arrow-display">
                        <span class="arrow-label">ì„ íƒëœ ì „ë°©:</span>
                        <span id="forward-direction-text">-Z</span>
                    </div>
                    <div class="rotation-display">
                        <span>ëª¨ë¸ Yì¶• íšŒì „:</span>
                        <strong id="model-rotation-value">180Â°</strong>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3>ğŸ‘ï¸ ë·° ëª¨ë“œ</h3>
                <div class="mode-toggle">
                    <button class="mode-btn active" data-view="perspective">3D</button>
                    <button class="mode-btn" data-view="top">ìœ„</button>
                    <button class="mode-btn" data-view="front">ì•</button>
                    <button class="mode-btn" data-view="side">ì˜†</button>
                    <button class="mode-btn" data-view="back">ë’¤</button>
                </div>
            </div>
            
            <div class="section">
                <h3>ğŸ”¥ ì—”ì§„ ì¶”ê°€</h3>
                <div class="add-mode-group">
                    <button class="btn btn-thrust" id="add-thrust-btn">ğŸ”µ ì¶”ì§„</button>
                    <button class="btn btn-reverse" id="add-reverse-btn">ğŸŸ  ì—­ì¶”ì§„</button>
                    <button class="btn btn-clear" id="clear-btn">ğŸ—‘ï¸</button>
                </div>
                <p class="help-tip">ğŸ’¡ ë²„íŠ¼ í´ë¦­ í›„ ëª¨ë¸ì—ì„œ ìœ„ì¹˜ í´ë¦­</p>
                
                <div class="engine-list" id="engine-list"></div>
                
                <div class="selected-engine" id="selected-engine" style="display:none;">
                    <h4>ğŸ¯ ì„ íƒëœ ì—”ì§„ ë°©í–¥</h4>
                    <div class="direction-controls">
                        <button class="dir-btn" data-dir="-x">â† X</button>
                        <button class="dir-btn" data-dir="+y">â†‘ Y</button>
                        <button class="dir-btn" data-dir="+x">X â†’</button>
                        <button class="dir-btn" data-dir="-z">ì• -Z</button>
                        <button class="dir-btn" data-dir="center">â—</button>
                        <button class="dir-btn selected" data-dir="+z">ë’¤ +Z</button>
                        <button class="dir-btn" data-dir=""></button>
                        <button class="dir-btn" data-dir="-y">â†“ Y</button>
                        <button class="dir-btn" data-dir=""></button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3>âš™ï¸ ë¶ˆê½ƒ ì„¤ì •</h3>
                <div class="slider-group">
                    <label>ë¶ˆê½ƒ í¬ê¸° <span class="slider-value" id="size-value">1.0</span></label>
                    <input type="range" id="flame-size" min="0.1" max="3" step="0.1" value="1">
                </div>
                <div class="slider-group">
                    <label>ë¶ˆê½ƒ ê¸¸ì´ <span class="slider-value" id="length-value">1.0</span></label>
                    <input type="range" id="flame-length" min="0.5" max="5" step="0.1" value="1">
                </div>
                <div class="flame-preview">
                    <label>ì¶”ì§„</label>
                    <input type="color" id="thrust-color" value="#00aaff">
                    <label>ì—­ì¶”ì§„</label>
                    <input type="color" id="reverse-color" value="#ffaa00">
                </div>
            </div>
            
            <div class="section">
                <h3>ğŸ“‹ ì¶œë ¥ (engineConfig)</h3>
                <div id="output">// GLB íŒŒì¼ì„ ë¡œë“œí•˜ì„¸ìš”</div>
                <button class="btn btn-copy" id="copy-btn">ğŸ“‹ JSON ë³µì‚¬</button>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // â˜…â˜…â˜… Supabase ì„¤ì • â˜…â˜…â˜…
        const SUPABASE_URL = 'https://sfirzuqngdbpwvdoyero.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaXJ6dXFuZ2RicHd2ZG95ZXJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MDk3NjgsImV4cCI6MjA2NTM4NTc2OH0.0WzBJGDvNjiDp9k-R5Lz6lOGxXP-9CwXtDuCQRHreLU';
        const SUPABASE_STORAGE = SUPABASE_URL + '/storage/v1/object/public/assets/';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let scene, camera, renderer, controls;
        let currentModel = null;
        let engines = [];
        let addMode = null;
        let selectedEngineIndex = -1;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let gltfLoader = new GLTFLoader();
        
        // â˜…â˜…â˜… ì§„í–‰ ë°©í–¥ í™”ì‚´í‘œ â˜…â˜…â˜…
        let forwardArrow = null;
        let modelForward = '-Z';  // ê¸°ë³¸ê°’
        let modelRotationY = Math.PI;  // ê¸°ë³¸ 180ë„
        
        let settings = {
            size: 1.0,
            length: 1.0,
            thrustColor: '#00aaff',
            reverseColor: '#ffaa00'
        };
        
        init();
        animate();
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a15);
            
            camera = new THREE.PerspectiveCamera(60, 1, 0.01, 1000);
            camera.position.set(3, 2, 3);
            
            const viewer = document.getElementById('viewer');
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            viewer.appendChild(renderer.domElement);
            
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(5, 10, 5);
            scene.add(dirLight);
            
            scene.add(new THREE.GridHelper(10, 20, 0x444444, 0x222222));
            scene.add(new THREE.AxesHelper(2));
            
            // â˜…â˜…â˜… ì§„í–‰ ë°©í–¥ í™”ì‚´í‘œ ìƒì„± â˜…â˜…â˜…
            createForwardArrow();
            
            function resize() {
                const rect = viewer.getBoundingClientRect();
                camera.aspect = rect.width / rect.height;
                camera.updateProjectionMatrix();
                renderer.setSize(rect.width, rect.height);
            }
            resize();
            window.addEventListener('resize', resize);
            
            setupEvents();
        }
        
        // â˜…â˜…â˜… ì§„í–‰ ë°©í–¥ í™”ì‚´í‘œ ìƒì„± â˜…â˜…â˜…
        function createForwardArrow() {
            if (forwardArrow) scene.remove(forwardArrow);
            
            // íŒŒë€ìƒ‰ í° í™”ì‚´í‘œ (ì§„í–‰ ë°©í–¥)
            const dir = getForwardVector();
            forwardArrow = new THREE.ArrowHelper(
                dir,
                new THREE.Vector3(0, 0, 0),
                2.5,  // ê¸¸ì´
                0x00aaff,  // íŒŒë€ìƒ‰
                0.4,  // ë¨¸ë¦¬ ê¸¸ì´
                0.2   // ë¨¸ë¦¬ í­
            );
            scene.add(forwardArrow);
        }
        
        // â˜…â˜…â˜… ì „ë°© ë°©í–¥ ë²¡í„° ë°˜í™˜ â˜…â˜…â˜…
        function getForwardVector() {
            switch(modelForward) {
                case '+Z': return new THREE.Vector3(0, 0, 1);
                case '-Z': return new THREE.Vector3(0, 0, -1);
                case '+X': return new THREE.Vector3(1, 0, 0);
                case '-X': return new THREE.Vector3(-1, 0, 0);
                default: return new THREE.Vector3(0, 0, -1);
            }
        }
        
        // â˜…â˜…â˜… ëª¨ë¸ íšŒì „ê°’ ê³„ì‚° â˜…â˜…â˜…
        function calculateModelRotation() {
            // ê²Œì„ì—ì„œ ê¸°ë³¸ ì „ë°©ì€ -Z
            // ëª¨ë¸ì˜ ì „ë°©ì´ ë‹¤ë¥´ë©´ Yì¶•ìœ¼ë¡œ íšŒì „í•´ì•¼ í•¨
            switch(modelForward) {
                case '+Z': modelRotationY = 0; break;           // +Z â†’ 0ë„
                case '-Z': modelRotationY = Math.PI; break;     // -Z â†’ 180ë„
                case '+X': modelRotationY = -Math.PI / 2; break; // +X â†’ -90ë„
                case '-X': modelRotationY = Math.PI / 2; break;  // -X â†’ 90ë„
                default: modelRotationY = Math.PI;
            }
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('model-rotation-value').textContent = 
                Math.round(modelRotationY * 180 / Math.PI) + 'Â°';
            document.getElementById('forward-direction-text').textContent = modelForward;
            
            // ëª¨ë¸ì— íšŒì „ ì ìš©
            if (currentModel) {
                currentModel.rotation.y = modelRotationY;
                currentModel.updateMatrixWorld(true);  // â˜… í–‰ë ¬ ì—…ë°ì´íŠ¸
            }

            // í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
            createForwardArrow();
            
            // JSON ì¶œë ¥ ì—…ë°ì´íŠ¸
            updateOutput();
        }
        
        // â˜…â˜…â˜… Supabase Storageì—ì„œ GLB íŒŒì¼ ëª©ë¡ ë¡œë“œ â˜…â˜…â˜…
        async function loadStorageModels() {
            const select = document.getElementById('storage-models');
            select.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';
            select.style.display = 'block';

            try {
                // ships í´ë”ì—ì„œ GLB íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const { data, error } = await supabase.storage
                    .from('assets')
                    .list('ships', { limit: 100 });

                if (error) throw error;

                const glbFiles = data.filter(f => f.name.endsWith('.glb'));

                if (glbFiles.length === 0) {
                    select.innerHTML = '<option value="">GLB íŒŒì¼ ì—†ìŒ</option>';
                    return;
                }

                select.innerHTML = '<option value="">-- ëª¨ë¸ ì„ íƒ (' + glbFiles.length + 'ê°œ) --</option>';
                glbFiles.forEach(file => {
                    const option = document.createElement('option');
                    option.value = SUPABASE_STORAGE + 'ships/' + file.name;
                    option.textContent = file.name;
                    select.appendChild(option);
                });

            } catch (err) {
                console.error('Storage ë¡œë“œ ì‹¤íŒ¨:', err);
                select.innerHTML = '<option value="">ë¡œë“œ ì‹¤íŒ¨: ' + err.message + '</option>';
            }
        }

        // â˜…â˜…â˜… URLì—ì„œ ëª¨ë¸ ë¡œë“œ â˜…â˜…â˜…
        function loadModelFromUrl(url, filename) {
            document.getElementById('model-info').innerHTML = 'â³ ë¡œë”© ì¤‘...';

            gltfLoader.load(url, (gltf) => {
                if (currentModel) scene.remove(currentModel);
                clearEngines();

                currentModel = gltf.scene;
                currentModel.rotation.y = modelRotationY;
                scene.add(currentModel);

                const box = new THREE.Box3().setFromObject(currentModel);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());

                currentModel.position.sub(center);
                currentModel.updateMatrixWorld(true);  // â˜… í–‰ë ¬ ì—…ë°ì´íŠ¸ (í´ë¦­ ì¢Œí‘œ ë³€í™˜ìš©)

                camera.position.set(size.x * 2, size.y * 1.5, size.z * 2);
                controls.target.set(0, 0, 0);

                document.getElementById('model-info').innerHTML =
                    `âœ… ${filename}<br>ğŸ“ ${size.x.toFixed(2)} x ${size.y.toFixed(2)} x ${size.z.toFixed(2)}`;

                updateOutput();
            }, undefined, (err) => {
                document.getElementById('model-info').innerHTML = 'âŒ ë¡œë“œ ì‹¤íŒ¨: ' + err.message;
                console.error('GLB ë¡œë“œ ì—ëŸ¬:', err);
            });
        }

        function setupEvents() {
            document.getElementById('glb-file').addEventListener('change', (e) => {
                if (e.target.files[0]) loadModel(e.target.files[0]);
            });

            // â˜…â˜…â˜… Supabase Storage ë²„íŠ¼ â˜…â˜…â˜…
            document.getElementById('load-storage-btn').addEventListener('click', loadStorageModels);

            // â˜…â˜…â˜… Storage ëª¨ë¸ ì„ íƒ â˜…â˜…â˜…
            document.getElementById('storage-models').addEventListener('change', (e) => {
                if (e.target.value) {
                    const filename = e.target.value.split('/').pop();
                    loadModelFromUrl(e.target.value, filename);
                }
            });

            // â˜…â˜…â˜… ì „ë°© ë°©í–¥ ë²„íŠ¼ ì´ë²¤íŠ¸ â˜…â˜…â˜…
            document.querySelectorAll('.forward-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.forward-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    modelForward = btn.dataset.forward;
                    calculateModelRotation();
                });
            });
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    setView(btn.dataset.view);
                });
            });
            
            const thrustBtn = document.getElementById('add-thrust-btn');
            const reverseBtn = document.getElementById('add-reverse-btn');
            const crosshair = document.getElementById('crosshair');
            
            thrustBtn.addEventListener('click', () => {
                addMode = addMode === 'thrust' ? null : 'thrust';
                thrustBtn.classList.toggle('active', addMode === 'thrust');
                reverseBtn.classList.remove('active');
                updateCursor();
            });
            
            reverseBtn.addEventListener('click', () => {
                addMode = addMode === 'reverse' ? null : 'reverse';
                reverseBtn.classList.toggle('active', addMode === 'reverse');
                thrustBtn.classList.remove('active');
                updateCursor();
            });
            
            function updateCursor() {
                crosshair.style.display = addMode ? 'block' : 'none';
                crosshair.style.color = addMode === 'thrust' ? '#00aaff' : '#ffaa00';
                renderer.domElement.style.cursor = addMode ? 'crosshair' : 'grab';
            }
            
            document.getElementById('clear-btn').addEventListener('click', () => {
                if (engines.length && confirm('ëª¨ë“  ì—”ì§„ ì‚­ì œ?')) clearEngines();
            });
            
            renderer.domElement.addEventListener('click', (e) => {
                if (!addMode || !currentModel) return;
                
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObject(currentModel, true);
                
                if (intersects.length > 0) {
                    // â˜…â˜…â˜… ëª¨ë¸ ë¡œì»¬ ì¢Œí‘œë¡œ ë³€í™˜ â˜…â˜…â˜…
                    const localPoint = currentModel.worldToLocal(intersects[0].point.clone());
                    addEngine(localPoint, addMode);
                }
            });
            
            document.querySelectorAll('.dir-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (selectedEngineIndex < 0 || !btn.dataset.dir) return;
                    
                    document.querySelectorAll('.dir-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    const dir = btn.dataset.dir;
                    const engine = engines[selectedEngineIndex];
                    
                    switch(dir) {
                        case '+x': engine.direction = {x:1,y:0,z:0}; break;
                        case '-x': engine.direction = {x:-1,y:0,z:0}; break;
                        case '+y': engine.direction = {x:0,y:1,z:0}; break;
                        case '-y': engine.direction = {x:0,y:-1,z:0}; break;
                        case '+z': engine.direction = {x:0,y:0,z:1}; break;
                        case '-z': engine.direction = {x:0,y:0,z:-1}; break;
                    }
                    
                    updateFlame(selectedEngineIndex);
                    updateOutput();
                });
            });
            
            document.getElementById('flame-size').addEventListener('input', (e) => {
                settings.size = parseFloat(e.target.value);
                document.getElementById('size-value').textContent = settings.size.toFixed(1);
                engines.forEach((_, i) => updateFlame(i));
                updateOutput();
            });
            
            document.getElementById('flame-length').addEventListener('input', (e) => {
                settings.length = parseFloat(e.target.value);
                document.getElementById('length-value').textContent = settings.length.toFixed(1);
                engines.forEach((_, i) => updateFlame(i));
                updateOutput();
            });
            
            document.getElementById('thrust-color').addEventListener('input', (e) => {
                settings.thrustColor = e.target.value;
                engines.forEach((_, i) => updateFlame(i));
                updateOutput();
            });
            
            document.getElementById('reverse-color').addEventListener('input', (e) => {
                settings.reverseColor = e.target.value;
                engines.forEach((_, i) => updateFlame(i));
                updateOutput();
            });
            
            document.getElementById('copy-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('output').textContent).then(() => {
                    const btn = document.getElementById('copy-btn');
                    btn.textContent = 'âœ“ ë³µì‚¬ë¨!';
                    setTimeout(() => btn.textContent = 'ğŸ“‹ JSON ë³µì‚¬', 2000);
                });
            });
        }
        
        function loadModel(file) {
            new GLTFLoader().load(URL.createObjectURL(file), (gltf) => {
                if (currentModel) scene.remove(currentModel);
                clearEngines();
                
                currentModel = gltf.scene;
                
                // â˜…â˜…â˜… í˜„ì¬ ì„¤ì •ëœ ì „ë°© ë°©í–¥ì— ë§ê²Œ íšŒì „ ì ìš© â˜…â˜…â˜…
                currentModel.rotation.y = modelRotationY;
                
                scene.add(currentModel);
                
                const box = new THREE.Box3().setFromObject(currentModel);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                // ì¤‘ì‹¬ì  ì¡°ì • (íšŒì „ í›„)
                currentModel.position.sub(center);
                currentModel.updateMatrixWorld(true);  // â˜… í–‰ë ¬ ì—…ë°ì´íŠ¸ (í´ë¦­ ì¢Œí‘œ ë³€í™˜ìš©)

                camera.position.set(size.x * 2, size.y * 1.5, size.z * 2);
                controls.target.set(0, 0, 0);

                document.getElementById('model-info').innerHTML =
                    `âœ… ${file.name}<br>ğŸ“ ${size.x.toFixed(2)} x ${size.y.toFixed(2)} x ${size.z.toFixed(2)}`;
                
                updateOutput();
            });
        }
        
        function setView(view) {
            const d = 5;
            const positions = {
                top: [0, d, 0.01],
                front: [0, 0, d],
                back: [0, 0, -d],
                side: [d, 0, 0],
                perspective: [d*0.7, d*0.5, d*0.7]
            };
            camera.position.set(...(positions[view] || positions.perspective));
            controls.target.set(0, 0, 0);
        }
        
        function addEngine(position, type) {
            const color = type === 'thrust' ? settings.thrustColor : settings.reverseColor;
            const defaultDir = type === 'thrust' ? {x:0,y:0,z:1} : {x:0,y:0,z:-1};
            
            // ë§ˆì»¤ (ëª¨ë¸ì˜ ìì‹ìœ¼ë¡œ ì¶”ê°€)
            const marker = new THREE.Mesh(
                new THREE.SphereGeometry(0.04),
                new THREE.MeshBasicMaterial({ color: type === 'thrust' ? 0x00aaff : 0xffaa00 })
            );
            marker.position.copy(position);
            if (currentModel) currentModel.add(marker);
            else scene.add(marker);
            
            // ë¶ˆê½ƒ (ëª¨ë¸ì˜ ìì‹ìœ¼ë¡œ ì¶”ê°€)
            const flame = createFlame(position, defaultDir, color);
            if (currentModel) currentModel.add(flame);
            else scene.add(flame);
            
            // í™”ì‚´í‘œ (ëª¨ë¸ì˜ ìì‹ìœ¼ë¡œ ì¶”ê°€)
            const arrow = new THREE.ArrowHelper(
                new THREE.Vector3(defaultDir.x, defaultDir.y, defaultDir.z),
                position, 0.4,
                type === 'thrust' ? 0x00ff00 : 0xff8800
            );
            if (currentModel) currentModel.add(arrow);
            else scene.add(arrow);
            
            engines.push({ position: position.clone(), direction: defaultDir, type, marker, flame, arrow });
            
            selectedEngineIndex = engines.length - 1;
            updateEngineList();
            updateDirectionUI();
            updateOutput();
        }
        
        function createFlame(pos, dir, color) {
            const flameGroup = new THREE.Group();
            
            const s = settings.size;
            const l = settings.length;
            
            const outerGeo = new THREE.SphereGeometry(0.1 * s, 16, 12, 0, Math.PI * 2, 0, Math.PI / 2);
            outerGeo.rotateX(-Math.PI / 2);
            const outerMat = new THREE.MeshBasicMaterial({ 
                color: new THREE.Color(color), 
                transparent: true, 
                opacity: 0.4,
                side: THREE.DoubleSide
            });
            const outer = new THREE.Mesh(outerGeo, outerMat);
            outer.scale.set(1, 1, 3 * l);
            flameGroup.add(outer);
            
            const midGeo = new THREE.SphereGeometry(0.07 * s, 16, 12, 0, Math.PI * 2, 0, Math.PI / 2);
            midGeo.rotateX(-Math.PI / 2);
            const midMat = new THREE.MeshBasicMaterial({ 
                color: new THREE.Color(color).lerp(new THREE.Color(0xffffff), 0.3), 
                transparent: true, 
                opacity: 0.6,
                side: THREE.DoubleSide
            });
            const mid = new THREE.Mesh(midGeo, midMat);
            mid.scale.set(1, 1, 2.5 * l);
            flameGroup.add(mid);
            
            const coreGeo = new THREE.SphereGeometry(0.04 * s, 16, 12, 0, Math.PI * 2, 0, Math.PI / 2);
            coreGeo.rotateX(-Math.PI / 2);
            const coreMat = new THREE.MeshBasicMaterial({ 
                color: new THREE.Color(color).lerp(new THREE.Color(0xffffff), 0.6), 
                transparent: true, 
                opacity: 0.8,
                side: THREE.DoubleSide
            });
            const core = new THREE.Mesh(coreGeo, coreMat);
            core.scale.set(1, 1, 2 * l);
            flameGroup.add(core);
            
            flameGroup.position.copy(pos);
            
            // ë°©í–¥ì— ë”°ë¥¸ íšŒì „
            if (dir.z < 0) {
                flameGroup.rotation.y = Math.PI;
            } else if (dir.z > 0) {
                // ê¸°ë³¸ +Z
            } else if (dir.y > 0) {
                flameGroup.rotation.x = -Math.PI / 2;
            } else if (dir.y < 0) {
                flameGroup.rotation.x = Math.PI / 2;
            } else if (dir.x > 0) {
                flameGroup.rotation.y = -Math.PI / 2;
            } else if (dir.x < 0) {
                flameGroup.rotation.y = Math.PI / 2;
            }
            
            return flameGroup;
        }
        
        function updateFlame(i) {
            const e = engines[i];
            
            // ê¸°ì¡´ ì œê±°
            if (e.flame.parent) e.flame.parent.remove(e.flame);
            if (e.arrow.parent) e.arrow.parent.remove(e.arrow);
            
            const color = e.type === 'thrust' ? settings.thrustColor : settings.reverseColor;
            e.flame = createFlame(e.position, e.direction, color);
            
            e.arrow = new THREE.ArrowHelper(
                new THREE.Vector3(e.direction.x, e.direction.y, e.direction.z),
                e.position, 0.4,
                e.type === 'thrust' ? 0x00ff00 : 0xff8800
            );
            
            if (currentModel) {
                currentModel.add(e.flame);
                currentModel.add(e.arrow);
            } else {
                scene.add(e.flame);
                scene.add(e.arrow);
            }
        }
        
        function removeEngine(i) {
            const e = engines[i];
            if (e.marker.parent) e.marker.parent.remove(e.marker);
            if (e.flame.parent) e.flame.parent.remove(e.flame);
            if (e.arrow.parent) e.arrow.parent.remove(e.arrow);
            engines.splice(i, 1);
            selectedEngineIndex = Math.min(selectedEngineIndex, engines.length - 1);
            updateEngineList();
            updateDirectionUI();
            updateOutput();
        }
        
        window.removeEngine = removeEngine;
        window.selectEngine = (i) => {
            selectedEngineIndex = i;
            updateEngineList();
            updateDirectionUI();
        };
        
        function clearEngines() {
            engines.forEach(e => { 
                if (e.marker.parent) e.marker.parent.remove(e.marker);
                if (e.flame.parent) e.flame.parent.remove(e.flame);
                if (e.arrow.parent) e.arrow.parent.remove(e.arrow);
            });
            engines = [];
            selectedEngineIndex = -1;
            updateEngineList();
            updateDirectionUI();
            updateOutput();
        }
        
        function updateEngineList() {
            const list = document.getElementById('engine-list');
            if (!engines.length) {
                list.innerHTML = '<p style="color:#666;font-size:0.75em;">ì—”ì§„ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            list.innerHTML = engines.map((e, i) => `
                <div class="engine-item ${e.type} ${i === selectedEngineIndex ? 'selected' : ''}" 
                     onclick="window.selectEngine(${i})">
                    <div class="header">
                        <span class="type-badge ${e.type}">${e.type === 'thrust' ? 'ì¶”ì§„' : 'ì—­ì¶”ì§„'} ${i + 1}</span>
                        <button class="delete-btn" onclick="event.stopPropagation();window.removeEngine(${i})">âœ•</button>
                    </div>
                    <div class="coords">ğŸ“ (${e.position.x.toFixed(2)}, ${e.position.y.toFixed(2)}, ${e.position.z.toFixed(2)})</div>
                    <div class="direction">â¡ï¸ (${e.direction.x}, ${e.direction.y}, ${e.direction.z})</div>
                </div>
            `).join('');
        }
        
        function updateDirectionUI() {
            const panel = document.getElementById('selected-engine');
            if (selectedEngineIndex < 0) { panel.style.display = 'none'; return; }
            
            panel.style.display = 'block';
            const dir = engines[selectedEngineIndex].direction;
            
            document.querySelectorAll('.dir-btn').forEach(btn => {
                btn.classList.remove('selected');
                const d = btn.dataset.dir;
                if ((d === '+x' && dir.x > 0) || (d === '-x' && dir.x < 0) ||
                    (d === '+y' && dir.y > 0) || (d === '-y' && dir.y < 0) ||
                    (d === '+z' && dir.z > 0) || (d === '-z' && dir.z < 0)) {
                    btn.classList.add('selected');
                }
            });
        }
        
        function updateOutput() {
            const output = document.getElementById('output');
            if (!engines.length && !currentModel) { 
                output.textContent = '// GLB íŒŒì¼ì„ ë¡œë“œí•˜ì„¸ìš”'; 
                return; 
            }
            
            // â˜…â˜…â˜… modelForward í¬í•¨ëœ engineConfig ì¶œë ¥ â˜…â˜…â˜…
            const data = {
                modelForward: modelForward,  // â˜… ì¤‘ìš”!
                thrust: engines.filter(e => e.type === 'thrust').map(e => ({
                    x: +e.position.x.toFixed(3),
                    y: +e.position.y.toFixed(3),
                    z: +e.position.z.toFixed(3),
                    dirX: e.direction.x,
                    dirY: e.direction.y,
                    dirZ: e.direction.z
                })),
                reverse: engines.filter(e => e.type === 'reverse').map(e => ({
                    x: +e.position.x.toFixed(3),
                    y: +e.position.y.toFixed(3),
                    z: +e.position.z.toFixed(3),
                    dirX: e.direction.x,
                    dirY: e.direction.y,
                    dirZ: e.direction.z
                })),
                size: settings.size,
                length: settings.length,
                thrustColor: settings.thrustColor,
                reverseColor: settings.reverseColor
            };
            
            output.textContent = JSON.stringify(data, null, 2);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            
            const t = performance.now() * 0.003;
            engines.forEach((e, i) => {
                const s = 0.8 + Math.sin(t + i) * 0.2;
                e.flame.scale.set(s, s, 1 + Math.sin(t * 2) * 0.1);
                e.flame.children.forEach(child => {
                    if (child.material) {
                        child.material.opacity = 0.3 + Math.sin(t * 2 + i) * 0.2;
                    }
                });
            });
            
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
